{"version":3,"file":"url-template.js","names":["runTemplate","url","widget","params","variables","Object","assign","data","widgetRoomId","currentUserId","userDisplayName","userHttpAvatarUrl","id","clientId","clientTheme","clientLanguage","deviceId","result","_i","_Object$keys","keys","length","key","pattern","concat","replace","rexp","RegExp","encodeURIComponent","toString","a","undefined","String"],"sources":["../../src/templating/url-template.ts"],"sourcesContent":["/*\n * Copyright 2020, 2021 The Matrix.org Foundation C.I.C.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *         http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { IWidget } from \"..\";\n\nexport interface ITemplateParams {\n    widgetRoomId?: string;\n    currentUserId: string;\n    userDisplayName?: string;\n    userHttpAvatarUrl?: string;\n    clientId?: string;\n    clientTheme?: string;\n    clientLanguage?: string;\n    deviceId?: string;\n}\n\nexport function runTemplate(url: string, widget: IWidget, params: ITemplateParams): string {\n    // Always apply the supplied params over top of data to ensure the data can't lie about them.\n    const variables = Object.assign({}, widget.data, {\n        'matrix_room_id': params.widgetRoomId || \"\",\n        'matrix_user_id': params.currentUserId,\n        'matrix_display_name': params.userDisplayName || params.currentUserId,\n        'matrix_avatar_url': params.userHttpAvatarUrl || \"\",\n        'matrix_widget_id': widget.id,\n\n        // TODO: Convert to stable (https://github.com/matrix-org/matrix-doc/pull/2873)\n        'org.matrix.msc2873.client_id': params.clientId || \"\",\n        'org.matrix.msc2873.client_theme': params.clientTheme || \"\",\n        'org.matrix.msc2873.client_language': params.clientLanguage || \"\",\n\n        // TODO: Convert to stable (https://github.com/matrix-org/matrix-spec-proposals/pull/3819)\n        'org.matrix.msc3819.matrix_device_id': params.deviceId || \"\",\n    });\n    let result = url;\n    for (const key of Object.keys(variables)) {\n        // Regex escape from https://stackoverflow.com/a/6969486/7037379\n        const pattern = `$${key}`.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); // $& means the whole matched string\n        const rexp = new RegExp(pattern, 'g');\n\n        // This is technically not what we're supposed to do for a couple of reasons:\n        // 1. We are assuming that there won't later be a $key match after we replace a variable.\n        // 2. We are assuming that the variable is in a place where it can be escaped (eg: path or query string).\n        result = result.replace(rexp, encodeURIComponent(toString(variables[key])));\n    }\n    return result;\n}\n\nexport function toString(a: unknown): string {\n    if (a === null || a === undefined) {\n        return `${a}`;\n    }\n    return String(a);\n}\n"],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAeO,SAASA,WAAWA,CAACC,GAAW,EAAEC,MAAe,EAAEC,MAAuB,EAAU;EACvF;EACA,IAAMC,SAAS,GAAGC,MAAM,CAACC,MAAM,CAAC,CAAC,CAAC,EAAEJ,MAAM,CAACK,IAAI,EAAE;IAC7C,gBAAgB,EAAEJ,MAAM,CAACK,YAAY,IAAI,EAAE;IAC3C,gBAAgB,EAAEL,MAAM,CAACM,aAAa;IACtC,qBAAqB,EAAEN,MAAM,CAACO,eAAe,IAAIP,MAAM,CAACM,aAAa;IACrE,mBAAmB,EAAEN,MAAM,CAACQ,iBAAiB,IAAI,EAAE;IACnD,kBAAkB,EAAET,MAAM,CAACU,EAAE;IAE7B;IACA,8BAA8B,EAAET,MAAM,CAACU,QAAQ,IAAI,EAAE;IACrD,iCAAiC,EAAEV,MAAM,CAACW,WAAW,IAAI,EAAE;IAC3D,oCAAoC,EAAEX,MAAM,CAACY,cAAc,IAAI,EAAE;IAEjE;IACA,qCAAqC,EAAEZ,MAAM,CAACa,QAAQ,IAAI;EAC9D,CAAC,CAAC;EACF,IAAIC,MAAM,GAAGhB,GAAG;EAChB,SAAAiB,EAAA,MAAAC,YAAA,GAAkBd,MAAM,CAACe,IAAI,CAAChB,SAAS,CAAC,EAAAc,EAAA,GAAAC,YAAA,CAAAE,MAAA,EAAAH,EAAA,IAAE;IAArC,IAAMI,GAAG,GAAAH,YAAA,CAAAD,EAAA;IACV;IACA,IAAMK,OAAO,GAAG,IAAAC,MAAA,CAAIF,GAAG,EAAGG,OAAO,CAAC,qBAAqB,EAAE,MAAM,CAAC,CAAC,CAAC;IAClE,IAAMC,IAAI,GAAG,IAAIC,MAAM,CAACJ,OAAO,EAAE,GAAG,CAAC;;IAErC;IACA;IACA;IACAN,MAAM,GAAGA,MAAM,CAACQ,OAAO,CAACC,IAAI,EAAEE,kBAAkB,CAACC,QAAQ,CAACzB,SAAS,CAACkB,GAAG,CAAC,CAAC,CAAC,CAAC;EAC/E;EACA,OAAOL,MAAM;AACjB;AAEO,SAASY,QAAQA,CAACC,CAAU,EAAU;EACzC,IAAIA,CAAC,KAAK,IAAI,IAAIA,CAAC,KAAKC,SAAS,EAAE;IAC/B,UAAAP,MAAA,CAAUM,CAAC;EACf;EACA,OAAOE,MAAM,CAACF,CAAC,CAAC;AACpB"}