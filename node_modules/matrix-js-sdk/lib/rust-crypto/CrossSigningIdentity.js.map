{"version":3,"file":"CrossSigningIdentity.js","names":["_logger","require","CrossSigningIdentity","constructor","olmMachine","outgoingRequestProcessor","bootstrapCrossSigning","opts","setupNewCrossSigning","resetCrossSigning","authUploadDeviceSigningKeys","olmDeviceStatus","crossSigningStatus","privateKeysInSecretStorage","olmDeviceHasKeys","hasMaster","hasUserSigning","hasSelfSigning","logger","log","olmDeviceHasMaster","olmDeviceHasUserSigning","olmDeviceHasSelfSigning","exportCrossSigningKeysToStorage","Error","outgoingRequests","req","makeOutgoingRequest","exports"],"sources":["../../src/rust-crypto/CrossSigningIdentity.ts"],"sourcesContent":["/*\nCopyright 2023 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { OlmMachine, CrossSigningStatus } from \"@matrix-org/matrix-sdk-crypto-js\";\n\nimport { BootstrapCrossSigningOpts } from \"../crypto-api\";\nimport { logger } from \"../logger\";\nimport { OutgoingRequest, OutgoingRequestProcessor } from \"./OutgoingRequestProcessor\";\nimport { UIAuthCallback } from \"../interactive-auth\";\n\n/** Manages the cross-signing keys for our own user.\n */\nexport class CrossSigningIdentity {\n    public constructor(\n        private readonly olmMachine: OlmMachine,\n        private readonly outgoingRequestProcessor: OutgoingRequestProcessor,\n    ) {}\n\n    /**\n     * Initialise our cross-signing keys by creating new keys if they do not exist, and uploading to the server\n     */\n    public async bootstrapCrossSigning(opts: BootstrapCrossSigningOpts): Promise<void> {\n        if (opts.setupNewCrossSigning) {\n            await this.resetCrossSigning(opts.authUploadDeviceSigningKeys);\n            return;\n        }\n\n        const olmDeviceStatus: CrossSigningStatus = await this.olmMachine.crossSigningStatus();\n        const privateKeysInSecretStorage = false; // TODO\n        const olmDeviceHasKeys =\n            olmDeviceStatus.hasMaster && olmDeviceStatus.hasUserSigning && olmDeviceStatus.hasSelfSigning;\n\n        // Log all relevant state for easier parsing of debug logs.\n        logger.log(\"bootStrapCrossSigning: starting\", {\n            setupNewCrossSigning: opts.setupNewCrossSigning,\n            olmDeviceHasMaster: olmDeviceStatus.hasMaster,\n            olmDeviceHasUserSigning: olmDeviceStatus.hasUserSigning,\n            olmDeviceHasSelfSigning: olmDeviceStatus.hasSelfSigning,\n            privateKeysInSecretStorage,\n        });\n\n        if (!olmDeviceHasKeys && !privateKeysInSecretStorage) {\n            logger.log(\n                \"bootStrapCrossSigning: Cross-signing private keys not found locally or in secret storage, creating new keys\",\n            );\n            await this.resetCrossSigning(opts.authUploadDeviceSigningKeys);\n        } else if (olmDeviceHasKeys) {\n            logger.log(\"bootStrapCrossSigning: Olm device has private keys: exporting to secret storage\");\n            await this.exportCrossSigningKeysToStorage();\n        } else if (privateKeysInSecretStorage) {\n            logger.log(\n                \"bootStrapCrossSigning: Cross-signing private keys not found locally, but they are available \" +\n                    \"in secret storage, reading storage and caching locally\",\n            );\n            throw new Error(\"TODO\");\n        }\n\n        // TODO: we might previously have bootstrapped cross-signing but not completed uploading the keys to the\n        //   server -- in which case we should call OlmDevice.bootstrap_cross_signing. How do we know?\n        logger.log(\"bootStrapCrossSigning: complete\");\n    }\n\n    /** Reset our cross-signing keys\n     *\n     * This method will:\n     *   * Tell the OlmMachine to create new keys\n     *   * Upload the new public keys and the device signature to the server\n     *   * Upload the private keys to SSSS, if it is set up\n     */\n    private async resetCrossSigning(authUploadDeviceSigningKeys?: UIAuthCallback<void>): Promise<void> {\n        const outgoingRequests: Array<OutgoingRequest> = await this.olmMachine.bootstrapCrossSigning(true);\n\n        logger.log(\"bootStrapCrossSigning: publishing keys to server\");\n        for (const req of outgoingRequests) {\n            await this.outgoingRequestProcessor.makeOutgoingRequest(req, authUploadDeviceSigningKeys);\n        }\n        await this.exportCrossSigningKeysToStorage();\n    }\n\n    /**\n     * Extract the cross-signing keys from the olm machine and save them to secret storage, if it is configured\n     *\n     * (If secret storage is *not* configured, we assume that the export will happen when it is set up)\n     */\n    private async exportCrossSigningKeysToStorage(): Promise<void> {\n        // TODO\n    }\n}\n"],"mappings":";;;;;;AAmBA,IAAAA,OAAA,GAAAC,OAAA;AAnBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AASA;AACA;AACO,MAAMC,oBAAoB,CAAC;EACvBC,WAAWA,CACGC,UAAsB,EACtBC,wBAAkD,EACrE;IAAA,KAFmBD,UAAsB,GAAtBA,UAAsB;IAAA,KACtBC,wBAAkD,GAAlDA,wBAAkD;EACpE;;EAEH;AACJ;AACA;EACI,MAAaC,qBAAqBA,CAACC,IAA+B,EAAiB;IAC/E,IAAIA,IAAI,CAACC,oBAAoB,EAAE;MAC3B,MAAM,IAAI,CAACC,iBAAiB,CAACF,IAAI,CAACG,2BAA2B,CAAC;MAC9D;IACJ;IAEA,MAAMC,eAAmC,GAAG,MAAM,IAAI,CAACP,UAAU,CAACQ,kBAAkB,CAAC,CAAC;IACtF,MAAMC,0BAA0B,GAAG,KAAK,CAAC,CAAC;IAC1C,MAAMC,gBAAgB,GAClBH,eAAe,CAACI,SAAS,IAAIJ,eAAe,CAACK,cAAc,IAAIL,eAAe,CAACM,cAAc;;IAEjG;IACAC,cAAM,CAACC,GAAG,CAAC,iCAAiC,EAAE;MAC1CX,oBAAoB,EAAED,IAAI,CAACC,oBAAoB;MAC/CY,kBAAkB,EAAET,eAAe,CAACI,SAAS;MAC7CM,uBAAuB,EAAEV,eAAe,CAACK,cAAc;MACvDM,uBAAuB,EAAEX,eAAe,CAACM,cAAc;MACvDJ;IACJ,CAAC,CAAC;IAEF,IAAI,CAACC,gBAAgB,IAAI,CAACD,0BAA0B,EAAE;MAClDK,cAAM,CAACC,GAAG,CACN,6GACJ,CAAC;MACD,MAAM,IAAI,CAACV,iBAAiB,CAACF,IAAI,CAACG,2BAA2B,CAAC;IAClE,CAAC,MAAM,IAAII,gBAAgB,EAAE;MACzBI,cAAM,CAACC,GAAG,CAAC,iFAAiF,CAAC;MAC7F,MAAM,IAAI,CAACI,+BAA+B,CAAC,CAAC;IAChD,CAAC,MAAM,IAAIV,0BAA0B,EAAE;MACnCK,cAAM,CAACC,GAAG,CACN,8FAA8F,GAC1F,wDACR,CAAC;MACD,MAAM,IAAIK,KAAK,CAAC,MAAM,CAAC;IAC3B;;IAEA;IACA;IACAN,cAAM,CAACC,GAAG,CAAC,iCAAiC,CAAC;EACjD;;EAEA;AACJ;AACA;AACA;AACA;AACA;AACA;EACI,MAAcV,iBAAiBA,CAACC,2BAAkD,EAAiB;IAC/F,MAAMe,gBAAwC,GAAG,MAAM,IAAI,CAACrB,UAAU,CAACE,qBAAqB,CAAC,IAAI,CAAC;IAElGY,cAAM,CAACC,GAAG,CAAC,kDAAkD,CAAC;IAC9D,KAAK,MAAMO,GAAG,IAAID,gBAAgB,EAAE;MAChC,MAAM,IAAI,CAACpB,wBAAwB,CAACsB,mBAAmB,CAACD,GAAG,EAAEhB,2BAA2B,CAAC;IAC7F;IACA,MAAM,IAAI,CAACa,+BAA+B,CAAC,CAAC;EAChD;;EAEA;AACJ;AACA;AACA;AACA;EACI,MAAcA,+BAA+BA,CAAA,EAAkB;IAC3D;EAAA;AAER;AAACK,OAAA,CAAA1B,oBAAA,GAAAA,oBAAA"}