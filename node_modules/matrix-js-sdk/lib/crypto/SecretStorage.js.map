{"version":3,"file":"SecretStorage.js","names":["_secretStorage","require","_SecretSharing","SecretStorage","constructor","accountDataAdapter","cryptoCallbacks","baseApis","_defineProperty2","default","storageImpl","ServerSideSecretStorageImpl","sharingImpl","SecretSharing","getDefaultKeyId","setDefaultKeyId","keyId","addKey","algorithm","opts","getKey","hasKey","checkKey","key","info","store","name","secret","keys","get","isStored","request","devices","onRequestReceived","event","onSecretReceived","exports"],"sources":["../../src/crypto/SecretStorage.ts"],"sourcesContent":["/*\nCopyright 2019 - 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { ICryptoCallbacks } from \".\";\nimport { MatrixEvent } from \"../models/event\";\nimport { MatrixClient } from \"../client\";\nimport {\n    SecretStorageKeyDescription,\n    SecretStorageKeyTuple,\n    SecretStorageKeyObject,\n    AddSecretStorageKeyOpts,\n    AccountDataClient,\n    ServerSideSecretStorage,\n    ServerSideSecretStorageImpl,\n} from \"../secret-storage\";\nimport { ISecretRequest, SecretSharing } from \"./SecretSharing\";\n\n/* re-exports for backwards compatibility */\nexport type {\n    AccountDataClient as IAccountDataClient,\n    SecretStorageKeyTuple,\n    SecretStorageKeyObject,\n    SECRET_STORAGE_ALGORITHM_V1_AES,\n} from \"../secret-storage\";\n\nexport type { ISecretRequest } from \"./SecretSharing\";\n\n/**\n * Implements Secure Secret Storage and Sharing (MSC1946)\n *\n * @deprecated This is just a backwards-compatibility hack which will be removed soon.\n *    Use {@link SecretStorage.ServerSideSecretStorageImpl} from `../secret-storage` and/or {@link SecretSharing} from `./SecretSharing`.\n */\nexport class SecretStorage<B extends MatrixClient | undefined = MatrixClient> implements ServerSideSecretStorage {\n    private readonly storageImpl: ServerSideSecretStorageImpl;\n    private readonly sharingImpl: SecretSharing;\n\n    // In its pure javascript days, this was relying on some proper Javascript-style\n    // type-abuse where sometimes we'd pass in a fake client object with just the account\n    // data methods implemented, which is all this class needs unless you use the secret\n    // sharing code, so it was fine. As a low-touch TypeScript migration, we added\n    // an extra, optional param for a real matrix client, so you can not pass it as long\n    // as you don't request any secrets.\n    //\n    // Nowadays, the whole class is scheduled for destruction, once we get rid of the legacy\n    // Crypto impl that exposes it.\n    public constructor(accountDataAdapter: AccountDataClient, cryptoCallbacks: ICryptoCallbacks, baseApis: B) {\n        this.storageImpl = new ServerSideSecretStorageImpl(accountDataAdapter, cryptoCallbacks);\n        this.sharingImpl = new SecretSharing(baseApis as MatrixClient, cryptoCallbacks);\n    }\n\n    public getDefaultKeyId(): Promise<string | null> {\n        return this.storageImpl.getDefaultKeyId();\n    }\n\n    public setDefaultKeyId(keyId: string): Promise<void> {\n        return this.storageImpl.setDefaultKeyId(keyId);\n    }\n\n    /**\n     * Add a key for encrypting secrets.\n     */\n    public addKey(\n        algorithm: string,\n        opts: AddSecretStorageKeyOpts = {},\n        keyId?: string,\n    ): Promise<SecretStorageKeyObject> {\n        return this.storageImpl.addKey(algorithm, opts, keyId);\n    }\n\n    /**\n     * Get the key information for a given ID.\n     */\n    public getKey(keyId?: string | null): Promise<SecretStorageKeyTuple | null> {\n        return this.storageImpl.getKey(keyId);\n    }\n\n    /**\n     * Check whether we have a key with a given ID.\n     */\n    public hasKey(keyId?: string): Promise<boolean> {\n        return this.storageImpl.hasKey(keyId);\n    }\n\n    /**\n     * Check whether a key matches what we expect based on the key info\n     */\n    public checkKey(key: Uint8Array, info: SecretStorageKeyDescription): Promise<boolean> {\n        return this.storageImpl.checkKey(key, info);\n    }\n\n    /**\n     * Store an encrypted secret on the server\n     */\n    public store(name: string, secret: string, keys?: string[] | null): Promise<void> {\n        return this.storageImpl.store(name, secret, keys);\n    }\n\n    /**\n     * Get a secret from storage.\n     */\n    public get(name: string): Promise<string | undefined> {\n        return this.storageImpl.get(name);\n    }\n\n    /**\n     * Check if a secret is stored on the server.\n     */\n    public async isStored(name: string): Promise<Record<string, SecretStorageKeyDescription> | null> {\n        return this.storageImpl.isStored(name);\n    }\n\n    /**\n     * Request a secret from another device\n     */\n    public request(name: string, devices: string[]): ISecretRequest {\n        return this.sharingImpl.request(name, devices);\n    }\n\n    public onRequestReceived(event: MatrixEvent): Promise<void> {\n        return this.sharingImpl.onRequestReceived(event);\n    }\n\n    public onSecretReceived(event: MatrixEvent): void {\n        this.sharingImpl.onSecretReceived(event);\n    }\n}\n"],"mappings":";;;;;;;;AAmBA,IAAAA,cAAA,GAAAC,OAAA;AASA,IAAAC,cAAA,GAAAD,OAAA;AA5BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAgBA;;AAUA;AACA;AACA;AACA;AACA;AACA;AACO,MAAME,aAAa,CAAuF;EAI7G;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACOC,WAAWA,CAACC,kBAAqC,EAAEC,eAAiC,EAAEC,QAAW,EAAE;IAAA,IAAAC,gBAAA,CAAAC,OAAA;IAAA,IAAAD,gBAAA,CAAAC,OAAA;IACtG,IAAI,CAACC,WAAW,GAAG,IAAIC,0CAA2B,CAACN,kBAAkB,EAAEC,eAAe,CAAC;IACvF,IAAI,CAACM,WAAW,GAAG,IAAIC,4BAAa,CAACN,QAAQ,EAAkBD,eAAe,CAAC;EACnF;EAEOQ,eAAeA,CAAA,EAA2B;IAC7C,OAAO,IAAI,CAACJ,WAAW,CAACI,eAAe,CAAC,CAAC;EAC7C;EAEOC,eAAeA,CAACC,KAAa,EAAiB;IACjD,OAAO,IAAI,CAACN,WAAW,CAACK,eAAe,CAACC,KAAK,CAAC;EAClD;;EAEA;AACJ;AACA;EACWC,MAAMA,CACTC,SAAiB,EACjBC,IAA6B,GAAG,CAAC,CAAC,EAClCH,KAAc,EACiB;IAC/B,OAAO,IAAI,CAACN,WAAW,CAACO,MAAM,CAACC,SAAS,EAAEC,IAAI,EAAEH,KAAK,CAAC;EAC1D;;EAEA;AACJ;AACA;EACWI,MAAMA,CAACJ,KAAqB,EAAyC;IACxE,OAAO,IAAI,CAACN,WAAW,CAACU,MAAM,CAACJ,KAAK,CAAC;EACzC;;EAEA;AACJ;AACA;EACWK,MAAMA,CAACL,KAAc,EAAoB;IAC5C,OAAO,IAAI,CAACN,WAAW,CAACW,MAAM,CAACL,KAAK,CAAC;EACzC;;EAEA;AACJ;AACA;EACWM,QAAQA,CAACC,GAAe,EAAEC,IAAiC,EAAoB;IAClF,OAAO,IAAI,CAACd,WAAW,CAACY,QAAQ,CAACC,GAAG,EAAEC,IAAI,CAAC;EAC/C;;EAEA;AACJ;AACA;EACWC,KAAKA,CAACC,IAAY,EAAEC,MAAc,EAAEC,IAAsB,EAAiB;IAC9E,OAAO,IAAI,CAAClB,WAAW,CAACe,KAAK,CAACC,IAAI,EAAEC,MAAM,EAAEC,IAAI,CAAC;EACrD;;EAEA;AACJ;AACA;EACWC,GAAGA,CAACH,IAAY,EAA+B;IAClD,OAAO,IAAI,CAAChB,WAAW,CAACmB,GAAG,CAACH,IAAI,CAAC;EACrC;;EAEA;AACJ;AACA;EACI,MAAaI,QAAQA,CAACJ,IAAY,EAA+D;IAC7F,OAAO,IAAI,CAAChB,WAAW,CAACoB,QAAQ,CAACJ,IAAI,CAAC;EAC1C;;EAEA;AACJ;AACA;EACWK,OAAOA,CAACL,IAAY,EAAEM,OAAiB,EAAkB;IAC5D,OAAO,IAAI,CAACpB,WAAW,CAACmB,OAAO,CAACL,IAAI,EAAEM,OAAO,CAAC;EAClD;EAEOC,iBAAiBA,CAACC,KAAkB,EAAiB;IACxD,OAAO,IAAI,CAACtB,WAAW,CAACqB,iBAAiB,CAACC,KAAK,CAAC;EACpD;EAEOC,gBAAgBA,CAACD,KAAkB,EAAQ;IAC9C,IAAI,CAACtB,WAAW,CAACuB,gBAAgB,CAACD,KAAK,CAAC;EAC5C;AACJ;AAACE,OAAA,CAAAjC,aAAA,GAAAA,aAAA"}