{"version":3,"file":"UserProfilesStore.js","names":["_logger","require","_matrix","_LruCache","cacheSize","UserProfilesStore","constructor","client","_defineProperty2","default","LruCache","event","member","profile","profiles","get","userId","displayname","rawDisplayName","avatar_url","getMxcAvatarUrl","delete","knownProfile","knownProfiles","on","RoomMemberEvent","Membership","onRoomMembershipEvent","getProfile","getOrFetchProfile","options","cachedProfile","fetchProfile","getProfileLookupError","profileLookupErrors","getOnlyKnownProfile","fetchProfileFromApi","set","fetchOnlyKnownProfile","has","isUserIdKnown","undefined","flush","getProfileInfo","e","logger","warn","MatrixError","shouldThrow","getRooms","some","room","getMember","exports"],"sources":["../../src/stores/UserProfilesStore.ts"],"sourcesContent":["/*\r\nCopyright 2023 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\nimport {\r\n    IMatrixProfile,\r\n    MatrixClient,\r\n    MatrixError,\r\n    MatrixEvent,\r\n    RoomMember,\r\n    RoomMemberEvent,\r\n} from \"matrix-js-sdk/src/matrix\";\r\n\r\nimport { LruCache } from \"../utils/LruCache\";\r\n\r\nconst cacheSize = 500;\r\n\r\ntype StoreProfileValue = IMatrixProfile | undefined | null;\r\n\r\ninterface GetOptions {\r\n    /** Whether calling the function shouuld raise an Error. */\r\n    shouldThrow: boolean;\r\n}\r\n\r\n/**\r\n * This store provides cached access to user profiles.\r\n * Listens for membership events and invalidates the cache for a profile on update with different profile values.\r\n */\r\nexport class UserProfilesStore {\r\n    private profiles = new LruCache<string, IMatrixProfile | null>(cacheSize);\r\n    private profileLookupErrors = new LruCache<string, MatrixError>(cacheSize);\r\n    private knownProfiles = new LruCache<string, IMatrixProfile | null>(cacheSize);\r\n\r\n    public constructor(private client: MatrixClient) {\r\n        client.on(RoomMemberEvent.Membership, this.onRoomMembershipEvent);\r\n    }\r\n\r\n    /**\r\n     * Synchronously get a profile from the store cache.\r\n     *\r\n     * @param userId - User Id of the profile to fetch\r\n     * @returns The profile, if cached by the store.\r\n     *          Null if the profile does not exist.\r\n     *          Undefined if the profile is not cached by the store.\r\n     *          In this case a profile can be fetched from the API via {@link fetchProfile}.\r\n     */\r\n    public getProfile(userId: string): StoreProfileValue {\r\n        return this.profiles.get(userId);\r\n    }\r\n\r\n    /**\r\n     * Async shortcut function that returns the profile from cache or\r\n     * or fetches it on cache miss.\r\n     *\r\n     * @param userId - User Id of the profile to get or fetch\r\n     * @returns The profile, if cached by the store or fetched from the API.\r\n     *          Null if the profile does not exist or an error occurred during fetch.\r\n     */\r\n    public async getOrFetchProfile(userId: string, options?: GetOptions): Promise<IMatrixProfile | null> {\r\n        const cachedProfile = this.profiles.get(userId);\r\n\r\n        if (cachedProfile) return cachedProfile;\r\n\r\n        return this.fetchProfile(userId, options);\r\n    }\r\n\r\n    /**\r\n     * Get a profile lookup error.\r\n     *\r\n     * @param userId - User Id for which to get the lookup error\r\n     * @returns The lookup error or undefined if there was no error or the profile was not fetched.\r\n     */\r\n    public getProfileLookupError(userId: string): MatrixError | undefined {\r\n        return this.profileLookupErrors.get(userId);\r\n    }\r\n\r\n    /**\r\n     * Synchronously get a profile from known users from the store cache.\r\n     * Known user means that at least one shared room with the user exists.\r\n     *\r\n     * @param userId - User Id of the profile to fetch\r\n     * @returns The profile, if cached by the store.\r\n     *          Null if the profile does not exist.\r\n     *          Undefined if the profile is not cached by the store.\r\n     *          In this case a profile can be fetched from the API via {@link fetchOnlyKnownProfile}.\r\n     */\r\n    public getOnlyKnownProfile(userId: string): StoreProfileValue {\r\n        return this.knownProfiles.get(userId);\r\n    }\r\n\r\n    /**\r\n     * Asynchronousely fetches a profile from the API.\r\n     * Stores the result in the cache, so that next time {@link getProfile} returns this value.\r\n     *\r\n     * @param userId - User Id for which the profile should be fetched for\r\n     * @returns The profile, if found.\r\n     *          Null if the profile does not exist or there was an error fetching it.\r\n     */\r\n    public async fetchProfile(userId: string, options?: GetOptions): Promise<IMatrixProfile | null> {\r\n        const profile = await this.fetchProfileFromApi(userId, options);\r\n        this.profiles.set(userId, profile);\r\n        return profile;\r\n    }\r\n\r\n    /**\r\n     * Asynchronousely fetches a profile from a known user from the API.\r\n     * Known user means that at least one shared room with the user exists.\r\n     * Stores the result in the cache, so that next time {@link getOnlyKnownProfile} returns this value.\r\n     *\r\n     * @param userId - User Id for which the profile should be fetched for\r\n     * @returns The profile, if found.\r\n     *          Undefined if the user is unknown.\r\n     *          Null if the profile does not exist or there was an error fetching it.\r\n     */\r\n    public async fetchOnlyKnownProfile(userId: string): Promise<StoreProfileValue> {\r\n        // Do not look up unknown users. The test for existence in knownProfiles is a performance optimisation.\r\n        // If the user Id exists in knownProfiles we know them.\r\n        if (!this.knownProfiles.has(userId) && !this.isUserIdKnown(userId)) return undefined;\r\n\r\n        const profile = await this.fetchProfileFromApi(userId);\r\n        this.knownProfiles.set(userId, profile);\r\n        return profile;\r\n    }\r\n\r\n    public flush(): void {\r\n        this.profiles = new LruCache<string, IMatrixProfile | null>(cacheSize);\r\n        this.profileLookupErrors = new LruCache<string, MatrixError>(cacheSize);\r\n        this.knownProfiles = new LruCache<string, IMatrixProfile | null>(cacheSize);\r\n    }\r\n\r\n    /**\r\n     * Looks up a user profile via API.\r\n     *\r\n     * @param userId - User Id for which the profile should be fetched for\r\n     * @returns The profile information or null on errors\r\n     */\r\n    private async fetchProfileFromApi(userId: string, options?: GetOptions): Promise<IMatrixProfile | null> {\r\n        // invalidate cached profile errors\r\n        this.profileLookupErrors.delete(userId);\r\n\r\n        try {\r\n            return (await this.client.getProfileInfo(userId)) ?? null;\r\n        } catch (e) {\r\n            logger.warn(`Error retrieving profile for userId ${userId}`, e);\r\n\r\n            if (e instanceof MatrixError) {\r\n                this.profileLookupErrors.set(userId, e);\r\n            }\r\n\r\n            if (options?.shouldThrow) {\r\n                throw e;\r\n            }\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    /**\r\n     * Whether at least one shared room with the userId exists.\r\n     *\r\n     * @param userId\r\n     * @returns true: at least one room shared with user identified by its Id, else false.\r\n     */\r\n    private isUserIdKnown(userId: string): boolean {\r\n        return this.client.getRooms().some((room) => {\r\n            return !!room.getMember(userId);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Simple cache invalidation if a room membership event is received and\r\n     * at least one profile value differs from the cached one.\r\n     */\r\n    private onRoomMembershipEvent = (event: MatrixEvent, member: RoomMember): void => {\r\n        const profile = this.profiles.get(member.userId);\r\n\r\n        if (\r\n            profile &&\r\n            (profile.displayname !== member.rawDisplayName || profile.avatar_url !== member.getMxcAvatarUrl())\r\n        ) {\r\n            this.profiles.delete(member.userId);\r\n        }\r\n\r\n        const knownProfile = this.knownProfiles.get(member.userId);\r\n\r\n        if (\r\n            knownProfile &&\r\n            (knownProfile.displayname !== member.rawDisplayName || knownProfile.avatar_url !== member.getMxcAvatarUrl())\r\n        ) {\r\n            this.knownProfiles.delete(member.userId);\r\n        }\r\n    };\r\n}\r\n"],"mappings":"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"}