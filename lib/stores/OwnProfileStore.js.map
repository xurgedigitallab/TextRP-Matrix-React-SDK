{"version":3,"file":"OwnProfileStore.js","names":["_user","require","_roomState","_lodash","_event","_AsyncStoreWithClient","_dispatcher","_interopRequireDefault","_MatrixClientPeg","_languageHandler","_Media","KEY_DISPLAY_NAME","KEY_AVATAR_URL","OwnProfileStore","AsyncStoreWithClient","constructor","defaultDispatcher","displayName","window","localStorage","getItem","undefined","avatarUrl","_defineProperty2","default","throttle","matrixClient","profileInfo","getProfileInfo","getSafeUserId","displayname","setItem","removeItem","avatar_url","updateState","fetchedAt","Date","now","trailing","leading","ev","myUserId","MatrixClientPeg","get","getUserId","getType","EventType","RoomMember","getSender","getStateKey","onProfileUpdate","instance","internalInstance","state","isGuest","_t","isProfileInfoFetched","avatarMxc","getHttpAvatarUrl","size","arguments","length","media","mediaFromMxc","srcHttp","getSquareThumbnailHttp","onNotReady","monitoredUser","removeListener","UserEvent","DisplayName","AvatarUrl","RoomStateEvent","Events","onStateEvents","reset","onReady","getUser","on","onAction","payload","exports","start"],"sources":["../../src/stores/OwnProfileStore.ts"],"sourcesContent":["/*\r\nCopyright 2020 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { MatrixEvent } from \"matrix-js-sdk/src/models/event\";\r\nimport { User, UserEvent } from \"matrix-js-sdk/src/models/user\";\r\nimport { RoomStateEvent } from \"matrix-js-sdk/src/models/room-state\";\r\nimport { throttle } from \"lodash\";\r\nimport { EventType } from \"matrix-js-sdk/src/@types/event\";\r\n\r\nimport { ActionPayload } from \"../dispatcher/payloads\";\r\nimport { AsyncStoreWithClient } from \"./AsyncStoreWithClient\";\r\nimport defaultDispatcher from \"../dispatcher/dispatcher\";\r\nimport { MatrixClientPeg } from \"../MatrixClientPeg\";\r\nimport { _t } from \"../languageHandler\";\r\nimport { mediaFromMxc } from \"../customisations/Media\";\r\n\r\ninterface IState {\r\n    displayName?: string;\r\n    avatarUrl?: string;\r\n    fetchedAt?: number;\r\n}\r\n\r\nconst KEY_DISPLAY_NAME = \"mx_profile_displayname\";\r\nconst KEY_AVATAR_URL = \"mx_profile_avatar_url\";\r\n\r\nexport class OwnProfileStore extends AsyncStoreWithClient<IState> {\r\n    private static readonly internalInstance = (() => {\r\n        const instance = new OwnProfileStore();\r\n        instance.start();\r\n        return instance;\r\n    })();\r\n\r\n    private monitoredUser: User | null = null;\r\n\r\n    private constructor() {\r\n        // seed from localstorage because otherwise we won't get these values until a whole network\r\n        // round-trip after the client is ready, and we often load widgets in that time, and we'd\r\n        // and up passing them an incorrect display name\r\n        super(defaultDispatcher, {\r\n            displayName: window.localStorage.getItem(KEY_DISPLAY_NAME) || undefined,\r\n            avatarUrl: window.localStorage.getItem(KEY_AVATAR_URL) || undefined,\r\n        });\r\n    }\r\n\r\n    public static get instance(): OwnProfileStore {\r\n        return OwnProfileStore.internalInstance;\r\n    }\r\n\r\n    /**\r\n     * Gets the display name for the user, or null if not present.\r\n     */\r\n    public get displayName(): string | null {\r\n        if (!this.matrixClient) return this.state.displayName || null;\r\n\r\n        if (this.matrixClient.isGuest()) {\r\n            return _t(\"Guest\");\r\n        } else if (this.state.displayName) {\r\n            return this.state.displayName;\r\n        } else {\r\n            return this.matrixClient.getUserId();\r\n        }\r\n    }\r\n\r\n    public get isProfileInfoFetched(): boolean {\r\n        return !!this.state.fetchedAt;\r\n    }\r\n\r\n    /**\r\n     * Gets the MXC URI of the user's avatar, or null if not present.\r\n     */\r\n    public get avatarMxc(): string | null {\r\n        return this.state.avatarUrl || null;\r\n    }\r\n\r\n    /**\r\n     * Gets the user's avatar as an HTTP URL of the given size. If the user's\r\n     * avatar is not present, this returns null.\r\n     * @param size The size of the avatar. If zero, a full res copy of the avatar\r\n     * will be returned as an HTTP URL.\r\n     * @returns The HTTP URL of the user's avatar\r\n     */\r\n    public getHttpAvatarUrl(size = 0): string | null {\r\n        if (!this.avatarMxc) return null;\r\n        const media = mediaFromMxc(this.avatarMxc);\r\n        if (!size || size <= 0) {\r\n            return media.srcHttp;\r\n        } else {\r\n            return media.getSquareThumbnailHttp(size);\r\n        }\r\n    }\r\n\r\n    protected async onNotReady(): Promise<void> {\r\n        if (this.monitoredUser) {\r\n            this.monitoredUser.removeListener(UserEvent.DisplayName, this.onProfileUpdate);\r\n            this.monitoredUser.removeListener(UserEvent.AvatarUrl, this.onProfileUpdate);\r\n        }\r\n        this.matrixClient?.removeListener(RoomStateEvent.Events, this.onStateEvents);\r\n        await this.reset({});\r\n    }\r\n\r\n    protected async onReady(): Promise<void> {\r\n        if (!this.matrixClient) return;\r\n        const myUserId = this.matrixClient.getSafeUserId();\r\n        this.monitoredUser = this.matrixClient.getUser(myUserId);\r\n        if (this.monitoredUser) {\r\n            this.monitoredUser.on(UserEvent.DisplayName, this.onProfileUpdate);\r\n            this.monitoredUser.on(UserEvent.AvatarUrl, this.onProfileUpdate);\r\n        }\r\n\r\n        // We also have to listen for membership events for ourselves as the above User events\r\n        // are fired only with presence, which matrix.org (and many others) has disabled.\r\n        this.matrixClient.on(RoomStateEvent.Events, this.onStateEvents);\r\n\r\n        await this.onProfileUpdate(); // trigger an initial update\r\n    }\r\n\r\n    protected async onAction(payload: ActionPayload): Promise<void> {\r\n        // we don't actually do anything here\r\n    }\r\n\r\n    private onProfileUpdate = throttle(\r\n        async (): Promise<void> => {\r\n            if (!this.matrixClient) return;\r\n            // We specifically do not use the User object we stored for profile info as it\r\n            // could easily be wrong (such as per-room instead of global profile).\r\n            const profileInfo = await this.matrixClient.getProfileInfo(this.matrixClient.getSafeUserId());\r\n            if (profileInfo.displayname) {\r\n                window.localStorage.setItem(KEY_DISPLAY_NAME, profileInfo.displayname);\r\n            } else {\r\n                window.localStorage.removeItem(KEY_DISPLAY_NAME);\r\n            }\r\n            if (profileInfo.avatar_url) {\r\n                window.localStorage.setItem(KEY_AVATAR_URL, profileInfo.avatar_url);\r\n            } else {\r\n                window.localStorage.removeItem(KEY_AVATAR_URL);\r\n            }\r\n\r\n            await this.updateState({\r\n                displayName: profileInfo.displayname,\r\n                avatarUrl: profileInfo.avatar_url,\r\n                fetchedAt: Date.now(),\r\n            });\r\n        },\r\n        200,\r\n        { trailing: true, leading: true },\r\n    );\r\n\r\n    private onStateEvents = async (ev: MatrixEvent): Promise<void> => {\r\n        const myUserId = MatrixClientPeg.get().getUserId();\r\n        if (ev.getType() === EventType.RoomMember && ev.getSender() === myUserId && ev.getStateKey() === myUserId) {\r\n            await this.onProfileUpdate();\r\n        }\r\n    };\r\n}\r\n"],"mappings":"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"}