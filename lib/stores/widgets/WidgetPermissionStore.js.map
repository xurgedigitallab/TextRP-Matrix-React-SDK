{"version":3,"file":"WidgetPermissionStore.js","names":["_matrixWidgetApi","require","_SettingsStore","_interopRequireDefault","_SettingLevel","OIDCState","exports","WidgetPermissionStore","constructor","context","packSettingKey","widget","kind","roomId","location","WidgetKind","Room","client","getUserId","Modal","Error","encodeURIComponent","templateUrl","getOIDCState","settingsKey","settings","SettingsStore","getValue","deny","includes","Denied","allow","Allowed","Unknown","setOIDCState","newState","currentValues","push","filter","c","setValue","SettingLevel","DEVICE"],"sources":["../../../src/stores/widgets/WidgetPermissionStore.ts"],"sourcesContent":["/*\r\n * Copyright 2020 The Matrix.org Foundation C.I.C.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *         http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport { Widget, WidgetKind } from \"matrix-widget-api\";\r\n\r\nimport SettingsStore from \"../../settings/SettingsStore\";\r\nimport { SettingLevel } from \"../../settings/SettingLevel\";\r\nimport { SdkContextClass } from \"../../contexts/SDKContext\";\r\n\r\nexport enum OIDCState {\r\n    Allowed, // user has set the remembered value as allowed\r\n    Denied, // user has set the remembered value as disallowed\r\n    Unknown, // user has not set a remembered value\r\n}\r\n\r\nexport class WidgetPermissionStore {\r\n    public constructor(private readonly context: SdkContextClass) {}\r\n\r\n    // TODO (all functions here): Merge widgetKind with the widget definition\r\n\r\n    private packSettingKey(widget: Widget, kind: WidgetKind, roomId?: string): string {\r\n        let location: string | null | undefined = roomId;\r\n        if (kind !== WidgetKind.Room) {\r\n            location = this.context.client?.getUserId();\r\n        }\r\n        if (kind === WidgetKind.Modal) {\r\n            location = \"*MODAL*-\" + location; // to guarantee differentiation from whatever spawned it\r\n        }\r\n        if (!location) {\r\n            throw new Error(\"Failed to determine a location to check the widget's OIDC state with\");\r\n        }\r\n\r\n        return encodeURIComponent(`${location}::${widget.templateUrl}`);\r\n    }\r\n\r\n    public getOIDCState(widget: Widget, kind: WidgetKind, roomId?: string): OIDCState {\r\n        const settingsKey = this.packSettingKey(widget, kind, roomId);\r\n        const settings = SettingsStore.getValue(\"widgetOpenIDPermissions\");\r\n        if (settings?.deny?.includes(settingsKey)) {\r\n            return OIDCState.Denied;\r\n        }\r\n        if (settings?.allow?.includes(settingsKey)) {\r\n            return OIDCState.Allowed;\r\n        }\r\n        return OIDCState.Unknown;\r\n    }\r\n\r\n    public setOIDCState(widget: Widget, kind: WidgetKind, roomId: string | undefined, newState: OIDCState): void {\r\n        const settingsKey = this.packSettingKey(widget, kind, roomId);\r\n\r\n        let currentValues = SettingsStore.getValue<{\r\n            allow?: string[];\r\n            deny?: string[];\r\n        }>(\"widgetOpenIDPermissions\");\r\n        if (!currentValues) {\r\n            currentValues = {};\r\n        }\r\n        if (!currentValues.allow) currentValues.allow = [];\r\n        if (!currentValues.deny) currentValues.deny = [];\r\n\r\n        if (newState === OIDCState.Allowed) {\r\n            currentValues.allow.push(settingsKey);\r\n        } else if (newState === OIDCState.Denied) {\r\n            currentValues.deny.push(settingsKey);\r\n        } else {\r\n            currentValues.allow = currentValues.allow.filter((c) => c !== settingsKey);\r\n            currentValues.deny = currentValues.deny.filter((c) => c !== settingsKey);\r\n        }\r\n\r\n        SettingsStore.setValue(\"widgetOpenIDPermissions\", null, SettingLevel.DEVICE, currentValues);\r\n    }\r\n}\r\n"],"mappings":"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"}