{"version":3,"file":"RecentAlgorithm.js","names":["_event","require","_MatrixClientPeg","Unread","_interopRequireWildcard","_membership","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","shouldCauseReorder","event","type","getType","content","getContent","prevContent","getPrevContent","EventType","RoomMember","membership","displayname","avatar_url","sortRooms","rooms","myUserId","MatrixClientPeg","getUserId","tsCache","sort","a","b","roomALastTs","roomId","getLastTs","roomBLastTs","exports","r","userId","mainTimelineLastTs","timeline","Number","MAX_SAFE_INTEGER","effectiveMembership","getEffectiveMembership","getMyMembership","EffectiveMembership","Join","membershipEvent","currentState","getStateEvents","Array","isArray","getTs","i","length","ev","getSender","eventTriggersUnreadCount","client","threadLastEventTimestamps","getThreads","map","thread","replyToEvent","rootEvent","Math","max","RecentAlgorithm","tagId","room"],"sources":["../../../../../src/stores/room-list/algorithms/tag-sorting/RecentAlgorithm.ts"],"sourcesContent":["/*\r\nCopyright 2020 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { Room } from \"matrix-js-sdk/src/models/room\";\r\nimport { EventType } from \"matrix-js-sdk/src/@types/event\";\r\nimport { MatrixEvent } from \"matrix-js-sdk/src/models/event\";\r\n\r\nimport { TagID } from \"../../models\";\r\nimport { IAlgorithm } from \"./IAlgorithm\";\r\nimport { MatrixClientPeg } from \"../../../../MatrixClientPeg\";\r\nimport * as Unread from \"../../../../Unread\";\r\nimport { EffectiveMembership, getEffectiveMembership } from \"../../../../utils/membership\";\r\n\r\nexport function shouldCauseReorder(event: MatrixEvent): boolean {\r\n    const type = event.getType();\r\n    const content = event.getContent();\r\n    const prevContent = event.getPrevContent();\r\n\r\n    // Never ignore membership changes\r\n    if (type === EventType.RoomMember && prevContent.membership !== content.membership) return true;\r\n\r\n    // Ignore display name changes\r\n    if (type === EventType.RoomMember && prevContent.displayname !== content.displayname) return false;\r\n    // Ignore avatar changes\r\n    if (type === EventType.RoomMember && prevContent.avatar_url !== content.avatar_url) return false;\r\n\r\n    return true;\r\n}\r\n\r\nexport const sortRooms = (rooms: Room[]): Room[] => {\r\n    // We cache the timestamp lookup to avoid iterating forever on the timeline\r\n    // of events. This cache only survives a single sort though.\r\n    // We wouldn't need this if `.sort()` didn't constantly try and compare all\r\n    // of the rooms to each other.\r\n\r\n    // TODO: We could probably improve the sorting algorithm here by finding changes.\r\n    // See https://github.com/vector-im/element-web/issues/14459\r\n    // For example, if we spent a little bit of time to determine which elements have\r\n    // actually changed (probably needs to be done higher up?) then we could do an\r\n    // insertion sort or similar on the limited set of changes.\r\n\r\n    // TODO: Don't assume we're using the same client as the peg\r\n    // See https://github.com/vector-im/element-web/issues/14458\r\n    let myUserId = \"\";\r\n    if (MatrixClientPeg.get()) {\r\n        myUserId = MatrixClientPeg.get().getUserId()!;\r\n    }\r\n\r\n    const tsCache: { [roomId: string]: number } = {};\r\n\r\n    return rooms.sort((a, b) => {\r\n        const roomALastTs = tsCache[a.roomId] ?? getLastTs(a, myUserId);\r\n        const roomBLastTs = tsCache[b.roomId] ?? getLastTs(b, myUserId);\r\n\r\n        tsCache[a.roomId] = roomALastTs;\r\n        tsCache[b.roomId] = roomBLastTs;\r\n\r\n        return roomBLastTs - roomALastTs;\r\n    });\r\n};\r\n\r\nconst getLastTs = (r: Room, userId: string): number => {\r\n    const mainTimelineLastTs = ((): number => {\r\n        // Apparently we can have rooms without timelines, at least under testing\r\n        // environments. Just return MAX_INT when this happens.\r\n        if (!r?.timeline) {\r\n            return Number.MAX_SAFE_INTEGER;\r\n        }\r\n\r\n        // If the room hasn't been joined yet, it probably won't have a timeline to\r\n        // parse. We'll still fall back to the timeline if this fails, but chances\r\n        // are we'll at least have our own membership event to go off of.\r\n        const effectiveMembership = getEffectiveMembership(r.getMyMembership());\r\n        if (effectiveMembership !== EffectiveMembership.Join) {\r\n            const membershipEvent = r.currentState.getStateEvents(EventType.RoomMember, userId);\r\n            if (membershipEvent && !Array.isArray(membershipEvent)) {\r\n                return membershipEvent.getTs();\r\n            }\r\n        }\r\n\r\n        for (let i = r.timeline.length - 1; i >= 0; --i) {\r\n            const ev = r.timeline[i];\r\n            if (!ev.getTs()) continue; // skip events that don't have timestamps (tests only?)\r\n\r\n            if (\r\n                (ev.getSender() === userId && shouldCauseReorder(ev)) ||\r\n                Unread.eventTriggersUnreadCount(r.client, ev)\r\n            ) {\r\n                return ev.getTs();\r\n            }\r\n        }\r\n\r\n        // we might only have events that don't trigger the unread indicator,\r\n        // in which case use the oldest event even if normally it wouldn't count.\r\n        // This is better than just assuming the last event was forever ago.\r\n        return r.timeline[0]?.getTs() ?? Number.MAX_SAFE_INTEGER;\r\n    })();\r\n\r\n    const threadLastEventTimestamps = r.getThreads().map((thread) => {\r\n        const event = thread.replyToEvent ?? thread.rootEvent;\r\n        return event?.getTs() ?? 0;\r\n    });\r\n\r\n    return Math.max(mainTimelineLastTs, ...threadLastEventTimestamps);\r\n};\r\n\r\n/**\r\n * Sorts rooms according to the last event's timestamp in each room that seems\r\n * useful to the user.\r\n */\r\nexport class RecentAlgorithm implements IAlgorithm {\r\n    public sortRooms(rooms: Room[], tagId: TagID): Room[] {\r\n        return sortRooms(rooms);\r\n    }\r\n\r\n    public getLastTs(room: Room, userId: string): number {\r\n        return getLastTs(room, userId);\r\n    }\r\n}\r\n"],"mappings":";;;;;;;;AAiBA,IAAAA,MAAA,GAAAC,OAAA;AAKA,IAAAC,gBAAA,GAAAD,OAAA;AACA,IAAAE,MAAA,GAAAC,uBAAA,CAAAH,OAAA;AACA,IAAAI,WAAA,GAAAJ,OAAA;AAA2F,SAAAK,yBAAAC,WAAA,eAAAC,OAAA,kCAAAC,iBAAA,OAAAD,OAAA,QAAAE,gBAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,WAAA,WAAAA,WAAA,GAAAG,gBAAA,GAAAD,iBAAA,KAAAF,WAAA;AAAA,SAAAH,wBAAAO,GAAA,EAAAJ,WAAA,SAAAA,WAAA,IAAAI,GAAA,IAAAA,GAAA,CAAAC,UAAA,WAAAD,GAAA,QAAAA,GAAA,oBAAAA,GAAA,wBAAAA,GAAA,4BAAAE,OAAA,EAAAF,GAAA,UAAAG,KAAA,GAAAR,wBAAA,CAAAC,WAAA,OAAAO,KAAA,IAAAA,KAAA,CAAAC,GAAA,CAAAJ,GAAA,YAAAG,KAAA,CAAAE,GAAA,CAAAL,GAAA,SAAAM,MAAA,WAAAC,qBAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,GAAA,IAAAX,GAAA,QAAAW,GAAA,kBAAAH,MAAA,CAAAI,SAAA,CAAAC,cAAA,CAAAC,IAAA,CAAAd,GAAA,EAAAW,GAAA,SAAAI,IAAA,GAAAR,qBAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAV,GAAA,EAAAW,GAAA,cAAAI,IAAA,KAAAA,IAAA,CAAAV,GAAA,IAAAU,IAAA,CAAAC,GAAA,KAAAR,MAAA,CAAAC,cAAA,CAAAH,MAAA,EAAAK,GAAA,EAAAI,IAAA,YAAAT,MAAA,CAAAK,GAAA,IAAAX,GAAA,CAAAW,GAAA,SAAAL,MAAA,CAAAJ,OAAA,GAAAF,GAAA,MAAAG,KAAA,IAAAA,KAAA,CAAAa,GAAA,CAAAhB,GAAA,EAAAM,MAAA,YAAAA,MAAA;AAxB3F;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAYO,SAASW,kBAAkBA,CAACC,KAAkB,EAAW;EAC5D,MAAMC,IAAI,GAAGD,KAAK,CAACE,OAAO,CAAC,CAAC;EAC5B,MAAMC,OAAO,GAAGH,KAAK,CAACI,UAAU,CAAC,CAAC;EAClC,MAAMC,WAAW,GAAGL,KAAK,CAACM,cAAc,CAAC,CAAC;;EAE1C;EACA,IAAIL,IAAI,KAAKM,gBAAS,CAACC,UAAU,IAAIH,WAAW,CAACI,UAAU,KAAKN,OAAO,CAACM,UAAU,EAAE,OAAO,IAAI;;EAE/F;EACA,IAAIR,IAAI,KAAKM,gBAAS,CAACC,UAAU,IAAIH,WAAW,CAACK,WAAW,KAAKP,OAAO,CAACO,WAAW,EAAE,OAAO,KAAK;EAClG;EACA,IAAIT,IAAI,KAAKM,gBAAS,CAACC,UAAU,IAAIH,WAAW,CAACM,UAAU,KAAKR,OAAO,CAACQ,UAAU,EAAE,OAAO,KAAK;EAEhG,OAAO,IAAI;AACf;AAEO,MAAMC,SAAS,GAAIC,KAAa,IAAa;EAChD;EACA;EACA;EACA;;EAEA;EACA;EACA;EACA;EACA;;EAEA;EACA;EACA,IAAIC,QAAQ,GAAG,EAAE;EACjB,IAAIC,gCAAe,CAAC5B,GAAG,CAAC,CAAC,EAAE;IACvB2B,QAAQ,GAAGC,gCAAe,CAAC5B,GAAG,CAAC,CAAC,CAAC6B,SAAS,CAAC,CAAE;EACjD;EAEA,MAAMC,OAAqC,GAAG,CAAC,CAAC;EAEhD,OAAOJ,KAAK,CAACK,IAAI,CAAC,CAACC,CAAC,EAAEC,CAAC,KAAK;IACxB,MAAMC,WAAW,GAAGJ,OAAO,CAACE,CAAC,CAACG,MAAM,CAAC,IAAIC,SAAS,CAACJ,CAAC,EAAEL,QAAQ,CAAC;IAC/D,MAAMU,WAAW,GAAGP,OAAO,CAACG,CAAC,CAACE,MAAM,CAAC,IAAIC,SAAS,CAACH,CAAC,EAAEN,QAAQ,CAAC;IAE/DG,OAAO,CAACE,CAAC,CAACG,MAAM,CAAC,GAAGD,WAAW;IAC/BJ,OAAO,CAACG,CAAC,CAACE,MAAM,CAAC,GAAGE,WAAW;IAE/B,OAAOA,WAAW,GAAGH,WAAW;EACpC,CAAC,CAAC;AACN,CAAC;AAACI,OAAA,CAAAb,SAAA,GAAAA,SAAA;AAEF,MAAMW,SAAS,GAAGA,CAACG,CAAO,EAAEC,MAAc,KAAa;EACnD,MAAMC,kBAAkB,GAAG,CAAC,MAAc;IACtC;IACA;IACA,IAAI,CAACF,CAAC,EAAEG,QAAQ,EAAE;MACd,OAAOC,MAAM,CAACC,gBAAgB;IAClC;;IAEA;IACA;IACA;IACA,MAAMC,mBAAmB,GAAG,IAAAC,kCAAsB,EAACP,CAAC,CAACQ,eAAe,CAAC,CAAC,CAAC;IACvE,IAAIF,mBAAmB,KAAKG,+BAAmB,CAACC,IAAI,EAAE;MAClD,MAAMC,eAAe,GAAGX,CAAC,CAACY,YAAY,CAACC,cAAc,CAAChC,gBAAS,CAACC,UAAU,EAAEmB,MAAM,CAAC;MACnF,IAAIU,eAAe,IAAI,CAACG,KAAK,CAACC,OAAO,CAACJ,eAAe,CAAC,EAAE;QACpD,OAAOA,eAAe,CAACK,KAAK,CAAC,CAAC;MAClC;IACJ;IAEA,KAAK,IAAIC,CAAC,GAAGjB,CAAC,CAACG,QAAQ,CAACe,MAAM,GAAG,CAAC,EAAED,CAAC,IAAI,CAAC,EAAE,EAAEA,CAAC,EAAE;MAC7C,MAAME,EAAE,GAAGnB,CAAC,CAACG,QAAQ,CAACc,CAAC,CAAC;MACxB,IAAI,CAACE,EAAE,CAACH,KAAK,CAAC,CAAC,EAAE,SAAS,CAAC;;MAE3B,IACKG,EAAE,CAACC,SAAS,CAAC,CAAC,KAAKnB,MAAM,IAAI5B,kBAAkB,CAAC8C,EAAE,CAAC,IACpDvE,MAAM,CAACyE,wBAAwB,CAACrB,CAAC,CAACsB,MAAM,EAAEH,EAAE,CAAC,EAC/C;QACE,OAAOA,EAAE,CAACH,KAAK,CAAC,CAAC;MACrB;IACJ;;IAEA;IACA;IACA;IACA,OAAOhB,CAAC,CAACG,QAAQ,CAAC,CAAC,CAAC,EAAEa,KAAK,CAAC,CAAC,IAAIZ,MAAM,CAACC,gBAAgB;EAC5D,CAAC,EAAE,CAAC;EAEJ,MAAMkB,yBAAyB,GAAGvB,CAAC,CAACwB,UAAU,CAAC,CAAC,CAACC,GAAG,CAAEC,MAAM,IAAK;IAC7D,MAAMpD,KAAK,GAAGoD,MAAM,CAACC,YAAY,IAAID,MAAM,CAACE,SAAS;IACrD,OAAOtD,KAAK,EAAE0C,KAAK,CAAC,CAAC,IAAI,CAAC;EAC9B,CAAC,CAAC;EAEF,OAAOa,IAAI,CAACC,GAAG,CAAC5B,kBAAkB,EAAE,GAAGqB,yBAAyB,CAAC;AACrE,CAAC;;AAED;AACA;AACA;AACA;AACO,MAAMQ,eAAe,CAAuB;EACxC7C,SAASA,CAACC,KAAa,EAAE6C,KAAY,EAAU;IAClD,OAAO9C,SAAS,CAACC,KAAK,CAAC;EAC3B;EAEOU,SAASA,CAACoC,IAAU,EAAEhC,MAAc,EAAU;IACjD,OAAOJ,SAAS,CAACoC,IAAI,EAAEhC,MAAM,CAAC;EAClC;AACJ;AAACF,OAAA,CAAAgC,eAAA,GAAAA,eAAA"}