{"version":3,"file":"MessagePreviewStore.js","names":["_utils","require","_polls","_matrix","_AsyncStoreWithClient","_dispatcher","_interopRequireDefault","_MessageEventPreview","_PollStartEventPreview","_LegacyCallInviteEventPreview","_LegacyCallAnswerEventPreview","_LegacyCallHangupEvent","_StickerEventPreview","_ReactionEventPreview","_AsyncStore","_voiceBroadcast","_VoiceBroadcastPreview","ROOM_PREVIEW_CHANGED","PREVIEWS","isState","previewer","MessageEventPreview","LegacyCallInviteEventPreview","LegacyCallAnswerEventPreview","LegacyCallHangupEvent","StickerEventPreview","ReactionEventPreview","M_POLL_START","name","PollStartEventPreview","altName","VoiceBroadcastInfoEventType","VoiceBroadcastPreview","MAX_EVENTS_BACKWARDS","TAG_ANY","isThreadReply","event","isThreadRoot","thread","getThread","relation","getRelation","rel_type","RelationType","Annotation","event_id","rootEvent","getId","mkMessagePreview","text","MessagePreviewStore","AsyncStoreWithClient","testInstance","constructor","defaultDispatcher","_defineProperty2","default","Map","instance","internalInstance","getPreviewChangedEventName","room","roomId","getPreviewForRoom","inTagId","previews","has","generatePreview","get","generatePreviewForEvent","previewDef","getType","getTextFor","undefined","shouldSkipPreview","previousEvent","isRelation","Replace","matrixClient","getRoom","getRoomId","relatedEvent","findEventById","relationEventId","tagId","events","getLiveTimeline","getEvents","getThreads","forEach","lastReply","push","sort","a","b","getTs","map","set","previousEventInAny","changed","i","length","decryptEventIfNeeded","isNullOrUndefined","getStateKey","anyPreviewText","tagsToGenerate","Array","from","keys","filter","t","genTagId","previousEventInTag","realTagId","preview","delete","emit","UPDATE_EVENT","onAction","payload","action","isHistoricalEvent","hasOwnProperty","isLiveEvent","exports","start"],"sources":["../../../src/stores/room-list/MessagePreviewStore.ts"],"sourcesContent":["/*\r\nCopyright 2020 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { Room } from \"matrix-js-sdk/src/models/room\";\r\nimport { isNullOrUndefined } from \"matrix-js-sdk/src/utils\";\r\nimport { MatrixEvent } from \"matrix-js-sdk/src/models/event\";\r\nimport { M_POLL_START } from \"matrix-js-sdk/src/@types/polls\";\r\nimport { Thread } from \"matrix-js-sdk/src/models/thread\";\r\nimport { RelationType } from \"matrix-js-sdk/src/matrix\";\r\n\r\nimport { ActionPayload } from \"../../dispatcher/payloads\";\r\nimport { AsyncStoreWithClient } from \"../AsyncStoreWithClient\";\r\nimport defaultDispatcher from \"../../dispatcher/dispatcher\";\r\nimport { MessageEventPreview } from \"./previews/MessageEventPreview\";\r\nimport { PollStartEventPreview } from \"./previews/PollStartEventPreview\";\r\nimport { TagID } from \"./models\";\r\nimport { LegacyCallInviteEventPreview } from \"./previews/LegacyCallInviteEventPreview\";\r\nimport { LegacyCallAnswerEventPreview } from \"./previews/LegacyCallAnswerEventPreview\";\r\nimport { LegacyCallHangupEvent } from \"./previews/LegacyCallHangupEvent\";\r\nimport { StickerEventPreview } from \"./previews/StickerEventPreview\";\r\nimport { ReactionEventPreview } from \"./previews/ReactionEventPreview\";\r\nimport { UPDATE_EVENT } from \"../AsyncStore\";\r\nimport { IPreview } from \"./previews/IPreview\";\r\nimport { VoiceBroadcastInfoEventType } from \"../../voice-broadcast\";\r\nimport { VoiceBroadcastPreview } from \"./previews/VoiceBroadcastPreview\";\r\n\r\n// Emitted event for when a room's preview has changed. First argument will the room for which\r\n// the change happened.\r\nconst ROOM_PREVIEW_CHANGED = \"room_preview_changed\";\r\n\r\nconst PREVIEWS: Record<\r\n    string,\r\n    {\r\n        isState: boolean;\r\n        previewer: IPreview;\r\n    }\r\n> = {\r\n    \"m.room.message\": {\r\n        isState: false,\r\n        previewer: new MessageEventPreview(),\r\n    },\r\n    \"m.call.invite\": {\r\n        isState: false,\r\n        previewer: new LegacyCallInviteEventPreview(),\r\n    },\r\n    \"m.call.answer\": {\r\n        isState: false,\r\n        previewer: new LegacyCallAnswerEventPreview(),\r\n    },\r\n    \"m.call.hangup\": {\r\n        isState: false,\r\n        previewer: new LegacyCallHangupEvent(),\r\n    },\r\n    \"m.sticker\": {\r\n        isState: false,\r\n        previewer: new StickerEventPreview(),\r\n    },\r\n    \"m.reaction\": {\r\n        isState: false,\r\n        previewer: new ReactionEventPreview(),\r\n    },\r\n    [M_POLL_START.name]: {\r\n        isState: false,\r\n        previewer: new PollStartEventPreview(),\r\n    },\r\n    [M_POLL_START.altName]: {\r\n        isState: false,\r\n        previewer: new PollStartEventPreview(),\r\n    },\r\n    [VoiceBroadcastInfoEventType]: {\r\n        isState: true,\r\n        previewer: new VoiceBroadcastPreview(),\r\n    },\r\n};\r\n\r\n// The maximum number of events we're willing to look back on to get a preview.\r\nconst MAX_EVENTS_BACKWARDS = 50;\r\n\r\n// type merging ftw\r\ntype TAG_ANY = \"im.vector.any\"; // eslint-disable-line @typescript-eslint/naming-convention\r\nconst TAG_ANY: TAG_ANY = \"im.vector.any\";\r\n\r\ninterface IState {\r\n    // Empty because we don't actually use the state\r\n}\r\n\r\nexport interface MessagePreview {\r\n    event: MatrixEvent;\r\n    isThreadReply: boolean;\r\n    text: string;\r\n}\r\n\r\nconst isThreadReply = (event: MatrixEvent): boolean => {\r\n    // a thread root event cannot be a thread reply\r\n    if (event.isThreadRoot) return false;\r\n\r\n    const thread = event.getThread();\r\n\r\n    // it cannot be a thread reply if there is no thread\r\n    if (!thread) return false;\r\n\r\n    const relation = event.getRelation();\r\n\r\n    if (\r\n        !!relation &&\r\n        relation.rel_type === RelationType.Annotation &&\r\n        relation.event_id === thread.rootEvent?.getId()\r\n    ) {\r\n        // annotations on the thread root are not a thread reply\r\n        return false;\r\n    }\r\n\r\n    return true;\r\n};\r\n\r\nconst mkMessagePreview = (text: string, event: MatrixEvent): MessagePreview => {\r\n    return {\r\n        event,\r\n        text,\r\n        isThreadReply: isThreadReply(event),\r\n    };\r\n};\r\n\r\nexport class MessagePreviewStore extends AsyncStoreWithClient<IState> {\r\n    private static readonly internalInstance = (() => {\r\n        const instance = new MessagePreviewStore();\r\n        instance.start();\r\n        return instance;\r\n    })();\r\n\r\n    /**\r\n     * @internal Public for test only\r\n     */\r\n    public static testInstance(): MessagePreviewStore {\r\n        return new MessagePreviewStore();\r\n    }\r\n\r\n    // null indicates the preview is empty / irrelevant\r\n    private previews = new Map<string, Map<TagID | TAG_ANY, MessagePreview | null>>();\r\n\r\n    private constructor() {\r\n        super(defaultDispatcher, {});\r\n    }\r\n\r\n    public static get instance(): MessagePreviewStore {\r\n        return MessagePreviewStore.internalInstance;\r\n    }\r\n\r\n    public static getPreviewChangedEventName(room: Room): string {\r\n        return `${ROOM_PREVIEW_CHANGED}:${room?.roomId}`;\r\n    }\r\n\r\n    /**\r\n     * Gets the pre-translated preview for a given room\r\n     * @param room The room to get the preview for.\r\n     * @param inTagId The tag ID in which the room resides\r\n     * @returns The preview, or null if none present.\r\n     */\r\n    public async getPreviewForRoom(room: Room, inTagId: TagID): Promise<MessagePreview | null> {\r\n        if (!room) return null; // invalid room, just return nothing\r\n\r\n        if (!this.previews.has(room.roomId)) await this.generatePreview(room, inTagId);\r\n\r\n        const previews = this.previews.get(room.roomId);\r\n        if (!previews) return null;\r\n\r\n        if (previews.has(inTagId)) {\r\n            return previews.get(inTagId)!;\r\n        }\r\n        return previews.get(TAG_ANY) ?? null;\r\n    }\r\n\r\n    public generatePreviewForEvent(event: MatrixEvent): string {\r\n        const previewDef = PREVIEWS[event.getType()];\r\n        return previewDef?.previewer.getTextFor(event, undefined, true) ?? \"\";\r\n    }\r\n\r\n    private shouldSkipPreview(event: MatrixEvent, previousEvent?: MatrixEvent): boolean {\r\n        if (event.isRelation(RelationType.Replace)) {\r\n            if (previousEvent !== undefined) {\r\n                // Ignore edits if they don't apply to the latest event in the room to keep the preview on the latest event\r\n                const room = this.matrixClient?.getRoom(event.getRoomId()!);\r\n                const relatedEvent = room?.findEventById(event.relationEventId!);\r\n                if (relatedEvent !== previousEvent) {\r\n                    return true;\r\n                }\r\n            }\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    private async generatePreview(room: Room, tagId?: TagID): Promise<void> {\r\n        const events = [...room.getLiveTimeline().getEvents()];\r\n\r\n        // add last reply from each thread\r\n        room.getThreads().forEach((thread: Thread): void => {\r\n            const lastReply = thread.lastReply();\r\n            if (lastReply) events.push(lastReply);\r\n        });\r\n\r\n        // sort events from oldest to newest\r\n        events.sort((a: MatrixEvent, b: MatrixEvent) => {\r\n            return a.getTs() - b.getTs();\r\n        });\r\n\r\n        if (!events) return; // should only happen in tests\r\n\r\n        let map = this.previews.get(room.roomId);\r\n        if (!map) {\r\n            map = new Map<TagID | TAG_ANY, MessagePreview | null>();\r\n            this.previews.set(room.roomId, map);\r\n        }\r\n\r\n        const previousEventInAny = map.get(TAG_ANY)?.event;\r\n\r\n        // Set the tags so we know what to generate\r\n        if (!map.has(TAG_ANY)) map.set(TAG_ANY, null);\r\n        if (tagId && !map.has(tagId)) map.set(tagId, null);\r\n\r\n        let changed = false;\r\n        for (let i = events.length - 1; i >= 0; i--) {\r\n            if (i === events.length - MAX_EVENTS_BACKWARDS) {\r\n                // limit reached - clear the preview by breaking out of the loop\r\n                break;\r\n            }\r\n\r\n            const event = events[i];\r\n\r\n            await this.matrixClient?.decryptEventIfNeeded(event);\r\n\r\n            const previewDef = PREVIEWS[event.getType()];\r\n            if (!previewDef) continue;\r\n            if (previewDef.isState && isNullOrUndefined(event.getStateKey())) continue;\r\n\r\n            const anyPreviewText = previewDef.previewer.getTextFor(event);\r\n            if (!anyPreviewText) continue; // not previewable for some reason\r\n\r\n            if (!this.shouldSkipPreview(event, previousEventInAny)) {\r\n                changed = changed || anyPreviewText !== map.get(TAG_ANY)?.text;\r\n                map.set(TAG_ANY, mkMessagePreview(anyPreviewText, event));\r\n            }\r\n\r\n            const tagsToGenerate = Array.from(map.keys()).filter((t) => t !== TAG_ANY); // we did the any tag above\r\n            for (const genTagId of tagsToGenerate) {\r\n                const previousEventInTag = map.get(genTagId)?.event;\r\n                if (this.shouldSkipPreview(event, previousEventInTag)) continue;\r\n\r\n                const realTagId = genTagId === TAG_ANY ? undefined : genTagId;\r\n                const preview = previewDef.previewer.getTextFor(event, realTagId);\r\n\r\n                if (preview === anyPreviewText) {\r\n                    changed = changed || anyPreviewText !== map.get(genTagId)?.text;\r\n                    map.delete(genTagId);\r\n                } else {\r\n                    changed = changed || preview !== map.get(genTagId)?.text;\r\n                    map.set(genTagId, preview ? mkMessagePreview(anyPreviewText, event) : null);\r\n                }\r\n            }\r\n\r\n            if (changed) {\r\n                // We've muted the underlying Map, so just emit that we've changed.\r\n                this.previews.set(room.roomId, map);\r\n                this.emit(UPDATE_EVENT, this);\r\n                this.emit(MessagePreviewStore.getPreviewChangedEventName(room), room);\r\n            }\r\n            return; // we're done\r\n        }\r\n\r\n        // At this point, we didn't generate a preview so clear it\r\n        this.previews.set(room.roomId, new Map<TagID | TAG_ANY, MessagePreview | null>());\r\n        this.emit(UPDATE_EVENT, this);\r\n        this.emit(MessagePreviewStore.getPreviewChangedEventName(room), room);\r\n    }\r\n\r\n    protected async onAction(payload: ActionPayload): Promise<void> {\r\n        if (!this.matrixClient) return;\r\n\r\n        if (payload.action === \"MatrixActions.Room.timeline\" || payload.action === \"MatrixActions.Event.decrypted\") {\r\n            const event = payload.event; // TODO: Type out the dispatcher\r\n            const roomId = event.getRoomId();\r\n            const isHistoricalEvent = payload.hasOwnProperty(\"isLiveEvent\") && !payload.isLiveEvent;\r\n\r\n            if (!roomId || !this.previews.has(roomId) || isHistoricalEvent) return;\r\n\r\n            const room = this.matrixClient.getRoom(roomId);\r\n\r\n            if (!room) return;\r\n\r\n            await this.generatePreview(room, TAG_ANY);\r\n        }\r\n    }\r\n}\r\n"],"mappings":"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"}