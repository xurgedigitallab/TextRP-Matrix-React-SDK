{"version":3,"file":"RoomNotificationStateStore.js","names":["_sync","require","_client","_AsyncStoreWithClient","_dispatcher","_interopRequireDefault","_models","_ListNotificationState","_RoomNotificationState","_SummarizedNotificationState","_VisibilityProvider","_PosthogAnalytics","_SettingsStore","UPDATE_STATUS_INDICATOR","Symbol","exports","RoomNotificationStateStore","AsyncStoreWithClient","constructor","dispatcher","arguments","length","undefined","defaultDispatcher","_defineProperty2","default","Map","SummarizedNotificationState","state","prevState","emitUpdateIfStateChanged","forceEmit","matrixClient","msc3946ProcessDynamicPredecessor","SettingsStore","getValue","globalState","visibleRooms","getVisibleRooms","numFavourites","room","VisibilityProvider","instance","isRoomVisible","add","getRoomState","tags","DefaultTagID","Favourite","getType","PosthogAnalytics","setProperty","symbol","count","color","numUnreadStates","_globalState","emit","watchSetting","SyncState","Syncing","testInstance","getListState","tagId","listMap","has","get","useTileCount","Invite","getRoomFn","ListNotificationState","set","roomMap","RoomNotificationState","internalInstance","onReady","on","ClientEvent","Sync","onSync","onNotReady","off","roomState","values","destroy","onAction","payload","start"],"sources":["../../../src/stores/notifications/RoomNotificationStateStore.ts"],"sourcesContent":["/*\r\nCopyright 2020 - 2022 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { Room } from \"matrix-js-sdk/src/models/room\";\r\nimport { SyncState } from \"matrix-js-sdk/src/sync\";\r\nimport { ClientEvent } from \"matrix-js-sdk/src/client\";\r\n\r\nimport { ActionPayload } from \"../../dispatcher/payloads\";\r\nimport { AsyncStoreWithClient } from \"../AsyncStoreWithClient\";\r\nimport defaultDispatcher, { MatrixDispatcher } from \"../../dispatcher/dispatcher\";\r\nimport { DefaultTagID, TagID } from \"../room-list/models\";\r\nimport { FetchRoomFn, ListNotificationState } from \"./ListNotificationState\";\r\nimport { RoomNotificationState } from \"./RoomNotificationState\";\r\nimport { SummarizedNotificationState } from \"./SummarizedNotificationState\";\r\nimport { VisibilityProvider } from \"../room-list/filters/VisibilityProvider\";\r\nimport { PosthogAnalytics } from \"../../PosthogAnalytics\";\r\nimport SettingsStore from \"../../settings/SettingsStore\";\r\n\r\ninterface IState {}\r\n\r\nexport const UPDATE_STATUS_INDICATOR = Symbol(\"update-status-indicator\");\r\n\r\nexport class RoomNotificationStateStore extends AsyncStoreWithClient<IState> {\r\n    private static readonly internalInstance = (() => {\r\n        const instance = new RoomNotificationStateStore();\r\n        instance.start();\r\n        return instance;\r\n    })();\r\n    private roomMap = new Map<Room, RoomNotificationState>();\r\n\r\n    private listMap = new Map<TagID, ListNotificationState>();\r\n    private _globalState = new SummarizedNotificationState();\r\n\r\n    private constructor(dispatcher = defaultDispatcher) {\r\n        super(dispatcher, {});\r\n        SettingsStore.watchSetting(\"feature_dynamic_room_predecessors\", null, () => {\r\n            // We pass SyncState.Syncing here to \"simulate\" a sync happening.\r\n            // The code that receives these events actually doesn't care\r\n            // what state we pass, except that it behaves differently if we\r\n            // pass SyncState.Error.\r\n            this.emitUpdateIfStateChanged(SyncState.Syncing, false);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * @internal Public for test only\r\n     */\r\n    public static testInstance(dispatcher: MatrixDispatcher): RoomNotificationStateStore {\r\n        return new RoomNotificationStateStore();\r\n    }\r\n\r\n    /**\r\n     * Gets a snapshot of notification state for all visible rooms. The number of states recorded\r\n     * on the SummarizedNotificationState is equivalent to rooms.\r\n     */\r\n    public get globalState(): SummarizedNotificationState {\r\n        return this._globalState;\r\n    }\r\n\r\n    /**\r\n     * Gets an instance of the list state class for the given tag.\r\n     * @param tagId The tag to get the notification state for.\r\n     * @returns The notification state for the tag.\r\n     */\r\n    public getListState(tagId: TagID): ListNotificationState {\r\n        if (this.listMap.has(tagId)) {\r\n            return this.listMap.get(tagId)!;\r\n        }\r\n\r\n        // TODO: Update if/when invites move out of the room list.\r\n        const useTileCount = tagId === DefaultTagID.Invite;\r\n        const getRoomFn: FetchRoomFn = (room: Room) => {\r\n            return this.getRoomState(room);\r\n        };\r\n        const state = new ListNotificationState(useTileCount, getRoomFn);\r\n        this.listMap.set(tagId, state);\r\n        return state;\r\n    }\r\n\r\n    /**\r\n     * Gets a copy of the notification state for a room. The consumer should not\r\n     * attempt to destroy the returned state as it may be shared with other\r\n     * consumers.\r\n     * @param room The room to get the notification state for.\r\n     * @returns The room's notification state.\r\n     */\r\n    public getRoomState(room: Room): RoomNotificationState {\r\n        if (!this.roomMap.has(room)) {\r\n            this.roomMap.set(room, new RoomNotificationState(room));\r\n        }\r\n        return this.roomMap.get(room)!;\r\n    }\r\n\r\n    public static get instance(): RoomNotificationStateStore {\r\n        return RoomNotificationStateStore.internalInstance;\r\n    }\r\n\r\n    private onSync = (state: SyncState, prevState: SyncState | null): void => {\r\n        this.emitUpdateIfStateChanged(state, state !== prevState);\r\n    };\r\n\r\n    /**\r\n     * If the SummarizedNotificationState of this room has changed, or forceEmit\r\n     * is true, emit an UPDATE_STATUS_INDICATOR event.\r\n     *\r\n     * @internal public for test\r\n     */\r\n    public emitUpdateIfStateChanged = (state: SyncState, forceEmit: boolean): void => {\r\n        if (!this.matrixClient) return;\r\n        // Only count visible rooms to not torment the user with notification counts in rooms they can't see.\r\n        // This will include highlights from the previous version of the room internally\r\n        const msc3946ProcessDynamicPredecessor = SettingsStore.getValue(\"feature_dynamic_room_predecessors\");\r\n        const globalState = new SummarizedNotificationState();\r\n        const visibleRooms = this.matrixClient.getVisibleRooms(msc3946ProcessDynamicPredecessor);\r\n\r\n        let numFavourites = 0;\r\n        for (const room of visibleRooms) {\r\n            if (VisibilityProvider.instance.isRoomVisible(room)) {\r\n                globalState.add(this.getRoomState(room));\r\n\r\n                if (room.tags[DefaultTagID.Favourite] && !room.getType()) numFavourites++;\r\n            }\r\n        }\r\n\r\n        PosthogAnalytics.instance.setProperty(\"numFavouriteRooms\", numFavourites);\r\n\r\n        if (\r\n            this.globalState.symbol !== globalState.symbol ||\r\n            this.globalState.count !== globalState.count ||\r\n            this.globalState.color !== globalState.color ||\r\n            this.globalState.numUnreadStates !== globalState.numUnreadStates ||\r\n            forceEmit\r\n        ) {\r\n            this._globalState = globalState;\r\n            this.emit(UPDATE_STATUS_INDICATOR, globalState, state);\r\n        }\r\n    };\r\n\r\n    protected async onReady(): Promise<void> {\r\n        this.matrixClient?.on(ClientEvent.Sync, this.onSync);\r\n    }\r\n\r\n    protected async onNotReady(): Promise<any> {\r\n        this.matrixClient?.off(ClientEvent.Sync, this.onSync);\r\n        for (const roomState of this.roomMap.values()) {\r\n            roomState.destroy();\r\n        }\r\n    }\r\n\r\n    // We don't need this, but our contract says we do.\r\n    protected async onAction(payload: ActionPayload): Promise<void> {}\r\n}\r\n"],"mappings":"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"}