{"version":3,"file":"theme.js","names":["_utils","require","_languageHandler","_SettingsStore","_interopRequireDefault","_ThemeWatcher","DEFAULT_THEME","exports","HIGH_CONTRAST_THEMES","light","findHighContrastTheme","theme","findNonHighContrastTheme","hcTheme","isHighContrastTheme","Object","values","includes","enumerateThemes","BUILTIN_THEMES","_t","customThemes","SettingsStore","getValue","customThemeNames","name","assign","getOrderedThemes","themes","entries","map","p","id","filter","builtInThemes","startsWith","sort","a","b","compare","clearCustomTheme","inlineStyleProps","document","body","style","prop","removeProperty","customFontFaceStyle","querySelector","remove","allowedFontFaceProps","generateCustomFontFaceCSS","faces","face","src","srcElement","format","url","local","join","props","keys","value","setCustomThemeVars","customTheme","setCSSColorVariable","hexColor","doPct","arguments","length","undefined","setProperty","colors","Array","isArray","i","fonts","css","createElement","setAttribute","appendChild","createTextNode","head","general","monospace","getCustomTheme","themeName","Error","find","t","knownNames","setTheme","themeWatcher","ThemeWatcher","getEffectiveTheme","stylesheetName","slice","is_dark","styleElements","Map","from","querySelectorAll","forEach","set","dataset","mxTheme","toLowerCase","has","styleSheet","get","disabled","Promise","resolve","reject","switchTheme","bodyStyles","global","getComputedStyle","backgroundColor","metaElement","content","isStyleSheetLoaded","Boolean","styleSheets","_styleSheet","href","waitForStyleSheetLoading","counter","intervalId","window","setInterval","clearInterval","onload","onerror","e"],"sources":["../src/theme.ts"],"sourcesContent":["/*\r\nCopyright 2019 Michael Telatynski <7t3chguy@gmail.com>\r\nCopyright 2019 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { compare } from \"matrix-js-sdk/src/utils\";\r\n\r\nimport { _t } from \"./languageHandler\";\r\nimport SettingsStore from \"./settings/SettingsStore\";\r\nimport ThemeWatcher from \"./settings/watchers/ThemeWatcher\";\r\n\r\nexport const DEFAULT_THEME = \"light\";\r\nconst HIGH_CONTRAST_THEMES: Record<string, string> = {\r\n    light: \"light-high-contrast\",\r\n};\r\n\r\ninterface IFontFaces extends Omit<Record<(typeof allowedFontFaceProps)[number], string>, \"src\"> {\r\n    src: {\r\n        format: string;\r\n        url: string;\r\n        local: string;\r\n    }[];\r\n}\r\n\r\ninterface ICustomTheme {\r\n    colors: {\r\n        [key: string]: string;\r\n    };\r\n    fonts: {\r\n        faces: IFontFaces[];\r\n        general: string;\r\n        monospace: string;\r\n    };\r\n    is_dark?: boolean; // eslint-disable-line camelcase\r\n}\r\n\r\n/**\r\n * Given a non-high-contrast theme, find the corresponding high-contrast one\r\n * if it exists, or return undefined if not.\r\n */\r\nexport function findHighContrastTheme(theme: string): string | undefined {\r\n    return HIGH_CONTRAST_THEMES[theme];\r\n}\r\n\r\n/**\r\n * Given a high-contrast theme, find the corresponding non-high-contrast one\r\n * if it exists, or return undefined if not.\r\n */\r\nexport function findNonHighContrastTheme(hcTheme: string): string | undefined {\r\n    for (const theme in HIGH_CONTRAST_THEMES) {\r\n        if (HIGH_CONTRAST_THEMES[theme] === hcTheme) {\r\n            return theme;\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Decide whether the supplied theme is high contrast.\r\n */\r\nexport function isHighContrastTheme(theme: string): boolean {\r\n    return Object.values(HIGH_CONTRAST_THEMES).includes(theme);\r\n}\r\n\r\nexport function enumerateThemes(): { [key: string]: string } {\r\n    const BUILTIN_THEMES = {\r\n        \"light\": _t(\"Light\"),\r\n        \"light-high-contrast\": _t(\"Light high contrast\"),\r\n        \"dark\": _t(\"Dark\"),\r\n    };\r\n    const customThemes = SettingsStore.getValue(\"custom_themes\");\r\n    const customThemeNames: Record<string, string> = {};\r\n    for (const { name } of customThemes) {\r\n        customThemeNames[`custom-${name}`] = name;\r\n    }\r\n    return Object.assign({}, customThemeNames, BUILTIN_THEMES);\r\n}\r\n\r\ninterface ITheme {\r\n    id: string;\r\n    name: string;\r\n}\r\n\r\nexport function getOrderedThemes(): ITheme[] {\r\n    const themes = Object.entries(enumerateThemes())\r\n        .map((p) => ({ id: p[0], name: p[1] })) // convert pairs to objects for code readability\r\n        .filter((p) => !isHighContrastTheme(p.id));\r\n    const builtInThemes = themes.filter((p) => !p.id.startsWith(\"custom-\"));\r\n    const customThemes = themes.filter((p) => !builtInThemes.includes(p)).sort((a, b) => compare(a.name, b.name));\r\n    return [...builtInThemes, ...customThemes];\r\n}\r\n\r\nfunction clearCustomTheme(): void {\r\n    // remove all css variables, we assume these are there because of the custom theme\r\n    const inlineStyleProps = Object.values(document.body.style);\r\n    for (const prop of inlineStyleProps) {\r\n        if (prop.startsWith(\"--\")) {\r\n            document.body.style.removeProperty(prop);\r\n        }\r\n    }\r\n    const customFontFaceStyle = document.querySelector(\"head > style[title='custom-theme-font-faces']\");\r\n    if (customFontFaceStyle) {\r\n        customFontFaceStyle.remove();\r\n    }\r\n}\r\n\r\nconst allowedFontFaceProps = [\r\n    \"font-display\",\r\n    \"font-family\",\r\n    \"font-stretch\",\r\n    \"font-style\",\r\n    \"font-weight\",\r\n    \"font-variant\",\r\n    \"font-feature-settings\",\r\n    \"font-variation-settings\",\r\n    \"src\",\r\n    \"unicode-range\",\r\n] as const;\r\n\r\nfunction generateCustomFontFaceCSS(faces: IFontFaces[]): string {\r\n    return faces\r\n        .map((face) => {\r\n            const src = face.src\r\n                ?.map((srcElement) => {\r\n                    let format = \"\";\r\n                    if (srcElement.format) {\r\n                        format = `format(\"${srcElement.format}\")`;\r\n                    }\r\n                    if (srcElement.url) {\r\n                        return `url(\"${srcElement.url}\") ${format}`;\r\n                    } else if (srcElement.local) {\r\n                        return `local(\"${srcElement.local}\") ${format}`;\r\n                    }\r\n                    return \"\";\r\n                })\r\n                .join(\", \");\r\n            const props = Object.keys(face).filter((prop) =>\r\n                allowedFontFaceProps.includes(prop as (typeof allowedFontFaceProps)[number]),\r\n            ) as Array<(typeof allowedFontFaceProps)[number]>;\r\n            const body = props\r\n                .map((prop) => {\r\n                    let value: string;\r\n                    if (prop === \"src\") {\r\n                        value = src;\r\n                    } else if (prop === \"font-family\") {\r\n                        value = `\"${face[prop]}\"`;\r\n                    } else {\r\n                        value = face[prop];\r\n                    }\r\n                    return `${prop}: ${value}`;\r\n                })\r\n                .join(\";\");\r\n            return `@font-face {${body}}`;\r\n        })\r\n        .join(\"\\n\");\r\n}\r\n\r\nfunction setCustomThemeVars(customTheme: ICustomTheme): void {\r\n    const { style } = document.body;\r\n\r\n    function setCSSColorVariable(name: string, hexColor: string, doPct = true): void {\r\n        style.setProperty(`--${name}`, hexColor);\r\n        if (doPct) {\r\n            // uses #rrggbbaa to define the color with alpha values at 0%, 15% and 50%\r\n            style.setProperty(`--${name}-0pct`, hexColor + \"00\");\r\n            style.setProperty(`--${name}-15pct`, hexColor + \"26\");\r\n            style.setProperty(`--${name}-50pct`, hexColor + \"7F\");\r\n        }\r\n    }\r\n\r\n    if (customTheme.colors) {\r\n        for (const [name, value] of Object.entries(customTheme.colors)) {\r\n            if (Array.isArray(value)) {\r\n                for (let i = 0; i < value.length; i += 1) {\r\n                    setCSSColorVariable(`${name}_${i}`, value[i], false);\r\n                }\r\n            } else {\r\n                setCSSColorVariable(name, value);\r\n            }\r\n        }\r\n    }\r\n    if (customTheme.fonts) {\r\n        const { fonts } = customTheme;\r\n        if (fonts.faces) {\r\n            const css = generateCustomFontFaceCSS(fonts.faces);\r\n            const style = document.createElement(\"style\");\r\n            style.setAttribute(\"title\", \"custom-theme-font-faces\");\r\n            style.setAttribute(\"type\", \"text/css\");\r\n            style.appendChild(document.createTextNode(css));\r\n            document.head.appendChild(style);\r\n        }\r\n        if (fonts.general) {\r\n            style.setProperty(\"--font-family\", fonts.general);\r\n        }\r\n        if (fonts.monospace) {\r\n            style.setProperty(\"--font-family-monospace\", fonts.monospace);\r\n        }\r\n    }\r\n}\r\n\r\nexport function getCustomTheme(themeName: string): ICustomTheme {\r\n    // set css variables\r\n    const customThemes = SettingsStore.getValue(\"custom_themes\");\r\n    if (!customThemes) {\r\n        throw new Error(`No custom themes set, can't set custom theme \"${themeName}\"`);\r\n    }\r\n    const customTheme = customThemes.find((t: ITheme) => t.name === themeName);\r\n    if (!customTheme) {\r\n        const knownNames = customThemes.map((t: ITheme) => t.name).join(\", \");\r\n        throw new Error(`Can't find custom theme \"${themeName}\", only know ${knownNames}`);\r\n    }\r\n    return customTheme;\r\n}\r\n\r\n/**\r\n * Called whenever someone changes the theme\r\n * Async function that returns once the theme has been set\r\n * (ie. the CSS has been loaded)\r\n *\r\n * @param {string} theme new theme\r\n */\r\nexport async function setTheme(theme?: string): Promise<void> {\r\n    if (!theme) {\r\n        const themeWatcher = new ThemeWatcher();\r\n        theme = themeWatcher.getEffectiveTheme();\r\n    }\r\n    clearCustomTheme();\r\n    let stylesheetName = theme;\r\n    if (theme.startsWith(\"custom-\")) {\r\n        const customTheme = getCustomTheme(theme.slice(7));\r\n        stylesheetName = customTheme.is_dark ? \"dark-custom\" : \"light-custom\";\r\n        setCustomThemeVars(customTheme);\r\n    }\r\n\r\n    // look for the stylesheet elements.\r\n    // styleElements is a map from style name to HTMLLinkElement.\r\n    const styleElements = new Map<string, HTMLLinkElement>();\r\n    const themes = Array.from(document.querySelectorAll<HTMLLinkElement>(\"[data-mx-theme]\"));\r\n    themes.forEach((theme) => {\r\n        styleElements.set(theme.dataset.mxTheme!.toLowerCase(), theme);\r\n    });\r\n\r\n    if (!styleElements.has(stylesheetName)) {\r\n        throw new Error(\"Unknown theme \" + stylesheetName);\r\n    }\r\n\r\n    // disable all of them first, then enable the one we want. Chrome only\r\n    // bothers to do an update on a true->false transition, so this ensures\r\n    // that we get exactly one update, at the right time.\r\n    //\r\n    // ^ This comment was true when we used to use alternative stylesheets\r\n    // for the CSS.  Nowadays we just set them all as disabled in index.html\r\n    // and enable them as needed.  It might be cleaner to disable them all\r\n    // at the same time to prevent loading two themes simultaneously and\r\n    // having them interact badly... but this causes a flash of unstyled app\r\n    // which is even uglier.  So we don't.\r\n\r\n    const styleSheet = styleElements.get(stylesheetName)!;\r\n    styleSheet.disabled = false;\r\n\r\n    return new Promise((resolve, reject) => {\r\n        const switchTheme = function (): void {\r\n            // we re-enable our theme here just in case we raced with another\r\n            // theme set request as per https://github.com/vector-im/element-web/issues/5601.\r\n            // We could alternatively lock or similar to stop the race, but\r\n            // this is probably good enough for now.\r\n            styleSheet.disabled = false;\r\n            styleElements.forEach((a) => {\r\n                if (a == styleSheet) return;\r\n                a.disabled = true;\r\n            });\r\n            const bodyStyles = global.getComputedStyle(document.body);\r\n            if (bodyStyles.backgroundColor) {\r\n                const metaElement = document.querySelector<HTMLMetaElement>('meta[name=\"theme-color\"]')!;\r\n                metaElement.content = bodyStyles.backgroundColor;\r\n            }\r\n            resolve();\r\n        };\r\n\r\n        const isStyleSheetLoaded = (): boolean =>\r\n            Boolean([...document.styleSheets].find((_styleSheet) => _styleSheet?.href === styleSheet.href));\r\n\r\n        function waitForStyleSheetLoading(): void {\r\n            // turns out that Firefox preloads the CSS for link elements with\r\n            // the disabled attribute, but Chrome doesn't.\r\n            if (isStyleSheetLoaded()) {\r\n                switchTheme();\r\n                return;\r\n            }\r\n\r\n            let counter = 0;\r\n\r\n            // In case of theme toggling (white => black => white)\r\n            // Chrome doesn't fire the `load` event when the white theme is selected the second times\r\n            const intervalId = window.setInterval(() => {\r\n                if (isStyleSheetLoaded()) {\r\n                    clearInterval(intervalId);\r\n                    styleSheet.onload = null;\r\n                    styleSheet.onerror = null;\r\n                    switchTheme();\r\n                }\r\n\r\n                // Avoid to be stuck in an endless loop if there is an issue in the stylesheet loading\r\n                counter++;\r\n                if (counter === 10) {\r\n                    clearInterval(intervalId);\r\n                    reject();\r\n                }\r\n            }, 200);\r\n\r\n            styleSheet.onload = () => {\r\n                clearInterval(intervalId);\r\n                switchTheme();\r\n            };\r\n\r\n            styleSheet.onerror = (e) => {\r\n                clearInterval(intervalId);\r\n                reject(e);\r\n            };\r\n        }\r\n\r\n        waitForStyleSheetLoading();\r\n    });\r\n}\r\n"],"mappings":"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"}