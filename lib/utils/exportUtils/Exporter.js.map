{"version":3,"file":"Exporter.js","names":["_eventTimeline","require","_fileSaver","_logger","_sanitizeFilename","_interopRequireDefault","_exportUtils","_DecryptFile","_Media","_DateUtils","_EventUtils","_languageHandler","_SdkConfig","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireWildcard","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","Exporter","constructor","room","exportType","exportOptions","setProgressText","_defineProperty2","maxSize","numberOfMessages","ExportType","LastNMessages","Error","window","addEventListener","onBeforeUnload","destinationFileName","makeFileNameNoExtension","SdkConfig","brand","e","preventDefault","returnValue","_t","updateProgress","progress","log","arguments","length","undefined","show","logger","addFile","filePath","blob","file","name","files","push","safeRoomName","sanitizeFilename","trim","safeDate","formatFullDateNoDayISO","Date","replace","safeBrand","downloadZIP","filename","filenameWithoutExt","substring","lastIndexOf","JSZip","Promise","resolve","then","zip","cancelled","cleanUp","content","generateAsync","type","saveAs","removeEventListener","cancelExport","downloadPlainText","fileName","text","Blob","setEventMetadata","event","roomState","currentState","sender","getSender","getSentinelMember","getType","target","getStateKey","getLimit","limit","Timeline","getRequiredEvents","eventMapper","client","getEventMapper","prevToken","events","eventsPerCrawl","Math","min","res","createMessagesRequest","roomId","Direction","Backward","chunk","matrixEvents","map","mxEv","count","total","end","i","floor","decryptionPromises","filter","isEncrypted","decryptEventIfNeeded","isRetry","emit","all","getMediaBlob","getContent","shouldDecrypt","decryptFile","media","mediaFromContent","srcHttp","image","fetch","err","splitFileName","lastDot","slice","ext","getFilePath","mediaType","msgtype","fileDirectory","fileDate","formatFullDateNoDay","getTs","fileExt","body","isVoiceMessage","isReply","relatesTo","isAttachment","attachmentTypes","includes","exports"],"sources":["../../../src/utils/exportUtils/Exporter.ts"],"sourcesContent":["/*\r\nCopyright 2021 - 2022 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { MatrixEvent } from \"matrix-js-sdk/src/models/event\";\r\nimport { Room } from \"matrix-js-sdk/src/models/room\";\r\nimport { Direction } from \"matrix-js-sdk/src/models/event-timeline\";\r\nimport { saveAs } from \"file-saver\";\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\nimport sanitizeFilename from \"sanitize-filename\";\r\n\r\nimport { ExportType, IExportOptions } from \"./exportUtils\";\r\nimport { decryptFile } from \"../DecryptFile\";\r\nimport { mediaFromContent } from \"../../customisations/Media\";\r\nimport { formatFullDateNoDay, formatFullDateNoDayISO } from \"../../DateUtils\";\r\nimport { isVoiceMessage } from \"../EventUtils\";\r\nimport { IMediaEventContent } from \"../../customisations/models/IMediaEventContent\";\r\nimport { _t } from \"../../languageHandler\";\r\nimport SdkConfig from \"../../SdkConfig\";\r\n\r\ntype BlobFile = {\r\n    name: string;\r\n    blob: Blob;\r\n};\r\n\r\nexport default abstract class Exporter {\r\n    protected files: BlobFile[] = [];\r\n    protected cancelled = false;\r\n\r\n    protected constructor(\r\n        protected room: Room,\r\n        protected exportType: ExportType,\r\n        protected exportOptions: IExportOptions,\r\n        protected setProgressText: React.Dispatch<React.SetStateAction<string>>,\r\n    ) {\r\n        if (\r\n            exportOptions.maxSize < 1 * 1024 * 1024 || // Less than 1 MB\r\n            exportOptions.maxSize > 8000 * 1024 * 1024 || // More than 8 GB\r\n            (!!exportOptions.numberOfMessages && exportOptions.numberOfMessages > 10 ** 8) ||\r\n            (exportType === ExportType.LastNMessages && !exportOptions.numberOfMessages)\r\n        ) {\r\n            throw new Error(\"Invalid export options\");\r\n        }\r\n        window.addEventListener(\"beforeunload\", this.onBeforeUnload);\r\n    }\r\n\r\n    public get destinationFileName(): string {\r\n        return this.makeFileNameNoExtension(SdkConfig.get().brand) + \".zip\";\r\n    }\r\n\r\n    protected onBeforeUnload(e: BeforeUnloadEvent): string {\r\n        e.preventDefault();\r\n        return (e.returnValue = _t(\"Are you sure you want to exit during this export?\"));\r\n    }\r\n\r\n    protected updateProgress(progress: string, log = true, show = true): void {\r\n        if (log) logger.log(progress);\r\n        if (show) this.setProgressText(progress);\r\n    }\r\n\r\n    protected addFile(filePath: string, blob: Blob): void {\r\n        const file = {\r\n            name: filePath,\r\n            blob,\r\n        };\r\n        this.files.push(file);\r\n    }\r\n\r\n    protected makeFileNameNoExtension(brand = \"matrix\"): string {\r\n        // First try to use the real name of the room, then a translated copy of a generic name,\r\n        // then finally hardcoded default to guarantee we'll have a name.\r\n        const safeRoomName = sanitizeFilename(this.room.name ?? _t(\"Unnamed Room\")).trim() || \"Unnamed Room\";\r\n        const safeDate = formatFullDateNoDayISO(new Date()).replace(/:/g, \"-\"); // ISO format automatically removes a lot of stuff for us\r\n        const safeBrand = sanitizeFilename(brand);\r\n        return `${safeBrand} - ${safeRoomName} - Chat Export - ${safeDate}`;\r\n    }\r\n\r\n    protected async downloadZIP(): Promise<string | void> {\r\n        const filename = this.destinationFileName;\r\n        const filenameWithoutExt = filename.substring(0, filename.lastIndexOf(\".\")); // take off the extension\r\n        const { default: JSZip } = await import(\"jszip\");\r\n\r\n        const zip = new JSZip();\r\n        // Create a writable stream to the directory\r\n        if (!this.cancelled) this.updateProgress(_t(\"Generating a ZIP\"));\r\n        else return this.cleanUp();\r\n\r\n        for (const file of this.files) zip.file(filenameWithoutExt + \"/\" + file.name, file.blob);\r\n\r\n        const content = await zip.generateAsync({ type: \"blob\" });\r\n        saveAs(content, filenameWithoutExt + \".zip\");\r\n    }\r\n\r\n    protected cleanUp(): string {\r\n        logger.log(\"Cleaning up...\");\r\n        window.removeEventListener(\"beforeunload\", this.onBeforeUnload);\r\n        return \"\";\r\n    }\r\n\r\n    public async cancelExport(): Promise<void> {\r\n        logger.log(\"Cancelling export...\");\r\n        this.cancelled = true;\r\n    }\r\n\r\n    protected downloadPlainText(fileName: string, text: string): void {\r\n        const content = new Blob([text], { type: \"text/plain\" });\r\n        saveAs(content, fileName);\r\n    }\r\n\r\n    protected setEventMetadata(event: MatrixEvent): MatrixEvent {\r\n        const roomState = this.room.currentState;\r\n        const sender = event.getSender();\r\n        event.sender = (!!sender && roomState?.getSentinelMember(sender)) || null;\r\n        if (event.getType() === \"m.room.member\") {\r\n            event.target = roomState?.getSentinelMember(event.getStateKey()!) ?? null;\r\n        }\r\n        return event;\r\n    }\r\n\r\n    public getLimit(): number {\r\n        let limit: number;\r\n        switch (this.exportType) {\r\n            case ExportType.LastNMessages:\r\n                // validated in constructor that numberOfMessages is defined\r\n                // when export type is LastNMessages\r\n                limit = this.exportOptions.numberOfMessages!;\r\n                break;\r\n            case ExportType.Timeline:\r\n                limit = 40;\r\n                break;\r\n            default:\r\n                limit = 10 ** 8;\r\n        }\r\n        return limit;\r\n    }\r\n\r\n    protected async getRequiredEvents(): Promise<MatrixEvent[]> {\r\n        const eventMapper = this.room.client.getEventMapper();\r\n\r\n        let prevToken: string | null = null;\r\n        let limit = this.getLimit();\r\n        const events: MatrixEvent[] = [];\r\n\r\n        while (limit) {\r\n            const eventsPerCrawl = Math.min(limit, 1000);\r\n            const res = await this.room.client.createMessagesRequest(\r\n                this.room.roomId,\r\n                prevToken,\r\n                eventsPerCrawl,\r\n                Direction.Backward,\r\n            );\r\n\r\n            if (this.cancelled) {\r\n                this.cleanUp();\r\n                return [];\r\n            }\r\n\r\n            if (res.chunk.length === 0) break;\r\n\r\n            limit -= res.chunk.length;\r\n\r\n            const matrixEvents: MatrixEvent[] = res.chunk.map(eventMapper);\r\n\r\n            for (const mxEv of matrixEvents) {\r\n                // if (this.exportOptions.startDate && mxEv.getTs() < this.exportOptions.startDate) {\r\n                //     // Once the last message received is older than the start date, we break out of both the loops\r\n                //     limit = 0;\r\n                //     break;\r\n                // }\r\n                events.push(mxEv);\r\n            }\r\n\r\n            if (this.exportType === ExportType.LastNMessages) {\r\n                this.updateProgress(\r\n                    _t(\"Fetched %(count)s events out of %(total)s\", {\r\n                        count: events.length,\r\n                        total: this.exportOptions.numberOfMessages,\r\n                    }),\r\n                );\r\n            } else {\r\n                this.updateProgress(\r\n                    _t(\"Fetched %(count)s events so far\", {\r\n                        count: events.length,\r\n                    }),\r\n                );\r\n            }\r\n\r\n            prevToken = res.end ?? null;\r\n        }\r\n        // Reverse the events so that we preserve the order\r\n        for (let i = 0; i < Math.floor(events.length / 2); i++) {\r\n            [events[i], events[events.length - i - 1]] = [events[events.length - i - 1], events[i]];\r\n        }\r\n\r\n        const decryptionPromises = events\r\n            .filter((event) => event.isEncrypted())\r\n            .map((event) => {\r\n                return this.room.client.decryptEventIfNeeded(event, {\r\n                    isRetry: true,\r\n                    emit: false,\r\n                });\r\n            });\r\n\r\n        // Wait for all the events to get decrypted.\r\n        await Promise.all(decryptionPromises);\r\n\r\n        for (let i = 0; i < events.length; i++) this.setEventMetadata(events[i]);\r\n\r\n        return events;\r\n    }\r\n\r\n    /**\r\n     * Decrypts if necessary, and fetches media from a matrix event\r\n     * @param event - matrix event with media event content\r\n     * @resolves when media has been fetched\r\n     * @throws if media was unable to be fetched\r\n     */\r\n    protected async getMediaBlob(event: MatrixEvent): Promise<Blob> {\r\n        let blob: Blob | undefined = undefined;\r\n        try {\r\n            const isEncrypted = event.isEncrypted();\r\n            const content = event.getContent<IMediaEventContent>();\r\n            const shouldDecrypt = isEncrypted && content.hasOwnProperty(\"file\") && event.getType() !== \"m.sticker\";\r\n            if (shouldDecrypt) {\r\n                blob = await decryptFile(content.file);\r\n            } else {\r\n                const media = mediaFromContent(content);\r\n                if (!media.srcHttp) {\r\n                    throw new Error(\"Cannot fetch without srcHttp\");\r\n                }\r\n                const image = await fetch(media.srcHttp);\r\n                blob = await image.blob();\r\n            }\r\n        } catch (err) {\r\n            logger.log(\"Error decrypting media\");\r\n        }\r\n        if (!blob) {\r\n            throw new Error(\"Unable to fetch file\");\r\n        }\r\n        return blob;\r\n    }\r\n\r\n    public splitFileName(file: string): string[] {\r\n        const lastDot = file.lastIndexOf(\".\");\r\n        if (lastDot === -1) return [file, \"\"];\r\n        const fileName = file.slice(0, lastDot);\r\n        const ext = file.slice(lastDot + 1);\r\n        return [fileName, \".\" + ext];\r\n    }\r\n\r\n    public getFilePath(event: MatrixEvent): string {\r\n        const mediaType = event.getContent().msgtype;\r\n        let fileDirectory: string;\r\n        switch (mediaType) {\r\n            case \"m.image\":\r\n                fileDirectory = \"images\";\r\n                break;\r\n            case \"m.video\":\r\n                fileDirectory = \"videos\";\r\n                break;\r\n            case \"m.audio\":\r\n                fileDirectory = \"audio\";\r\n                break;\r\n            default:\r\n                fileDirectory = event.getType() === \"m.sticker\" ? \"stickers\" : \"files\";\r\n        }\r\n        const fileDate = formatFullDateNoDay(new Date(event.getTs()));\r\n        let [fileName, fileExt] = this.splitFileName(event.getContent().body);\r\n\r\n        if (event.getType() === \"m.sticker\") fileExt = \".png\";\r\n        if (isVoiceMessage(event)) fileExt = \".ogg\";\r\n\r\n        return fileDirectory + \"/\" + fileName + \"-\" + fileDate + fileExt;\r\n    }\r\n\r\n    protected isReply(event: MatrixEvent): boolean {\r\n        const isEncrypted = event.isEncrypted();\r\n        // If encrypted, in_reply_to lies in event.event.content\r\n        const content = isEncrypted ? event.event.content! : event.getContent();\r\n        const relatesTo = content[\"m.relates_to\"];\r\n        return !!(relatesTo && relatesTo[\"m.in_reply_to\"]);\r\n    }\r\n\r\n    protected isAttachment(mxEv: MatrixEvent): boolean {\r\n        const attachmentTypes = [\"m.sticker\", \"m.image\", \"m.file\", \"m.video\", \"m.audio\"];\r\n        return mxEv.getType() === attachmentTypes[0] || attachmentTypes.includes(mxEv.getContent().msgtype!);\r\n    }\r\n\r\n    public abstract export(): Promise<void>;\r\n}\r\n"],"mappings":"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"}