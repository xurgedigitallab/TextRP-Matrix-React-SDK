{"version":3,"file":"threepids.js","names":["_directMessages","require","resolveThreePids","members","client","threePidMembers","filter","m","ThreepidMember","length","lookedUpProfiles","lookupThreePidProfiles","map","member","lookedUpProfile","find","r","threePidId","userId","DirectoryMember","user_id","mxid","avatar_url","profile","display_name","displayname","exports","lookupThreePids","threePids","identityServer","token","getAccessToken","lookedUp","bulkLookupThreePids","t","isEmail","threepids","_ref","_threePidType","lookedUpThreePids","promises","getProfileInfo","Promise","all"],"sources":["../../src/utils/threepids.ts"],"sourcesContent":["/*\r\nCopyright 2023 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { MatrixClient } from \"matrix-js-sdk/src/matrix\";\r\n\r\nimport { DirectoryMember, Member, ThreepidMember } from \"./direct-messages\";\r\n\r\n/**\r\n * Tries to resolve the ThreepidMembers to DirectoryMembers.\r\n *\r\n * @param members - List of members to resolve\r\n * @returns {Promise<Member[]>} Same list with ThreepidMembers replaced by DirectoryMembers if succesfully resolved\r\n */\r\nexport const resolveThreePids = async (members: Member[], client: MatrixClient): Promise<Member[]> => {\r\n    const threePidMembers = members.filter((m) => m instanceof ThreepidMember) as ThreepidMember[];\r\n\r\n    // Nothing to do here\r\n    if (threePidMembers.length === 0) return members;\r\n\r\n    const lookedUpProfiles = await lookupThreePidProfiles(threePidMembers, client);\r\n\r\n    return members.map((member: Member) => {\r\n        if (!(member instanceof ThreepidMember)) return member;\r\n\r\n        const lookedUpProfile = lookedUpProfiles.find((r) => r.threePidId === member.userId);\r\n\r\n        // No profile found for this member; use the ThreepidMember.\r\n        if (!lookedUpProfile) return member;\r\n\r\n        return new DirectoryMember({\r\n            user_id: lookedUpProfile.mxid,\r\n            avatar_url: lookedUpProfile?.profile?.avatar_url,\r\n            display_name: lookedUpProfile?.profile?.displayname,\r\n        });\r\n    });\r\n};\r\n\r\n/**\r\n * Tries to look up the ThreepidMembers.\r\n *\r\n * @param threePids - List of 3rd-party members to look up\r\n * @returns  List of resolved 3rd-party IDs with their MXIDs\r\n */\r\nexport const lookupThreePids = async (\r\n    threePids: ThreepidMember[],\r\n    client: MatrixClient,\r\n): Promise<{ threePidId: string; mxid: string }[]> => {\r\n    // No identity server configured. Unable to resolve any 3rd party member.\r\n    if (!client.identityServer) return [];\r\n\r\n    // Nothing we can search, return null\r\n    if (threePids.length === 0) return [];\r\n\r\n    const token = await client.identityServer.getAccessToken();\r\n\r\n    if (!token) return [];\r\n\r\n    const lookedUp = await client.bulkLookupThreePids(\r\n        threePids.map((t) => [t.isEmail ? \"email\" : \"msisdn\", t.userId]),\r\n        token,\r\n    );\r\n\r\n    return lookedUp.threepids.map(([_threePidType, threePidId, mxid]: [string, string, string]) => ({\r\n        threePidId,\r\n        mxid,\r\n    }));\r\n};\r\n\r\n/**\r\n * Tries to look up the MXIDs and profiles of the ThreepidMembers.\r\n *\r\n * @param threePids - List of 3rd-prty members to look up\r\n * @returns List of resolved 3rd-party members with their MXIDs and profile (if found)\r\n */\r\nexport const lookupThreePidProfiles = async (\r\n    threePids: ThreepidMember[],\r\n    client: MatrixClient,\r\n): Promise<{ threePidId: string; mxid: string; profile: null | { avatar_url?: string; displayname?: string } }[]> => {\r\n    const lookedUpThreePids = await lookupThreePids(threePids, client);\r\n    const promises = lookedUpThreePids.map(async (t) => {\r\n        let profile: null | { avatar_url?: string; display_name?: string } = null;\r\n\r\n        try {\r\n            profile = await client.getProfileInfo(t.mxid);\r\n        } catch {\r\n            // ignore any lookup error\r\n        }\r\n\r\n        return {\r\n            threePidId: t.threePidId,\r\n            mxid: t.mxid,\r\n            profile,\r\n        };\r\n    });\r\n    return Promise.all(promises);\r\n};\r\n"],"mappings":"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"}