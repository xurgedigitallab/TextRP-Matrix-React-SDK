{"version":3,"file":"FontManager.js","names":["_logger","require","safariVersionCheck","ua","logger","log","safariVersionMatch","match","macOSVersionStr","safariVersionStr","macOSVersion","split","map","n","parseInt","safariVersion","colrFontSupported","err","error","warn","isColrFontSupported","userAgent","navigator","includes","canvas","document","createElement","context","getContext","img","Image","fontCOLR","svg","width","height","src","encodeURIComponent","Promise","resolve","onload","drawImage","getImageData","data","e","colrFontCheckStarted","fixupColorFonts","path","fonts","add","FontFace","weight"],"sources":["../../src/utils/FontManager.ts"],"sourcesContent":["/*\r\nCopyright 2019 - 2021 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\n/*\r\n * Based on...\r\n * ChromaCheck 1.16\r\n * author Roel Nieskens, https://pixelambacht.nl\r\n * MIT license\r\n */\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\n\r\nfunction safariVersionCheck(ua: string): boolean {\r\n    logger.log(\"Browser is Safari - checking version for COLR support\");\r\n    try {\r\n        const safariVersionMatch = ua.match(/Mac OS X ([\\d|_]+).*Version\\/([\\d|.]+).*Safari/);\r\n        if (safariVersionMatch) {\r\n            const macOSVersionStr = safariVersionMatch[1];\r\n            const safariVersionStr = safariVersionMatch[2];\r\n            const macOSVersion = macOSVersionStr.split(\"_\").map((n) => parseInt(n, 10));\r\n            const safariVersion = safariVersionStr.split(\".\").map((n) => parseInt(n, 10));\r\n            const colrFontSupported = macOSVersion[0] >= 10 && macOSVersion[1] >= 14 && safariVersion[0] >= 12;\r\n            // https://www.colorfonts.wtf/ states safari supports COLR fonts from this version on\r\n            logger.log(\r\n                `COLR support on Safari requires macOS 10.14 and Safari 12, ` +\r\n                    `detected Safari ${safariVersionStr} on macOS ${macOSVersionStr}, ` +\r\n                    `COLR supported: ${colrFontSupported}`,\r\n            );\r\n            return colrFontSupported;\r\n        }\r\n    } catch (err) {\r\n        logger.error(\"Error in Safari COLR version check\", err);\r\n    }\r\n    logger.warn(\"Couldn't determine Safari version to check COLR font support, assuming no.\");\r\n    return false;\r\n}\r\n\r\nasync function isColrFontSupported(): Promise<boolean> {\r\n    logger.log(\"Checking for COLR support\");\r\n\r\n    const { userAgent } = navigator;\r\n    // Firefox has supported COLR fonts since version 26\r\n    // but doesn't support the check below without\r\n    // \"Extract canvas data\" permissions\r\n    // when content blocking is enabled.\r\n    if (userAgent.includes(\"Firefox\")) {\r\n        logger.log(\"Browser is Firefox - assuming COLR is supported\");\r\n        return true;\r\n    }\r\n    // Safari doesn't wait for the font to load (if it doesn't have it in cache)\r\n    // to emit the load event on the image, so there is no way to not make the check\r\n    // reliable. Instead sniff the version.\r\n    // Excluding \"Chrome\", as it's user agent unhelpfully also contains Safari...\r\n    if (!userAgent.includes(\"Chrome\") && userAgent.includes(\"Safari\")) {\r\n        return safariVersionCheck(userAgent);\r\n    }\r\n\r\n    try {\r\n        const canvas = document.createElement(\"canvas\");\r\n        const context = canvas.getContext(\"2d\")!;\r\n        const img = new Image();\r\n        // eslint-disable-next-line\r\n        const fontCOLR =\r\n            \"d09GRgABAAAAAAKAAAwAAAAAAowAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABDT0xSAAACVAAAABYAAAAYAAIAJUNQQUwAAAJsAAAAEgAAABLJAAAQT1MvMgAAAYAAAAA6AAAAYBfxJ0pjbWFwAAABxAAAACcAAAAsAAzpM2dseWYAAAH0AAAAGgAAABoNIh0kaGVhZAAAARwAAAAvAAAANgxLumdoaGVhAAABTAAAABUAAAAkCAEEAmhtdHgAAAG8AAAABgAAAAYEAAAAbG9jYQAAAewAAAAGAAAABgANAABtYXhwAAABZAAAABsAAAAgAg4AHW5hbWUAAAIQAAAAOAAAAD4C5wsecG9zdAAAAkgAAAAMAAAAIAADAAB4AWNgZGAAYQ5+qdB4fpuvDNIsDCBwaQGTAIi+VlscBaJZGMDiHAxMIAoAtjIF/QB4AWNgZGBgYQACOAkUQQWMAAGRABAAAAB4AWNgZGBgYGJgAdMMUJILJMQgAWICAAH3AC4AeAFjYGFhYJzAwMrAwDST6QwDA0M/hGZ8zWDMyMmAChgFkDgKQMBw4CXDSwYWEBdIYgAFBgYA/8sIdAAABAAAAAAAAAB4AWNgYGBkYAZiBgYeBhYGBSDNAoRA/kuG//8hpDgjWJ4BAFVMBiYAAAAAAAANAAAAAQAAAAAEAAQAAAMAABEhESEEAPwABAD8AAAAeAEtxgUNgAAAAMHHIQTShTlOAty9/4bf7AARCwlBNhBw4L/43qXjYGUmf19TMuLcj/BJL3XfBg54AWNgZsALAAB9AAR4AWNgYGAEYj4gFgGygGwICQACOwAoAAAAAAABAAEAAQAAAA4AAAAAyP8AAA==\";\r\n        const svg = `\r\n        <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"100\" style=\"background:#fff;fill:#000;\">\r\n            <style type=\"text/css\">\r\n                @font-face {\r\n                    font-family: \"chromacheck-colr\";\r\n                    src: url(data:application/x-font-woff;base64,${fontCOLR}) format(\"woff\");\r\n                }\r\n            </style>\r\n            <text x=\"0\" y=\"0\" font-size=\"20\">\r\n                <tspan font-family=\"chromacheck-colr\" x=\"0\" dy=\"20\">&#xe900;</tspan>\r\n            </text>\r\n        </svg>`;\r\n        canvas.width = 20;\r\n        canvas.height = 100;\r\n\r\n        img.src = \"data:image/svg+xml;charset=utf-8,\" + encodeURIComponent(svg);\r\n\r\n        logger.log(\"Waiting for COLR SVG to load\");\r\n        await new Promise((resolve) => (img.onload = resolve));\r\n        logger.log(\"Drawing canvas to detect COLR support\");\r\n        context.drawImage(img, 0, 0);\r\n        const colrFontSupported = context.getImageData(10, 10, 1, 1).data[0] === 200;\r\n        logger.log(\"Canvas check revealed COLR is supported? \" + colrFontSupported);\r\n        return colrFontSupported;\r\n    } catch (e) {\r\n        logger.error(\"Couldn't load COLR font\", e);\r\n        return false;\r\n    }\r\n}\r\n\r\nlet colrFontCheckStarted = false;\r\nexport async function fixupColorFonts(): Promise<void> {\r\n    if (colrFontCheckStarted) {\r\n        return;\r\n    }\r\n    colrFontCheckStarted = true;\r\n\r\n    if (await isColrFontSupported()) {\r\n        const path = `url('${require(\"../../res/fonts/Twemoji_Mozilla/TwemojiMozilla-colr.woff2\")}')`;\r\n        document.fonts.add(new FontFace(\"Twemoji\", path, {}));\r\n        // For at least Chrome on Windows 10, we have to explictly add extra\r\n        // weights for the emoji to appear in bold messages, etc.\r\n        document.fonts.add(new FontFace(\"Twemoji\", path, { weight: \"600\" }));\r\n        document.fonts.add(new FontFace(\"Twemoji\", path, { weight: \"700\" }));\r\n    } else {\r\n        // fall back to SBIX, generated via https://github.com/matrix-org/twemoji-colr/tree/matthew/sbix\r\n        const path = `url('${require(\"../../res/fonts/Twemoji_Mozilla/TwemojiMozilla-sbix.woff2\")}')`;\r\n        document.fonts.add(new FontFace(\"Twemoji\", path, {}));\r\n        document.fonts.add(new FontFace(\"Twemoji\", path, { weight: \"600\" }));\r\n        document.fonts.add(new FontFace(\"Twemoji\", path, { weight: \"700\" }));\r\n    }\r\n    // ...and if SBIX is not supported, the browser will fall back to one of the native fonts specified.\r\n}\r\n"],"mappings":"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"}