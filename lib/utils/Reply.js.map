{"version":3,"file":"Reply.js","names":["_sanitizeHtml","_interopRequireDefault","require","_escapeHtml","_thread","_event","_beacon","_polls","_HtmlUtils","_Permalinks","_location","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","_defineProperty2","default","getOwnPropertyDescriptors","defineProperties","defineProperty","getParentEventId","ev","isRedacted","replyEventId","stripPlainReply","body","lines","split","startsWith","shift","join","stripHTMLReply","html","sanitizeHtml","allowedTags","allowedAttributes","allowVulnerableTags","allowedSchemes","PERMITTED_URL_SCHEMES","exclusiveFilter","frame","tag","getNestedReplyText","permalinkCreator","formatted_body","msgtype","getContent","escapeHtml","replace","evLink","forEvent","getId","userLink","makeUserPermalink","getSender","mxid","M_BEACON_INFO","matches","getType","aTheir","isSelfLocation","M_POLL_START","extensibleEvent","unstableExtensibleEvent","question","text","M_POLL_END","MsgType","Text","Notice","trim","map","line","Image","Video","Audio","File","Location","Emote","makeReplyMixIn","mixin","event_id","threadRootId","is_falling_back","shouldDisplayReply","event","inReplyTo","getWireContent","relation","getRelation","rel_type","THREAD_RELATION_TYPE","name","addReplyToMessageContent","content","replyToEvent","opts","includeLegacyFallback","nestedReply"],"sources":["../../src/utils/Reply.ts"],"sourcesContent":["/*\r\n * Copyright 2021 Å imon Brandner <simon.bra.ag@gmail.com>\r\n * Copyright 2023 The Matrix.org Foundation C.I.C.\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n *         http://www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * Unless required by applicable law or agreed to in writing, software\r\n * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n * See the License for the specific language governing permissions and\r\n * limitations under the License.\r\n */\r\n\r\nimport { IContent, IEventRelation, MatrixEvent } from \"matrix-js-sdk/src/models/event\";\r\nimport sanitizeHtml from \"sanitize-html\";\r\nimport escapeHtml from \"escape-html\";\r\nimport { THREAD_RELATION_TYPE } from \"matrix-js-sdk/src/models/thread\";\r\nimport { MsgType } from \"matrix-js-sdk/src/@types/event\";\r\nimport { M_BEACON_INFO } from \"matrix-js-sdk/src/@types/beacon\";\r\nimport { M_POLL_END, M_POLL_START } from \"matrix-js-sdk/src/@types/polls\";\r\nimport { PollStartEvent } from \"matrix-js-sdk/src/extensible_events_v1/PollStartEvent\";\r\n\r\nimport { PERMITTED_URL_SCHEMES } from \"../HtmlUtils\";\r\nimport { makeUserPermalink, RoomPermalinkCreator } from \"./permalinks/Permalinks\";\r\nimport { isSelfLocation } from \"./location\";\r\n\r\nexport function getParentEventId(ev?: MatrixEvent): string | undefined {\r\n    if (!ev || ev.isRedacted()) return;\r\n    if (ev.replyEventId) {\r\n        return ev.replyEventId;\r\n    }\r\n}\r\n\r\n// Part of Replies fallback support\r\nexport function stripPlainReply(body: string): string {\r\n    // Removes lines beginning with `> ` until you reach one that doesn't.\r\n    const lines = body.split(\"\\n\");\r\n    while (lines.length && lines[0].startsWith(\"> \")) lines.shift();\r\n    // Reply fallback has a blank line after it, so remove it to prevent leading newline\r\n    if (lines[0] === \"\") lines.shift();\r\n    return lines.join(\"\\n\");\r\n}\r\n\r\n// Part of Replies fallback support - MUST NOT BE RENDERED DIRECTLY - UNSAFE HTML\r\nexport function stripHTMLReply(html: string): string {\r\n    // Sanitize the original HTML for inclusion in <mx-reply>.  We allow\r\n    // any HTML, since the original sender could use special tags that we\r\n    // don't recognize, but want to pass along to any recipients who do\r\n    // recognize them -- recipients should be sanitizing before displaying\r\n    // anyways.  However, we sanitize to 1) remove any mx-reply, so that we\r\n    // don't generate a nested mx-reply, and 2) make sure that the HTML is\r\n    // properly formatted (e.g. tags are closed where necessary)\r\n    return sanitizeHtml(html, {\r\n        allowedTags: false, // false means allow everything\r\n        allowedAttributes: false,\r\n        allowVulnerableTags: true, // silence xss warning, we won't be rendering directly this, so it is safe to do\r\n        // we somehow can't allow all schemes, so we allow all that we\r\n        // know of and mxc (for img tags)\r\n        allowedSchemes: [...PERMITTED_URL_SCHEMES, \"mxc\"],\r\n        exclusiveFilter: (frame) => frame.tag === \"mx-reply\",\r\n    });\r\n}\r\n\r\n// Part of Replies fallback support\r\nexport function getNestedReplyText(\r\n    ev: MatrixEvent,\r\n    permalinkCreator?: RoomPermalinkCreator,\r\n): { body: string; html: string } | null {\r\n    if (!ev) return null;\r\n\r\n    let {\r\n        body,\r\n        formatted_body: html,\r\n        msgtype,\r\n    } = ev.getContent<{\r\n        body: string;\r\n        msgtype?: string;\r\n        formatted_body?: string;\r\n    }>();\r\n    if (getParentEventId(ev)) {\r\n        if (body) body = stripPlainReply(body);\r\n    }\r\n\r\n    if (!body) body = \"\"; // Always ensure we have a body, for reasons.\r\n\r\n    if (html) {\r\n        // sanitize the HTML before we put it in an <mx-reply>\r\n        html = stripHTMLReply(html);\r\n    } else {\r\n        // Escape the body to use as HTML below.\r\n        // We also run a nl2br over the result to fix the fallback representation. We do this\r\n        // after converting the text to safe HTML to avoid user-provided BR's from being converted.\r\n        html = escapeHtml(body).replace(/\\n/g, \"<br/>\");\r\n    }\r\n\r\n    // dev note: do not rely on `body` being safe for HTML usage below.\r\n\r\n    const evLink = permalinkCreator?.forEvent(ev.getId()!);\r\n    const userLink = makeUserPermalink(ev.getSender()!);\r\n    const mxid = ev.getSender();\r\n\r\n    if (M_BEACON_INFO.matches(ev.getType())) {\r\n        const aTheir = isSelfLocation(ev.getContent()) ? \"their\" : \"a\";\r\n        return {\r\n            html:\r\n                `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>` +\r\n                `<br>shared ${aTheir} live location.</blockquote></mx-reply>`,\r\n            body: `> <${mxid}> shared ${aTheir} live location.\\n\\n`,\r\n        };\r\n    }\r\n\r\n    if (M_POLL_START.matches(ev.getType())) {\r\n        const extensibleEvent = ev.unstableExtensibleEvent as PollStartEvent;\r\n        const question = extensibleEvent?.question?.text;\r\n        return {\r\n            html:\r\n                `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>` +\r\n                `<br>Poll: ${question}</blockquote></mx-reply>`,\r\n            body: `> <${mxid}> started poll: ${question}\\n\\n`,\r\n        };\r\n    }\r\n    if (M_POLL_END.matches(ev.getType())) {\r\n        return {\r\n            html:\r\n                `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>` +\r\n                `<br>Ended poll</blockquote></mx-reply>`,\r\n            body: `> <${mxid}>Ended poll\\n\\n`,\r\n        };\r\n    }\r\n\r\n    // This fallback contains text that is explicitly EN.\r\n    switch (msgtype) {\r\n        case MsgType.Text:\r\n        case MsgType.Notice: {\r\n            html =\r\n                `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>` +\r\n                `<br>${html}</blockquote></mx-reply>`;\r\n            const lines = body.trim().split(\"\\n\");\r\n            if (lines.length > 0) {\r\n                lines[0] = `<${mxid}> ${lines[0]}`;\r\n                body = lines.map((line) => `> ${line}`).join(\"\\n\") + \"\\n\\n\";\r\n            }\r\n            break;\r\n        }\r\n        case MsgType.Image:\r\n            html =\r\n                `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>` +\r\n                `<br>sent an image.</blockquote></mx-reply>`;\r\n            body = `> <${mxid}> sent an image.\\n\\n`;\r\n            break;\r\n        case MsgType.Video:\r\n            html =\r\n                `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>` +\r\n                `<br>sent a video.</blockquote></mx-reply>`;\r\n            body = `> <${mxid}> sent a video.\\n\\n`;\r\n            break;\r\n        case MsgType.Audio:\r\n            html =\r\n                `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>` +\r\n                `<br>sent an audio file.</blockquote></mx-reply>`;\r\n            body = `> <${mxid}> sent an audio file.\\n\\n`;\r\n            break;\r\n        case MsgType.File:\r\n            html =\r\n                `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>` +\r\n                `<br>sent a file.</blockquote></mx-reply>`;\r\n            body = `> <${mxid}> sent a file.\\n\\n`;\r\n            break;\r\n        case MsgType.Location: {\r\n            const aTheir = isSelfLocation(ev.getContent()) ? \"their\" : \"a\";\r\n            html =\r\n                `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>` +\r\n                `<br>shared ${aTheir} location.</blockquote></mx-reply>`;\r\n            body = `> <${mxid}> shared ${aTheir} location.\\n\\n`;\r\n            break;\r\n        }\r\n        case MsgType.Emote: {\r\n            html =\r\n                `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> * ` +\r\n                `<a href=\"${userLink}\">${mxid}</a><br>${html}</blockquote></mx-reply>`;\r\n            const lines = body.trim().split(\"\\n\");\r\n            if (lines.length > 0) {\r\n                lines[0] = `* <${mxid}> ${lines[0]}`;\r\n                body = lines.map((line) => `> ${line}`).join(\"\\n\") + \"\\n\\n\";\r\n            }\r\n            break;\r\n        }\r\n        default:\r\n            return null;\r\n    }\r\n\r\n    return { body, html };\r\n}\r\n\r\nexport function makeReplyMixIn(ev?: MatrixEvent): IEventRelation {\r\n    if (!ev) return {};\r\n\r\n    const mixin: IEventRelation = {\r\n        \"m.in_reply_to\": {\r\n            event_id: ev.getId(),\r\n        },\r\n    };\r\n\r\n    if (ev.threadRootId) {\r\n        mixin.is_falling_back = false;\r\n    }\r\n\r\n    return mixin;\r\n}\r\n\r\nexport function shouldDisplayReply(event: MatrixEvent): boolean {\r\n    if (event.isRedacted()) {\r\n        return false;\r\n    }\r\n\r\n    const inReplyTo = event.getWireContent()?.[\"m.relates_to\"]?.[\"m.in_reply_to\"];\r\n    if (!inReplyTo) {\r\n        return false;\r\n    }\r\n\r\n    const relation = event.getRelation();\r\n    if (relation?.rel_type === THREAD_RELATION_TYPE.name && relation?.is_falling_back) {\r\n        return false;\r\n    }\r\n\r\n    return !!inReplyTo.event_id;\r\n}\r\n\r\ninterface AddReplyOpts {\r\n    permalinkCreator?: RoomPermalinkCreator;\r\n    includeLegacyFallback: false;\r\n}\r\n\r\ninterface IncludeLegacyFeedbackOpts {\r\n    permalinkCreator?: RoomPermalinkCreator;\r\n    includeLegacyFallback: true;\r\n}\r\n\r\nexport function addReplyToMessageContent(\r\n    content: IContent,\r\n    replyToEvent: MatrixEvent,\r\n    opts: AddReplyOpts | IncludeLegacyFeedbackOpts,\r\n): void {\r\n    content[\"m.relates_to\"] = {\r\n        ...(content[\"m.relates_to\"] || {}),\r\n        ...makeReplyMixIn(replyToEvent),\r\n    };\r\n\r\n    if (opts.includeLegacyFallback) {\r\n        // Part of Replies fallback support - prepend the text we're sending with the text we're replying to\r\n        const nestedReply = getNestedReplyText(replyToEvent, opts.permalinkCreator);\r\n        if (nestedReply) {\r\n            if (content.formatted_body) {\r\n                content.formatted_body = nestedReply.html + content.formatted_body;\r\n            }\r\n            content.body = nestedReply.body + content.body;\r\n        }\r\n    }\r\n}\r\n"],"mappings":"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"}