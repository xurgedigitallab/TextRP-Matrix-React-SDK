{"version":3,"file":"WidgetUtils.js","names":["_rfc","require","_logger","_matrix","_call","_randomstring","_PlatformPeg","_interopRequireDefault","_SdkConfig","_dispatcher","_WidgetEchoStore","_IntegrationManagers","_WidgetType","_Jitsi","_objects","_languageHandler","_WidgetStore","_UrlUtils","WIDGET_WAIT_TIME","WidgetUtils","canUserModifyWidgets","client","roomId","logger","warn","room","getRoom","me","getUserId","getMyMembership","currentState","maySendStateEvent","isScalarUrl","testUrlString","error","testUrl","parseUrl","scalarUrls","SdkConfig","get","integrations_widgets_urls","length","defaultManager","IntegrationManagers","sharedInstance","getPrimaryManager","apiUrl","i","scalarUrl","protocol","host","pathname","startsWith","waitForUserWidget","widgetId","add","Promise","resolve","reject","eventInIntendedState","ev","getContent","undefined","startingAccountDataEvent","getAccountData","onAccountData","currentAccountDataEvent","removeListener","ClientEvent","AccountData","clearTimeout","timerId","window","setTimeout","Error","on","waitForRoomWidget","eventsInIntendedState","evList","widgetPresent","some","startingWidgetEvents","getStateEvents","onRoomStateEvents","getRoomId","getType","currentWidgetEvents","RoomStateEvent","Events","setUserWidget","widgetType","widgetUrl","widgetName","widgetData","userWidgets","objectClone","getUserWidgets","e","addingWidget","Boolean","userId","getSafeUserId","content","id","type","preferred","url","name","data","creatorUserId","sender","state_key","setAccountData","then","dis","dispatch","action","setRoomWidget","widgetAvatarUrl","legacy","avatar_url","setRoomWidgetContent","WidgetEchoStore","setRoomWidgetEcho","sendStateEvent","finally","removeRoomWidgetEcho","getRoomWidgets","appsStateEvents","filter","getUserWidgetsArray","Object","values","getStickerpickerWidgets","widgets","widget","getIntegrationManagerWidgets","w","getRoomWidgetsOfType","matches","removeIntegrationManagerWidgets","entries","forEach","_ref","key","addIntegrationManagerWidget","uiUrl","Date","getTime","WidgetType","INTEGRATION_MANAGER","api_url","removeStickerpickerWidgets","_ref2","addJitsiWidget","isVideoChannel","oobRoomName","domain","Jitsi","getInstance","preferredDomain","auth","getJitsiAuth","randomString","confId","base32","stringify","Buffer","from","pad","randomUppercaseString","randomLowercaseString","URL","getLocalJitsiWrapperUrl","search","searchParams","set","JITSI","toString","conferenceId","roomName","isAudioOnly","CallType","Voice","makeAppConfig","appId","app","senderUserId","eventId","opts","arguments","queryStringParts","PlatformPeg","supportsJitsiScreensharing","push","queryString","join","baseUrl","location","href","forLocalRender","getWidgetName","trim","_t","getWidgetDataTitle","title","getWidgetUid","calcWidgetUid","isAppWidget","editWidget","open","isManagedByManager","managers","hasManager","exports","default"],"sources":["../../src/utils/WidgetUtils.ts"],"sourcesContent":["/*\r\nCopyright 2019 Travis Ralston\r\nCopyright 2017 - 2020 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { base32 } from \"rfc4648\";\r\nimport { IWidget, IWidgetData } from \"matrix-widget-api\";\r\nimport { Room } from \"matrix-js-sdk/src/models/room\";\r\nimport { MatrixEvent } from \"matrix-js-sdk/src/models/event\";\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\nimport { ClientEvent, MatrixClient, RoomStateEvent } from \"matrix-js-sdk/src/matrix\";\r\nimport { CallType } from \"matrix-js-sdk/src/webrtc/call\";\r\nimport { randomString, randomLowercaseString, randomUppercaseString } from \"matrix-js-sdk/src/randomstring\";\r\n\r\nimport PlatformPeg from \"../PlatformPeg\";\r\nimport SdkConfig from \"../SdkConfig\";\r\nimport dis from \"../dispatcher/dispatcher\";\r\nimport WidgetEchoStore from \"../stores/WidgetEchoStore\";\r\nimport { IntegrationManagers } from \"../integrations/IntegrationManagers\";\r\nimport { WidgetType } from \"../widgets/WidgetType\";\r\nimport { Jitsi } from \"../widgets/Jitsi\";\r\nimport { objectClone } from \"./objects\";\r\nimport { _t } from \"../languageHandler\";\r\nimport { IApp, isAppWidget } from \"../stores/WidgetStore\";\r\nimport { parseUrl } from \"./UrlUtils\";\r\n\r\n// How long we wait for the state event echo to come back from the server\r\n// before waitFor[Room/User]Widget rejects its promise\r\nconst WIDGET_WAIT_TIME = 20000;\r\n\r\nexport interface IWidgetEvent {\r\n    id: string;\r\n    type: string;\r\n    sender: string;\r\n    // eslint-disable-next-line camelcase\r\n    state_key: string;\r\n    content: IApp;\r\n}\r\n\r\nexport interface UserWidget extends Omit<IWidgetEvent, \"content\"> {\r\n    content: IWidget & Partial<IApp>;\r\n}\r\n\r\nexport default class WidgetUtils {\r\n    /**\r\n     * Returns true if user is able to send state events to modify widgets in this room\r\n     * (Does not apply to non-room-based / user widgets)\r\n     * @param client The matrix client of the logged-in user\r\n     * @param roomId -- The ID of the room to check\r\n     * @return Boolean -- true if the user can modify widgets in this room\r\n     * @throws Error -- specifies the error reason\r\n     */\r\n    public static canUserModifyWidgets(client: MatrixClient, roomId?: string): boolean {\r\n        if (!roomId) {\r\n            logger.warn(\"No room ID specified\");\r\n            return false;\r\n        }\r\n\r\n        if (!client) {\r\n            logger.warn(\"User must be be logged in\");\r\n            return false;\r\n        }\r\n\r\n        const room = client.getRoom(roomId);\r\n        if (!room) {\r\n            logger.warn(`Room ID ${roomId} is not recognised`);\r\n            return false;\r\n        }\r\n\r\n        const me = client.getUserId();\r\n        if (!me) {\r\n            logger.warn(\"Failed to get user ID\");\r\n            return false;\r\n        }\r\n\r\n        if (room.getMyMembership() !== \"join\") {\r\n            logger.warn(`User ${me} is not in room ${roomId}`);\r\n            return false;\r\n        }\r\n\r\n        // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\r\n        return room.currentState.maySendStateEvent(\"im.vector.modular.widgets\", me);\r\n    }\r\n\r\n    // TODO: Generify the name of this function. It's not just scalar.\r\n    /**\r\n     * Returns true if specified url is a scalar URL, typically https://scalar.vector.im/api\r\n     * @param matrixClient The matrix client of the logged-in user\r\n     * @param  {[type]}  testUrlString URL to check\r\n     * @return {Boolean} True if specified URL is a scalar URL\r\n     */\r\n    public static isScalarUrl(testUrlString?: string): boolean {\r\n        if (!testUrlString) {\r\n            logger.error(\"Scalar URL check failed. No URL specified\");\r\n            return false;\r\n        }\r\n\r\n        const testUrl = parseUrl(testUrlString);\r\n        let scalarUrls = SdkConfig.get().integrations_widgets_urls;\r\n        if (!scalarUrls || scalarUrls.length === 0) {\r\n            const defaultManager = IntegrationManagers.sharedInstance().getPrimaryManager();\r\n            if (defaultManager) {\r\n                scalarUrls = [defaultManager.apiUrl];\r\n            } else {\r\n                scalarUrls = [];\r\n            }\r\n        }\r\n\r\n        for (let i = 0; i < scalarUrls.length; i++) {\r\n            const scalarUrl = parseUrl(scalarUrls[i]);\r\n            if (testUrl && scalarUrl) {\r\n                if (\r\n                    testUrl.protocol === scalarUrl.protocol &&\r\n                    testUrl.host === scalarUrl.host &&\r\n                    scalarUrl.pathname &&\r\n                    testUrl.pathname?.startsWith(scalarUrl.pathname)\r\n                ) {\r\n                    return true;\r\n                }\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Returns a promise that resolves when a widget with the given\r\n     * ID has been added as a user widget (ie. the accountData event\r\n     * arrives) or rejects after a timeout\r\n     *\r\n     * @param client The matrix client of the logged-in user\r\n     * @param widgetId The ID of the widget to wait for\r\n     * @param add True to wait for the widget to be added,\r\n     *     false to wait for it to be deleted.\r\n     * @returns {Promise} that resolves when the widget is in the\r\n     *     requested state according to the `add` param\r\n     */\r\n    public static waitForUserWidget(client: MatrixClient, widgetId: string, add: boolean): Promise<void> {\r\n        return new Promise((resolve, reject) => {\r\n            // Tests an account data event, returning true if it's in the state\r\n            // we're waiting for it to be in\r\n            function eventInIntendedState(ev?: MatrixEvent): boolean {\r\n                if (!ev) return false;\r\n                if (add) {\r\n                    return ev.getContent()[widgetId] !== undefined;\r\n                } else {\r\n                    return ev.getContent()[widgetId] === undefined;\r\n                }\r\n            }\r\n\r\n            const startingAccountDataEvent = client.getAccountData(\"m.widgets\");\r\n            if (eventInIntendedState(startingAccountDataEvent)) {\r\n                resolve();\r\n                return;\r\n            }\r\n\r\n            function onAccountData(ev: MatrixEvent): void {\r\n                const currentAccountDataEvent = client.getAccountData(\"m.widgets\");\r\n                if (eventInIntendedState(currentAccountDataEvent)) {\r\n                    client.removeListener(ClientEvent.AccountData, onAccountData);\r\n                    clearTimeout(timerId);\r\n                    resolve();\r\n                }\r\n            }\r\n            const timerId = window.setTimeout(() => {\r\n                client.removeListener(ClientEvent.AccountData, onAccountData);\r\n                reject(new Error(\"Timed out waiting for widget ID \" + widgetId + \" to appear\"));\r\n            }, WIDGET_WAIT_TIME);\r\n            client.on(ClientEvent.AccountData, onAccountData);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Returns a promise that resolves when a widget with the given\r\n     * ID has been added as a room widget in the given room (ie. the\r\n     * room state event arrives) or rejects after a timeout\r\n     *\r\n     * @param client The matrix client of the logged-in user\r\n     * @param {string} widgetId The ID of the widget to wait for\r\n     * @param {string} roomId The ID of the room to wait for the widget in\r\n     * @param {boolean} add True to wait for the widget to be added,\r\n     *     false to wait for it to be deleted.\r\n     * @returns {Promise} that resolves when the widget is in the\r\n     *     requested state according to the `add` param\r\n     */\r\n    public static waitForRoomWidget(\r\n        client: MatrixClient,\r\n        widgetId: string,\r\n        roomId: string,\r\n        add: boolean,\r\n    ): Promise<void> {\r\n        return new Promise((resolve, reject) => {\r\n            // Tests a list of state events, returning true if it's in the state\r\n            // we're waiting for it to be in\r\n            function eventsInIntendedState(evList?: MatrixEvent[]): boolean {\r\n                const widgetPresent = evList?.some((ev) => {\r\n                    return ev.getContent() && ev.getContent()[\"id\"] === widgetId;\r\n                });\r\n                if (add) {\r\n                    return !!widgetPresent;\r\n                } else {\r\n                    return !widgetPresent;\r\n                }\r\n            }\r\n\r\n            const room = client.getRoom(roomId);\r\n            // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\r\n            const startingWidgetEvents = room?.currentState.getStateEvents(\"im.vector.modular.widgets\");\r\n            if (eventsInIntendedState(startingWidgetEvents)) {\r\n                resolve();\r\n                return;\r\n            }\r\n\r\n            function onRoomStateEvents(ev: MatrixEvent): void {\r\n                if (ev.getRoomId() !== roomId || ev.getType() !== \"im.vector.modular.widgets\") return;\r\n\r\n                // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\r\n                const currentWidgetEvents = room?.currentState.getStateEvents(\"im.vector.modular.widgets\");\r\n\r\n                if (eventsInIntendedState(currentWidgetEvents)) {\r\n                    client.removeListener(RoomStateEvent.Events, onRoomStateEvents);\r\n                    clearTimeout(timerId);\r\n                    resolve();\r\n                }\r\n            }\r\n            const timerId = window.setTimeout(() => {\r\n                client.removeListener(RoomStateEvent.Events, onRoomStateEvents);\r\n                reject(new Error(\"Timed out waiting for widget ID \" + widgetId + \" to appear\"));\r\n            }, WIDGET_WAIT_TIME);\r\n            client.on(RoomStateEvent.Events, onRoomStateEvents);\r\n        });\r\n    }\r\n\r\n    public static setUserWidget(\r\n        client: MatrixClient,\r\n        widgetId: string,\r\n        widgetType: WidgetType,\r\n        widgetUrl: string,\r\n        widgetName: string,\r\n        widgetData: IWidgetData,\r\n    ): Promise<void> {\r\n        // Get the current widgets and clone them before we modify them, otherwise\r\n        // we'll modify the content of the old event.\r\n        const userWidgets = objectClone(WidgetUtils.getUserWidgets(client));\r\n\r\n        // Delete existing widget with ID\r\n        try {\r\n            delete userWidgets[widgetId];\r\n        } catch (e) {\r\n            logger.error(`$widgetId is non-configurable`);\r\n        }\r\n\r\n        const addingWidget = Boolean(widgetUrl);\r\n\r\n        const userId = client.getSafeUserId();\r\n\r\n        const content = {\r\n            id: widgetId,\r\n            type: widgetType.preferred,\r\n            url: widgetUrl,\r\n            name: widgetName,\r\n            data: widgetData,\r\n            creatorUserId: userId,\r\n        };\r\n\r\n        // Add new widget / update\r\n        if (addingWidget) {\r\n            userWidgets[widgetId] = {\r\n                content: content,\r\n                sender: userId,\r\n                state_key: widgetId,\r\n                type: \"m.widget\",\r\n                id: widgetId,\r\n            };\r\n        }\r\n\r\n        // This starts listening for when the echo comes back from the server\r\n        // since the widget won't appear added until this happens. If we don't\r\n        // wait for this, the action will complete but if the user is fast enough,\r\n        // the widget still won't actually be there.\r\n        return client\r\n            .setAccountData(\"m.widgets\", userWidgets)\r\n            .then(() => {\r\n                return WidgetUtils.waitForUserWidget(client, widgetId, addingWidget);\r\n            })\r\n            .then(() => {\r\n                dis.dispatch({ action: \"user_widget_updated\" });\r\n            });\r\n    }\r\n\r\n    public static setRoomWidget(\r\n        client: MatrixClient,\r\n        roomId: string,\r\n        widgetId: string,\r\n        widgetType?: WidgetType,\r\n        widgetUrl?: string,\r\n        widgetName?: string,\r\n        widgetData?: IWidgetData,\r\n        widgetAvatarUrl?: string,\r\n    ): Promise<void> {\r\n        let content: Partial<IWidget> & { avatar_url?: string };\r\n\r\n        const addingWidget = Boolean(widgetUrl);\r\n\r\n        if (addingWidget) {\r\n            content = {\r\n                // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\r\n                // For now we'll send the legacy event type for compatibility with older apps/elements\r\n                type: widgetType?.legacy,\r\n                url: widgetUrl,\r\n                name: widgetName,\r\n                data: widgetData,\r\n                avatar_url: widgetAvatarUrl,\r\n            };\r\n        } else {\r\n            content = {};\r\n        }\r\n\r\n        return WidgetUtils.setRoomWidgetContent(client, roomId, widgetId, content as IWidget);\r\n    }\r\n\r\n    public static setRoomWidgetContent(\r\n        client: MatrixClient,\r\n        roomId: string,\r\n        widgetId: string,\r\n        content: IWidget,\r\n    ): Promise<void> {\r\n        const addingWidget = !!content.url;\r\n\r\n        WidgetEchoStore.setRoomWidgetEcho(roomId, widgetId, content);\r\n\r\n        // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\r\n        return client\r\n            .sendStateEvent(roomId, \"im.vector.modular.widgets\", content, widgetId)\r\n            .then(() => {\r\n                return WidgetUtils.waitForRoomWidget(client, widgetId, roomId, addingWidget);\r\n            })\r\n            .finally(() => {\r\n                WidgetEchoStore.removeRoomWidgetEcho(roomId, widgetId);\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Get room specific widgets\r\n     * @param  {Room} room The room to get widgets force\r\n     * @return {[object]} Array containing current / active room widgets\r\n     */\r\n    public static getRoomWidgets(room: Room): MatrixEvent[] {\r\n        // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\r\n        const appsStateEvents = room.currentState.getStateEvents(\"im.vector.modular.widgets\");\r\n        if (!appsStateEvents) {\r\n            return [];\r\n        }\r\n\r\n        return appsStateEvents.filter((ev) => {\r\n            return ev.getContent().type && ev.getContent().url;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get user specific widgets (not linked to a specific room)\r\n     * @param client The matrix client of the logged-in user\r\n     * @return {object} Event content object containing current / active user widgets\r\n     */\r\n    public static getUserWidgets(client: MatrixClient | undefined): Record<string, UserWidget> {\r\n        if (!client) {\r\n            throw new Error(\"User not logged in\");\r\n        }\r\n        const userWidgets = client.getAccountData(\"m.widgets\");\r\n        if (userWidgets && userWidgets.getContent()) {\r\n            return userWidgets.getContent();\r\n        }\r\n        return {};\r\n    }\r\n\r\n    /**\r\n     * Get user specific widgets (not linked to a specific room) as an array\r\n     * @param client The matrix client of the logged-in user\r\n     * @return {[object]} Array containing current / active user widgets\r\n     */\r\n    public static getUserWidgetsArray(client: MatrixClient | undefined): UserWidget[] {\r\n        return Object.values(WidgetUtils.getUserWidgets(client));\r\n    }\r\n\r\n    /**\r\n     * Get active stickerpicker widgets (stickerpickers are user widgets by nature)\r\n     * @param client The matrix client of the logged-in user\r\n     * @return {[object]} Array containing current / active stickerpicker widgets\r\n     */\r\n    public static getStickerpickerWidgets(client: MatrixClient | undefined): UserWidget[] {\r\n        const widgets = WidgetUtils.getUserWidgetsArray(client);\r\n        return widgets.filter((widget) => widget.content?.type === \"m.stickerpicker\");\r\n    }\r\n\r\n    /**\r\n     * Get all integration manager widgets for this user.\r\n     * @param client The matrix client of the logged-in user\r\n     * @returns {Object[]} An array of integration manager user widgets.\r\n     */\r\n    public static getIntegrationManagerWidgets(client: MatrixClient | undefined): UserWidget[] {\r\n        const widgets = WidgetUtils.getUserWidgetsArray(client);\r\n        return widgets.filter((w) => w.content?.type === \"m.integration_manager\");\r\n    }\r\n\r\n    public static getRoomWidgetsOfType(room: Room, type: WidgetType): MatrixEvent[] {\r\n        const widgets = WidgetUtils.getRoomWidgets(room) || [];\r\n        return widgets.filter((w) => {\r\n            const content = w.getContent();\r\n            return content.url && type.matches(content.type);\r\n        });\r\n    }\r\n\r\n    public static async removeIntegrationManagerWidgets(client: MatrixClient | undefined): Promise<void> {\r\n        if (!client) {\r\n            throw new Error(\"User not logged in\");\r\n        }\r\n        const widgets = client.getAccountData(\"m.widgets\");\r\n        if (!widgets) return;\r\n        const userWidgets: Record<string, IWidgetEvent> = widgets.getContent() || {};\r\n        Object.entries(userWidgets).forEach(([key, widget]) => {\r\n            if (widget.content && widget.content.type === \"m.integration_manager\") {\r\n                delete userWidgets[key];\r\n            }\r\n        });\r\n        await client.setAccountData(\"m.widgets\", userWidgets);\r\n    }\r\n\r\n    public static addIntegrationManagerWidget(\r\n        client: MatrixClient,\r\n        name: string,\r\n        uiUrl: string,\r\n        apiUrl: string,\r\n    ): Promise<void> {\r\n        return WidgetUtils.setUserWidget(\r\n            client,\r\n            \"integration_manager_\" + new Date().getTime(),\r\n            WidgetType.INTEGRATION_MANAGER,\r\n            uiUrl,\r\n            \"Integration manager: \" + name,\r\n            { api_url: apiUrl },\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Remove all stickerpicker widgets (stickerpickers are user widgets by nature)\r\n     * @param client The matrix client of the logged-in user\r\n     * @return {Promise} Resolves on account data updated\r\n     */\r\n    public static async removeStickerpickerWidgets(client: MatrixClient | undefined): Promise<void> {\r\n        if (!client) {\r\n            throw new Error(\"User not logged in\");\r\n        }\r\n        const widgets = client.getAccountData(\"m.widgets\");\r\n        if (!widgets) return;\r\n        const userWidgets: Record<string, IWidgetEvent> = widgets.getContent() || {};\r\n        Object.entries(userWidgets).forEach(([key, widget]) => {\r\n            if (widget.content && widget.content.type === \"m.stickerpicker\") {\r\n                delete userWidgets[key];\r\n            }\r\n        });\r\n        await client.setAccountData(\"m.widgets\", userWidgets);\r\n    }\r\n\r\n    public static async addJitsiWidget(\r\n        client: MatrixClient,\r\n        roomId: string,\r\n        type: CallType,\r\n        name: string,\r\n        isVideoChannel: boolean,\r\n        oobRoomName?: string,\r\n    ): Promise<void> {\r\n        const domain = Jitsi.getInstance().preferredDomain;\r\n        const auth = (await Jitsi.getInstance().getJitsiAuth()) ?? undefined;\r\n        const widgetId = randomString(24); // Must be globally unique\r\n\r\n        let confId: string;\r\n        if (auth === \"openidtoken-jwt\") {\r\n            // Create conference ID from room ID\r\n            // For compatibility with Jitsi, use base32 without padding.\r\n            // More details here:\r\n            // https://github.com/matrix-org/prosody-mod-auth-matrix-user-verification\r\n            confId = base32.stringify(Buffer.from(roomId), { pad: false });\r\n        } else {\r\n            // Create a random conference ID\r\n            confId = `Jitsi${randomUppercaseString(1)}${randomLowercaseString(23)}`;\r\n        }\r\n\r\n        // TODO: Remove URL hacks when the mobile clients eventually support v2 widgets\r\n        const widgetUrl = new URL(WidgetUtils.getLocalJitsiWrapperUrl({ auth }));\r\n        widgetUrl.search = \"\"; // Causes the URL class use searchParams instead\r\n        widgetUrl.searchParams.set(\"confId\", confId);\r\n\r\n        await WidgetUtils.setRoomWidget(client, roomId, widgetId, WidgetType.JITSI, widgetUrl.toString(), name, {\r\n            conferenceId: confId,\r\n            roomName: oobRoomName ?? client.getRoom(roomId)?.name,\r\n            isAudioOnly: type === CallType.Voice,\r\n            isVideoChannel,\r\n            domain,\r\n            auth,\r\n        });\r\n    }\r\n\r\n    public static makeAppConfig(\r\n        appId: string,\r\n        app: Partial<IApp>,\r\n        senderUserId: string,\r\n        roomId: string | undefined,\r\n        eventId: string | undefined,\r\n    ): IApp {\r\n        if (!senderUserId) {\r\n            throw new Error(\"Widgets must be created by someone - provide a senderUserId\");\r\n        }\r\n        app.creatorUserId = senderUserId;\r\n\r\n        app.id = appId;\r\n        app.roomId = roomId;\r\n        app.eventId = eventId;\r\n        app.name = app.name || app.type;\r\n\r\n        return app as IApp;\r\n    }\r\n\r\n    public static getLocalJitsiWrapperUrl(opts: { forLocalRender?: boolean; auth?: string } = {}): string {\r\n        // NB. we can't just encodeURIComponent all of these because the $ signs need to be there\r\n        const queryStringParts = [\r\n            \"conferenceDomain=$domain\",\r\n            \"conferenceId=$conferenceId\",\r\n            \"isAudioOnly=$isAudioOnly\",\r\n            \"startWithAudioMuted=$startWithAudioMuted\",\r\n            \"startWithVideoMuted=$startWithVideoMuted\",\r\n            \"isVideoChannel=$isVideoChannel\",\r\n            \"displayName=$matrix_display_name\",\r\n            \"avatarUrl=$matrix_avatar_url\",\r\n            \"userId=$matrix_user_id\",\r\n            \"roomId=$matrix_room_id\",\r\n            \"theme=$theme\",\r\n            \"roomName=$roomName\",\r\n            `supportsScreensharing=${PlatformPeg.get()?.supportsJitsiScreensharing()}`,\r\n            \"language=$org.matrix.msc2873.client_language\",\r\n        ];\r\n        if (opts.auth) {\r\n            queryStringParts.push(`auth=${opts.auth}`);\r\n        }\r\n        const queryString = queryStringParts.join(\"&\");\r\n\r\n        let baseUrl = window.location.href;\r\n        if (window.location.protocol !== \"https:\" && !opts.forLocalRender) {\r\n            // Use an external wrapper if we're not locally rendering the widget. This is usually\r\n            // the URL that will end up in the widget event, so we want to make sure it's relatively\r\n            // safe to send.\r\n            // We'll end up using a local render URL when we see a Jitsi widget anyways, so this is\r\n            // really just for backwards compatibility and to appease the spec.\r\n            baseUrl = \"https://app.element.io/\";\r\n        }\r\n        const url = new URL(\"jitsi.html#\" + queryString, baseUrl); // this strips hash fragment from baseUrl\r\n        return url.href;\r\n    }\r\n\r\n    public static getWidgetName(app?: IWidget): string {\r\n        return app?.name?.trim() || _t(\"Unknown App\");\r\n    }\r\n\r\n    public static getWidgetDataTitle(app?: IWidget): string {\r\n        return app?.data?.title?.trim() || \"\";\r\n    }\r\n\r\n    public static getWidgetUid(app?: IApp | IWidget): string {\r\n        return app ? WidgetUtils.calcWidgetUid(app.id, isAppWidget(app) ? app.roomId : undefined) : \"\";\r\n    }\r\n\r\n    public static calcWidgetUid(widgetId: string, roomId?: string): string {\r\n        return roomId ? `room_${roomId}_${widgetId}` : `user_${widgetId}`;\r\n    }\r\n\r\n    public static editWidget(room: Room, app: IWidget): void {\r\n        // noinspection JSIgnoredPromiseFromCall\r\n        IntegrationManagers.sharedInstance()\r\n            .getPrimaryManager()\r\n            ?.open(room, \"type_\" + app.type, app.id);\r\n    }\r\n\r\n    public static isManagedByManager(app: IWidget): boolean {\r\n        if (WidgetUtils.isScalarUrl(app.url)) {\r\n            const managers = IntegrationManagers.sharedInstance();\r\n            if (managers.hasManager()) {\r\n                // TODO: Pick the right manager for the widget\r\n                const defaultManager = managers.getPrimaryManager();\r\n                return WidgetUtils.isScalarUrl(defaultManager?.apiUrl);\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n}\r\n"],"mappings":"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"}