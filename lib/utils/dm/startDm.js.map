{"version":3,"file":"startDm.js","names":["_actions","require","_directMessages","_DMRoomMap","_interopRequireDefault","_isLocalRoom","_findDMForUser","_dispatcher","_UserAddress","_createRoom","startDm","client","targets","showSpinner","arguments","length","undefined","createOpts","targetIds","map","t","userId","existingRoom","findDMForUser","DMRoomMap","shared","getDMRoomForIdentifiers","isLocalRoom","dis","dispatch","action","Action","ViewRoom","room_id","roomId","should_peek","joining","metricsTrigger","Promise","resolve","createRoomOptions","inlineErrors","determineCreateRoomEncryptionOption","encryption","isSelf","getUserId","dmUserId","reduce","roomOptions","address","type","getAddressType","invite","id_server","getIdentityServerUrl","medium","invite_3pid","push","spinner","Object","keys","includes","andView","createRoom"],"sources":["../../../src/utils/dm/startDm.ts"],"sourcesContent":["/*\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { IInvite3PID, MatrixClient, Room } from \"matrix-js-sdk/src/matrix\";\r\nimport { Optional } from \"matrix-events-sdk\";\r\n\r\nimport { Action } from \"../../dispatcher/actions\";\r\nimport { ViewRoomPayload } from \"../../dispatcher/payloads/ViewRoomPayload\";\r\nimport { determineCreateRoomEncryptionOption, Member } from \"../direct-messages\";\r\nimport DMRoomMap from \"../DMRoomMap\";\r\nimport { isLocalRoom } from \"../localRoom/isLocalRoom\";\r\nimport { findDMForUser } from \"./findDMForUser\";\r\nimport dis from \"../../dispatcher/dispatcher\";\r\nimport { getAddressType } from \"../../UserAddress\";\r\nimport createRoom from \"../../createRoom\";\r\n\r\n/**\r\n * Start a DM.\r\n *\r\n * @returns {Promise<string | null} Resolves to the room id.\r\n */\r\nexport async function startDm(client: MatrixClient, targets: Member[], showSpinner = true, createOpts?: any): Promise<string | null> {\r\n    const targetIds = targets.map((t) => t.userId);\r\n\r\n    // Check if there is already a DM with these people and reuse it if possible.\r\n    let existingRoom: Optional<Room>;\r\n    if (targetIds.length === 1) {\r\n        existingRoom = findDMForUser(client, targetIds[0]);\r\n    } else {\r\n        existingRoom = DMRoomMap.shared().getDMRoomForIdentifiers(targetIds) ?? undefined;\r\n    }\r\n    if (existingRoom && !isLocalRoom(existingRoom)) {\r\n        dis.dispatch<ViewRoomPayload>({\r\n            action: Action.ViewRoom,\r\n            room_id: existingRoom.roomId,\r\n            should_peek: false,\r\n            joining: false,\r\n            metricsTrigger: \"MessageUser\",\r\n        });\r\n        return Promise.resolve(existingRoom.roomId);\r\n    }\r\n\r\n    const createRoomOptions = { inlineErrors: true } as any; // XXX: Type out `createRoomOptions`\r\n\r\n    if (await determineCreateRoomEncryptionOption(client, targets)) {\r\n        createRoomOptions.encryption = true;\r\n    }\r\n\r\n    // Check if it's a traditional DM and create the room if required.\r\n    // TODO: [Canonical DMs] Remove this check and instead just create the multi-person DM\r\n    const isSelf = targetIds.length === 1 && targetIds[0] === client.getUserId();\r\n    if (targetIds.length === 1 && !isSelf) {\r\n        createRoomOptions.dmUserId = targetIds[0];\r\n    }\r\n\r\n    if (targetIds.length > 1) {\r\n        createRoomOptions.createOpts = targetIds.reduce<{\r\n            invite_3pid: IInvite3PID[];\r\n            invite: string[];\r\n        }>(\r\n            (roomOptions, address) => {\r\n                const type = getAddressType(address);\r\n                if (type === \"email\") {\r\n                    const invite: IInvite3PID = {\r\n                        id_server: client.getIdentityServerUrl(true)!,\r\n                        medium: \"email\",\r\n                        address,\r\n                    };\r\n                    roomOptions.invite_3pid.push(invite);\r\n                } else if (type === \"mx-user-id\") {\r\n                    roomOptions.invite.push(address);\r\n                }\r\n                return roomOptions;\r\n            },\r\n            { invite: [], invite_3pid: [] },\r\n        );\r\n    }\r\n\r\n    createRoomOptions.spinner = showSpinner;\r\n    if (createOpts && Object.keys(createOpts).includes(\"andView\")) {\r\n        createRoomOptions.andView = createOpts.andView;\r\n    }    \r\n    return createRoom(client, createRoomOptions);\r\n}\r\n"],"mappings":"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"}