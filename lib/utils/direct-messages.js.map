{"version":3,"file":"direct-messages.js","names":["_client","require","_logger","_createRoom","_actions","_dispatcher","_interopRequireDefault","_LocalRoom","_localRoom","_findDMRoom","_rooms","_createDmLocalRoom","_startDm","_threepids","startDmOnFirstMessage","client","targets","resolvedTargets","resolveThreePids","e","logger","warn","existingRoom","findDMRoom","dis","dispatch","action","Action","ViewRoom","room_id","roomId","should_peek","joining","metricsTrigger","length","ThreepidMember","privateShouldBeEncrypted","startDm","room","createDmLocalRoom","createRoomFromLocalRoom","localRoom","isNew","state","LocalRoomState","CREATING","emit","ClientEvent","Room","then","Error","actualRoomId","waitForRoomReadyAndApplyAfterCreateCallbacks","ERROR","Member","exports","DirectoryMember","constructor","userDirResult","_defineProperty2","default","_userId","user_id","displayName","display_name","avatarUrl","avatar_url","name","userId","getMxcAvatarUrl","id","isEmail","includes","undefined","determineCreateRoomEncryptionOption","has3PidMembers","some","t","targetIds","map","allHaveDeviceKeys","canEncryptToAllUsers"],"sources":["../../src/utils/direct-messages.ts"],"sourcesContent":["/*\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { ClientEvent, MatrixClient } from \"matrix-js-sdk/src/client\";\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\n\r\nimport { canEncryptToAllUsers } from \"../createRoom\";\r\nimport { Action } from \"../dispatcher/actions\";\r\nimport { ViewRoomPayload } from \"../dispatcher/payloads/ViewRoomPayload\";\r\nimport dis from \"../dispatcher/dispatcher\";\r\nimport { LocalRoom, LocalRoomState } from \"../models/LocalRoom\";\r\nimport { waitForRoomReadyAndApplyAfterCreateCallbacks } from \"./local-room\";\r\nimport { findDMRoom } from \"./dm/findDMRoom\";\r\nimport { privateShouldBeEncrypted } from \"./rooms\";\r\nimport { createDmLocalRoom } from \"./dm/createDmLocalRoom\";\r\nimport { startDm } from \"./dm/startDm\";\r\nimport { resolveThreePids } from \"./threepids\";\r\n\r\nexport async function startDmOnFirstMessage(client: MatrixClient, targets: Member[]): Promise<string | null> {\r\n    let resolvedTargets = targets;\r\n\r\n    try {\r\n        resolvedTargets = await resolveThreePids(targets, client);\r\n    } catch (e) {\r\n        logger.warn(\"Error resolving 3rd-party members\", e);\r\n    }\r\n\r\n    const existingRoom = findDMRoom(client, resolvedTargets);\r\n\r\n    if (existingRoom) {\r\n        dis.dispatch<ViewRoomPayload>({\r\n            action: Action.ViewRoom,\r\n            room_id: existingRoom.roomId,\r\n            should_peek: false,\r\n            joining: false,\r\n            metricsTrigger: \"MessageUser\",\r\n        });\r\n        return existingRoom.roomId;\r\n    }\r\n\r\n    if (targets.length === 1 && targets[0] instanceof ThreepidMember && privateShouldBeEncrypted(client)) {\r\n        // Single 3rd-party invite and well-known promotes encryption:\r\n        // Directly create a room and invite the other.\r\n        return await startDm(client, targets);\r\n    }\r\n\r\n    const room = await createDmLocalRoom(client, resolvedTargets);\r\n    dis.dispatch({\r\n        action: Action.ViewRoom,\r\n        room_id: room.roomId,\r\n        joining: false,\r\n        targets: resolvedTargets,\r\n    });\r\n    return room.roomId;\r\n}\r\n\r\n/**\r\n * Starts a DM based on a local room.\r\n *\r\n * @async\r\n * @param {MatrixClient} client\r\n * @param {LocalRoom} localRoom\r\n * @returns {Promise<string | void>} Resolves to the created room id\r\n */\r\nexport async function createRoomFromLocalRoom(client: MatrixClient, localRoom: LocalRoom): Promise<string | void> {\r\n    if (!localRoom.isNew) {\r\n        // This action only makes sense for new local rooms.\r\n        return;\r\n    }\r\n\r\n    localRoom.state = LocalRoomState.CREATING;\r\n    client.emit(ClientEvent.Room, localRoom);\r\n\r\n    return startDm(client, localRoom.targets, false).then(\r\n        (roomId) => {\r\n            if (!roomId) throw new Error(`startDm for local room ${localRoom.roomId} didn't return a room Id`);\r\n\r\n            localRoom.actualRoomId = roomId;\r\n            return waitForRoomReadyAndApplyAfterCreateCallbacks(client, localRoom, roomId);\r\n        },\r\n        () => {\r\n            logger.warn(`Error creating DM for local room ${localRoom.roomId}`);\r\n            localRoom.state = LocalRoomState.ERROR;\r\n            client.emit(ClientEvent.Room, localRoom);\r\n        },\r\n    );\r\n}\r\n\r\n// This is the interface that is expected by various components in the Invite Dialog and RoomInvite.\r\n// It is a bit awkward because it also matches the RoomMember class from the js-sdk with some extra support\r\n// for 3PIDs/email addresses.\r\nexport abstract class Member {\r\n    /**\r\n     * The display name of this Member. For users this should be their profile's display\r\n     * name or user ID if none set. For 3PIDs this should be the 3PID address (email).\r\n     */\r\n    public abstract get name(): string;\r\n\r\n    /**\r\n     * The ID of this Member. For users this should be their user ID. For 3PIDs this should\r\n     * be the 3PID address (email).\r\n     */\r\n    public abstract get userId(): string;\r\n\r\n    /**\r\n     * Gets the MXC URL of this Member's avatar. For users this should be their profile's\r\n     * avatar MXC URL or null if none set. For 3PIDs this should always be undefined.\r\n     */\r\n    public abstract getMxcAvatarUrl(): string | undefined;\r\n}\r\n\r\nexport class DirectoryMember extends Member {\r\n    private readonly _userId: string;\r\n    private readonly displayName?: string;\r\n    private readonly avatarUrl?: string;\r\n\r\n    // eslint-disable-next-line camelcase\r\n    public constructor(userDirResult: { user_id: string; display_name?: string; avatar_url?: string }) {\r\n        super();\r\n        this._userId = userDirResult.user_id;\r\n        this.displayName = userDirResult.display_name;\r\n        this.avatarUrl = userDirResult.avatar_url;\r\n    }\r\n\r\n    // These next class members are for the Member interface\r\n    public get name(): string {\r\n        return this.displayName || this._userId;\r\n    }\r\n\r\n    public get userId(): string {\r\n        return this._userId;\r\n    }\r\n\r\n    public getMxcAvatarUrl(): string | undefined {\r\n        return this.avatarUrl;\r\n    }\r\n}\r\n\r\nexport class ThreepidMember extends Member {\r\n    private readonly id: string;\r\n\r\n    public constructor(id: string) {\r\n        super();\r\n        this.id = id;\r\n    }\r\n\r\n    // This is a getter that would be falsy on all other implementations. Until we have\r\n    // better type support in the react-sdk we can use this trick to determine the kind\r\n    // of 3PID we're dealing with, if any.\r\n    public get isEmail(): boolean {\r\n        return this.id.includes(\"@\");\r\n    }\r\n\r\n    // These next class members are for the Member interface\r\n    public get name(): string {\r\n        return this.id;\r\n    }\r\n\r\n    public get userId(): string {\r\n        return this.id;\r\n    }\r\n\r\n    public getMxcAvatarUrl(): string | undefined {\r\n        return undefined;\r\n    }\r\n}\r\n\r\nexport interface IDMUserTileProps {\r\n    member: Member;\r\n    onRemove?(member: Member): void;\r\n}\r\n\r\n/**\r\n * Detects whether a room should be encrypted.\r\n *\r\n * @async\r\n * @param {MatrixClient} client\r\n * @param {Member[]} targets The members to which run the check against\r\n * @returns {Promise<boolean>}\r\n */\r\nexport async function determineCreateRoomEncryptionOption(client: MatrixClient, targets: Member[]): Promise<boolean> {\r\n    if (privateShouldBeEncrypted(client)) {\r\n        // Enable encryption for a single 3rd party invite.\r\n        if (targets.length === 1 && targets[0] instanceof ThreepidMember) return true;\r\n\r\n        // Check whether all users have uploaded device keys before.\r\n        // If so, enable encryption in the new room.\r\n        const has3PidMembers = targets.some((t) => t instanceof ThreepidMember);\r\n        if (!has3PidMembers) {\r\n            const targetIds = targets.map((t) => t.userId);\r\n            const allHaveDeviceKeys = await canEncryptToAllUsers(client, targetIds);\r\n            if (allHaveDeviceKeys) {\r\n                return true;\r\n            }\r\n        }\r\n    }\r\n\r\n    return false;\r\n}\r\n"],"mappings":"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"}