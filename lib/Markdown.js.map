{"version":3,"file":"Markdown.js","names":["require","commonmark","_interopRequireWildcard","_lodash","_logger","_linkifyMatrix","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","ALLOWED_HTML_TAGS","TEXT_NODES","isAllowedHtmlTag","node","literal","match","matches","exec","length","tag","indexOf","isMultiLine","par","parent","firstChild","lastChild","getTextUntilEndOrLinebreak","currentNode","text","type","n","char","next","formattingChangesByNodeType","emph","strong","innerNodeLiteral","walker","step","currentNodeLiteral","entering","Markdown","constructor","input","_defineProperty2","parser","Parser","parsed","parse","repairLinks","event","isInPara","previousNode","shouldUnlinkFormattingNode","thisPart","nextParts","split","reverse","forEach","part","nextNode","Node","insertAfter","resumeAt","foundLinks","linkify","find","value","format","nonEmphasizedText","f","newText","newLinks","emphasisTextNode","unlink","logger","error","isPlainText","ev","toHTML","externalLinks","arguments","undefined","renderer","HtmlRenderer","safe","softbreak","realParagraph","paragraph","link","attrs","destination","push","esc","title","html_inline","lit","escape","html_block","render","toPlaintext","exports"],"sources":["../src/Markdown.ts"],"sourcesContent":["/*\r\nCopyright 2016 OpenMarket Ltd\r\nCopyright 2021 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport \"./@types/commonmark\"; // import better types than @types/commonmark\r\nimport * as commonmark from \"commonmark\";\r\nimport { escape } from \"lodash\";\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\n\r\nimport { linkify } from \"./linkify-matrix\";\r\n\r\nconst ALLOWED_HTML_TAGS = [\"sub\", \"sup\", \"del\", \"u\"];\r\n\r\n// These types of node are definitely text\r\nconst TEXT_NODES = [\"text\", \"softbreak\", \"linebreak\", \"paragraph\", \"document\"];\r\n\r\nfunction isAllowedHtmlTag(node: commonmark.Node): boolean {\r\n    if (!node.literal) {\r\n        return false;\r\n    }\r\n\r\n    if (node.literal.match('^<((div|span) data-mx-maths=\"[^\"]*\"|/(div|span))>$') != null) {\r\n        return true;\r\n    }\r\n\r\n    // Regex won't work for tags with attrs, but we only\r\n    // allow <del> anyway.\r\n    const matches = /^<\\/?(.*)>$/.exec(node.literal);\r\n    if (matches && matches.length == 2) {\r\n        const tag = matches[1];\r\n        return ALLOWED_HTML_TAGS.indexOf(tag) > -1;\r\n    }\r\n\r\n    return false;\r\n}\r\n\r\n/*\r\n * Returns true if the parse output containing the node\r\n * comprises multiple block level elements (ie. lines),\r\n * or false if it is only a single line.\r\n */\r\nfunction isMultiLine(node: commonmark.Node): boolean {\r\n    let par = node;\r\n    while (par.parent) {\r\n        par = par.parent;\r\n    }\r\n    return par.firstChild != par.lastChild;\r\n}\r\n\r\nfunction getTextUntilEndOrLinebreak(node: commonmark.Node): string {\r\n    let currentNode: commonmark.Node | null = node;\r\n    let text = \"\";\r\n    while (currentNode && currentNode.type !== \"softbreak\" && currentNode.type !== \"linebreak\") {\r\n        const { literal, type } = currentNode;\r\n        if (type === \"text\" && literal) {\r\n            let n = 0;\r\n            let char = literal[n];\r\n            while (char !== \" \" && char !== null && n <= literal.length) {\r\n                if (char === \" \") {\r\n                    break;\r\n                }\r\n                if (char) {\r\n                    text += char;\r\n                }\r\n                n += 1;\r\n                char = literal[n];\r\n            }\r\n            if (char === \" \") {\r\n                break;\r\n            }\r\n        }\r\n        currentNode = currentNode.next;\r\n    }\r\n    return text;\r\n}\r\n\r\nconst formattingChangesByNodeType = {\r\n    emph: \"_\",\r\n    strong: \"__\",\r\n};\r\n\r\n/**\r\n * Returns the literal of a node an all child nodes.\r\n */\r\nconst innerNodeLiteral = (node: commonmark.Node): string => {\r\n    let literal = \"\";\r\n\r\n    const walker = node.walker();\r\n    let step: commonmark.NodeWalkingStep | null;\r\n\r\n    while ((step = walker.next())) {\r\n        const currentNode = step.node;\r\n        const currentNodeLiteral = currentNode.literal;\r\n        if (step.entering && currentNode.type === \"text\" && currentNodeLiteral) {\r\n            literal += currentNodeLiteral;\r\n        }\r\n    }\r\n\r\n    return literal;\r\n};\r\n\r\n/**\r\n * Class that wraps commonmark, adding the ability to see whether\r\n * a given message actually uses any markdown syntax or whether\r\n * it's plain text.\r\n */\r\nexport default class Markdown {\r\n    private input: string;\r\n    private parsed: commonmark.Node;\r\n\r\n    public constructor(input: string) {\r\n        this.input = input;\r\n\r\n        const parser = new commonmark.Parser();\r\n        this.parsed = parser.parse(this.input);\r\n        this.parsed = this.repairLinks(this.parsed);\r\n    }\r\n\r\n    /**\r\n     * This method is modifying the parsed AST in such a way that links are always\r\n     * properly linkified instead of sometimes being wrongly emphasised in case\r\n     * if you were to write a link like the example below:\r\n     * https://my_weird-link_domain.domain.com\r\n     * ^ this link would be parsed to something like this:\r\n     * <a href=\"https://my\">https://my</a><b>weird-link</b><a href=\"https://domain.domain.com\">domain.domain.com</a>\r\n     * This method makes it so the link gets properly modified to a version where it is\r\n     * not emphasised until it actually ends.\r\n     * See: https://github.com/vector-im/element-web/issues/4674\r\n     * @param parsed\r\n     */\r\n    private repairLinks(parsed: commonmark.Node): commonmark.Node {\r\n        const walker = parsed.walker();\r\n        let event: commonmark.NodeWalkingStep | null = null;\r\n        let text = \"\";\r\n        let isInPara = false;\r\n        let previousNode: commonmark.Node | null = null;\r\n        let shouldUnlinkFormattingNode = false;\r\n        while ((event = walker.next())) {\r\n            const { node } = event;\r\n            if (node.type === \"paragraph\") {\r\n                if (event.entering) {\r\n                    isInPara = true;\r\n                } else {\r\n                    isInPara = false;\r\n                }\r\n            }\r\n            if (isInPara) {\r\n                // Clear saved string when line ends\r\n                if (\r\n                    node.type === \"softbreak\" ||\r\n                    node.type === \"linebreak\" ||\r\n                    // Also start calculating the text from the beginning on any spaces\r\n                    (node.type === \"text\" && node.literal === \" \")\r\n                ) {\r\n                    text = \"\";\r\n                    continue;\r\n                }\r\n\r\n                // Break up text nodes on spaces, so that we don't shoot past them without resetting\r\n                if (node.type === \"text\" && node.literal) {\r\n                    const [thisPart, ...nextParts] = node.literal.split(/( )/);\r\n                    node.literal = thisPart;\r\n                    text += thisPart;\r\n\r\n                    // Add the remaining parts as siblings\r\n                    nextParts.reverse().forEach((part) => {\r\n                        if (part) {\r\n                            const nextNode = new commonmark.Node(\"text\");\r\n                            nextNode.literal = part;\r\n                            node.insertAfter(nextNode);\r\n                            // Make the iterator aware of the newly inserted node\r\n                            walker.resumeAt(nextNode, true);\r\n                        }\r\n                    });\r\n                }\r\n\r\n                // We should not do this if previous node was not a textnode, as we can't combine it then.\r\n                if ((node.type === \"emph\" || node.type === \"strong\") && previousNode?.type === \"text\") {\r\n                    if (event.entering) {\r\n                        const foundLinks = linkify.find(text);\r\n                        for (const { value } of foundLinks) {\r\n                            if (node?.firstChild?.literal) {\r\n                                /**\r\n                                 * NOTE: This technically should unlink the emph node and create LINK nodes instead, adding all the next elements as siblings\r\n                                 * but this solution seems to work well and is hopefully slightly easier to understand too\r\n                                 */\r\n                                const format = formattingChangesByNodeType[node.type];\r\n                                const nonEmphasizedText = `${format}${innerNodeLiteral(node)}${format}`;\r\n                                const f = getTextUntilEndOrLinebreak(node);\r\n                                const newText = value + nonEmphasizedText + f;\r\n                                const newLinks = linkify.find(newText);\r\n                                // Should always find only one link here, if it finds more it means that the algorithm is broken\r\n                                if (newLinks.length === 1) {\r\n                                    const emphasisTextNode = new commonmark.Node(\"text\");\r\n                                    emphasisTextNode.literal = nonEmphasizedText;\r\n                                    previousNode.insertAfter(emphasisTextNode);\r\n                                    node.firstChild.literal = \"\";\r\n                                    event = node.walker().next();\r\n                                    if (event) {\r\n                                        // Remove `em` opening and closing nodes\r\n                                        node.unlink();\r\n                                        previousNode.insertAfter(event.node);\r\n                                        shouldUnlinkFormattingNode = true;\r\n                                    }\r\n                                } else {\r\n                                    logger.error(\r\n                                        \"Markdown links escaping found too many links for following text: \",\r\n                                        text,\r\n                                    );\r\n                                    logger.error(\r\n                                        \"Markdown links escaping found too many links for modified text: \",\r\n                                        newText,\r\n                                    );\r\n                                }\r\n                            }\r\n                        }\r\n                    } else {\r\n                        if (shouldUnlinkFormattingNode) {\r\n                            node.unlink();\r\n                            shouldUnlinkFormattingNode = false;\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            previousNode = node;\r\n        }\r\n        return parsed;\r\n    }\r\n\r\n    public isPlainText(): boolean {\r\n        const walker = this.parsed.walker();\r\n\r\n        let ev: commonmark.NodeWalkingStep | null;\r\n        while ((ev = walker.next())) {\r\n            const node = ev.node;\r\n            if (TEXT_NODES.indexOf(node.type) > -1) {\r\n                // definitely text\r\n                continue;\r\n            } else if (node.type == \"html_inline\" || node.type == \"html_block\") {\r\n                // if it's an allowed html tag, we need to render it and therefore\r\n                // we will need to use HTML. If it's not allowed, it's not HTML since\r\n                // we'll just be treating it as text.\r\n                if (isAllowedHtmlTag(node)) {\r\n                    return false;\r\n                }\r\n            } else {\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n\r\n    public toHTML({ externalLinks = false } = {}): string {\r\n        const renderer = new commonmark.HtmlRenderer({\r\n            safe: false,\r\n\r\n            // Set soft breaks to hard HTML breaks: commonmark\r\n            // puts softbreaks in for multiple lines in a blockquote,\r\n            // so if these are just newline characters then the\r\n            // block quote ends up all on one line\r\n            // (https://github.com/vector-im/element-web/issues/3154)\r\n            softbreak: \"<br />\",\r\n        });\r\n\r\n        // Trying to strip out the wrapping <p/> causes a lot more complication\r\n        // than it's worth, i think.  For instance, this code will go and strip\r\n        // out any <p/> tag (no matter where it is in the tree) which doesn't\r\n        // contain \\n's.\r\n        // On the flip side, <p/>s are quite opionated and restricted on where\r\n        // you can nest them.\r\n        //\r\n        // Let's try sending with <p/>s anyway for now, though.\r\n        const realParagraph = renderer.paragraph;\r\n        renderer.paragraph = function (node: commonmark.Node, entering: boolean) {\r\n            // If there is only one top level node, just return the\r\n            // bare text: it's a single line of text and so should be\r\n            // 'inline', rather than unnecessarily wrapped in its own\r\n            // p tag. If, however, we have multiple nodes, each gets\r\n            // its own p tag to keep them as separate paragraphs.\r\n            // However, if it's a blockquote, adds a p tag anyway\r\n            // in order to avoid deviation to commonmark and unexpected\r\n            // results when parsing the formatted HTML.\r\n            if (node.parent?.type === \"block_quote\" || isMultiLine(node)) {\r\n                realParagraph.call(this, node, entering);\r\n            }\r\n        };\r\n\r\n        renderer.link = function (node, entering) {\r\n            const attrs = this.attrs(node);\r\n            if (entering && node.destination) {\r\n                attrs.push([\"href\", this.esc(node.destination)]);\r\n                if (node.title) {\r\n                    attrs.push([\"title\", this.esc(node.title)]);\r\n                }\r\n                // Modified link behaviour to treat them all as external and\r\n                // thus opening in a new tab.\r\n                if (externalLinks) {\r\n                    attrs.push([\"target\", \"_blank\"]);\r\n                    attrs.push([\"rel\", \"noreferrer noopener\"]);\r\n                }\r\n                this.tag(\"a\", attrs);\r\n            } else {\r\n                this.tag(\"/a\");\r\n            }\r\n        };\r\n\r\n        renderer.html_inline = function (node: commonmark.Node) {\r\n            if (node.literal) {\r\n                if (isAllowedHtmlTag(node)) {\r\n                    this.lit(node.literal);\r\n                } else {\r\n                    this.lit(escape(node.literal));\r\n                }\r\n            }\r\n        };\r\n\r\n        renderer.html_block = function (node: commonmark.Node) {\r\n            /*\r\n            // as with `paragraph`, we only insert line breaks\r\n            // if there are multiple lines in the markdown.\r\n            const isMultiLine = is_multi_line(node);\r\n            if (isMultiLine) this.cr();\r\n            */\r\n            renderer.html_inline(node);\r\n            /*\r\n            if (isMultiLine) this.cr();\r\n            */\r\n        };\r\n\r\n        return renderer.render(this.parsed);\r\n    }\r\n\r\n    /*\r\n     * Render the markdown message to plain text. That is, essentially\r\n     * just remove any backslashes escaping what would otherwise be\r\n     * markdown syntax\r\n     * (to fix https://github.com/vector-im/element-web/issues/2870).\r\n     *\r\n     * N.B. this does **NOT** render arbitrary MD to plain text - only MD\r\n     * which has no formatting.  Otherwise it emits HTML(!).\r\n     */\r\n    public toPlaintext(): string {\r\n        const renderer = new commonmark.HtmlRenderer({ safe: false });\r\n\r\n        renderer.paragraph = function (node: commonmark.Node, entering: boolean) {\r\n            // as with toHTML, only append lines to paragraphs if there are\r\n            // multiple paragraphs\r\n            if (isMultiLine(node)) {\r\n                if (!entering && node.next) {\r\n                    this.lit(\"\\n\\n\");\r\n                }\r\n            }\r\n        };\r\n\r\n        renderer.html_block = function (node: commonmark.Node) {\r\n            if (node.literal) this.lit(node.literal);\r\n            if (isMultiLine(node) && node.next) this.lit(\"\\n\\n\");\r\n        };\r\n\r\n        return renderer.render(this.parsed);\r\n    }\r\n}\r\n"],"mappings":"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"}