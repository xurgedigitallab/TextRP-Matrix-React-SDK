{"version":3,"file":"UserActivity.js","names":["_dispatcher","_interopRequireDefault","require","_Timer","CURRENTLY_ACTIVE_THRESHOLD_MS","RECENTLY_ACTIVE_THRESHOLD_MS","UserActivity","constructor","window","document","_defineProperty2","default","e","visibilityState","activeNowTimeout","abort","activeRecentlyTimeout","onUserActivity","event","hasFocus","type","isMouseEvent","screenX","lastScreenX","screenY","lastScreenY","dis","dispatch","action","isRunning","start","runTimersUntilTimeout","attachedActiveNowTimers","restart","attachedActiveRecentlyTimers","Timer","sharedInstance","mxUserActivity","undefined","timeWhileActiveNow","timer","timeWhile","userActiveNow","timeWhileActiveRecently","userActiveRecently","attachedTimers","index","indexOf","push","finished","finally","splice","catch","err","addEventListener","onPageVisibilityChanged","onWindowBlurred","passive","capture","stop","removeEventListener","timeout","forEach","t","_e","startsWith","exports"],"sources":["../src/UserActivity.ts"],"sourcesContent":["/*\r\nCopyright 2015, 2016 OpenMarket Ltd\r\nCopyright 2019 New Vector Ltd\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport dis from \"./dispatcher/dispatcher\";\r\nimport Timer from \"./utils/Timer\";\r\n\r\n// important these are larger than the timeouts of timers\r\n// used with UserActivity.timeWhileActive*,\r\n// such as READ_MARKER_INVIEW_THRESHOLD_MS (timeWhileActiveRecently),\r\n// READ_MARKER_OUTOFVIEW_THRESHOLD_MS (timeWhileActiveRecently),\r\n// READ_RECEIPT_INTERVAL_MS (timeWhileActiveNow) in TimelinePanel\r\n\r\n// 'Under a few seconds'. Must be less than 'RECENTLY_ACTIVE_THRESHOLD_MS'\r\nconst CURRENTLY_ACTIVE_THRESHOLD_MS = 700;\r\n\r\n// 'Under a few minutes'.\r\nconst RECENTLY_ACTIVE_THRESHOLD_MS = 2 * 60 * 1000;\r\n\r\n/**\r\n * This class watches for user activity (moving the mouse or pressing a key)\r\n * and starts/stops attached timers while the user is active.\r\n *\r\n * There are two classes of 'active': 'active now' and 'active recently'\r\n * see doc on the userActive* functions for what these mean.\r\n */\r\nexport default class UserActivity {\r\n    private readonly activeNowTimeout: Timer;\r\n    private readonly activeRecentlyTimeout: Timer;\r\n    private attachedActiveNowTimers: Timer[] = [];\r\n    private attachedActiveRecentlyTimers: Timer[] = [];\r\n    private lastScreenX = 0;\r\n    private lastScreenY = 0;\r\n\r\n    public constructor(private readonly window: Window, private readonly document: Document) {\r\n        this.activeNowTimeout = new Timer(CURRENTLY_ACTIVE_THRESHOLD_MS);\r\n        this.activeRecentlyTimeout = new Timer(RECENTLY_ACTIVE_THRESHOLD_MS);\r\n    }\r\n\r\n    public static sharedInstance(): UserActivity {\r\n        if (window.mxUserActivity === undefined) {\r\n            window.mxUserActivity = new UserActivity(window, document);\r\n        }\r\n        return window.mxUserActivity;\r\n    }\r\n\r\n    /**\r\n     * Runs the given timer while the user is 'active now', aborting when the user is no longer\r\n     * considered currently active.\r\n     * See userActiveNow() for what it means for a user to be 'active'.\r\n     * Can be called multiple times with the same already running timer, which is a NO-OP.\r\n     * Can be called before the user becomes active, in which case it is only started\r\n     * later on when the user does become active.\r\n     * @param {Timer} timer the timer to use\r\n     */\r\n    public timeWhileActiveNow(timer: Timer): void {\r\n        this.timeWhile(timer, this.attachedActiveNowTimers);\r\n        if (this.userActiveNow()) {\r\n            timer.start();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Runs the given timer while the user is 'active' now or recently,\r\n     * aborting when the user becomes inactive.\r\n     * See userActiveRecently() for what it means for a user to be 'active recently'.\r\n     * Can be called multiple times with the same already running timer, which is a NO-OP.\r\n     * Can be called before the user becomes active, in which case it is only started\r\n     * later on when the user does become active.\r\n     * @param {Timer} timer the timer to use\r\n     */\r\n    public timeWhileActiveRecently(timer: Timer): void {\r\n        this.timeWhile(timer, this.attachedActiveRecentlyTimers);\r\n        if (this.userActiveRecently()) {\r\n            timer.start();\r\n        }\r\n    }\r\n\r\n    private timeWhile(timer: Timer, attachedTimers: Timer[]): void {\r\n        // important this happens first\r\n        const index = attachedTimers.indexOf(timer);\r\n        if (index === -1) {\r\n            attachedTimers.push(timer);\r\n            // remove when done or aborted\r\n            timer\r\n                .finished()\r\n                .finally(() => {\r\n                    const index = attachedTimers.indexOf(timer);\r\n                    if (index !== -1) {\r\n                        // should never be -1\r\n                        attachedTimers.splice(index, 1);\r\n                    }\r\n                    // as we fork the promise here,\r\n                    // avoid unhandled rejection warnings\r\n                })\r\n                .catch((err) => {});\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Start listening to user activity\r\n     */\r\n    public start(): void {\r\n        this.document.addEventListener(\"mousedown\", this.onUserActivity);\r\n        this.document.addEventListener(\"mousemove\", this.onUserActivity);\r\n        this.document.addEventListener(\"keydown\", this.onUserActivity);\r\n        this.document.addEventListener(\"visibilitychange\", this.onPageVisibilityChanged);\r\n        this.window.addEventListener(\"blur\", this.onWindowBlurred);\r\n        this.window.addEventListener(\"focus\", this.onUserActivity);\r\n        // can't use document.scroll here because that's only the document\r\n        // itself being scrolled. Need to use addEventListener's useCapture.\r\n        // also this needs to be the wheel event, not scroll, as scroll is\r\n        // fired when the view scrolls down for a new message.\r\n        this.window.addEventListener(\"wheel\", this.onUserActivity, {\r\n            passive: true,\r\n            capture: true,\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Stop tracking user activity\r\n     */\r\n    public stop(): void {\r\n        this.document.removeEventListener(\"mousedown\", this.onUserActivity);\r\n        this.document.removeEventListener(\"mousemove\", this.onUserActivity);\r\n        this.document.removeEventListener(\"keydown\", this.onUserActivity);\r\n        this.window.removeEventListener(\"wheel\", this.onUserActivity, {\r\n            capture: true,\r\n        });\r\n        this.document.removeEventListener(\"visibilitychange\", this.onPageVisibilityChanged);\r\n        this.window.removeEventListener(\"blur\", this.onWindowBlurred);\r\n        this.window.removeEventListener(\"focus\", this.onUserActivity);\r\n    }\r\n\r\n    /**\r\n     * Return true if the user is currently 'active'\r\n     * A user is 'active' while they are interacting with the app and for a very short (<1s)\r\n     * time after that. This is intended to give a strong indication that the app has the\r\n     * user's attention at any given moment.\r\n     * @returns {boolean} true if user is currently 'active'\r\n     */\r\n    public userActiveNow(): boolean {\r\n        return this.activeNowTimeout.isRunning();\r\n    }\r\n\r\n    /**\r\n     * Return true if the user is currently active or has been recently\r\n     * A user is 'active recently' for a longer period of time (~2 mins) after\r\n     * they have been 'active' and while the app still has the focus. This is\r\n     * intended to indicate when the app may still have the user's attention\r\n     * (or they may have gone to make tea and left the window focused).\r\n     * @returns {boolean} true if user has been active recently\r\n     */\r\n    public userActiveRecently(): boolean {\r\n        return this.activeRecentlyTimeout.isRunning();\r\n    }\r\n\r\n    private onPageVisibilityChanged = (e: Event): void => {\r\n        if (this.document.visibilityState === \"hidden\") {\r\n            this.activeNowTimeout.abort();\r\n            this.activeRecentlyTimeout.abort();\r\n        } else {\r\n            this.onUserActivity(e);\r\n        }\r\n    };\r\n\r\n    private onWindowBlurred = (): void => {\r\n        this.activeNowTimeout.abort();\r\n        this.activeRecentlyTimeout.abort();\r\n    };\r\n\r\n    // XXX: exported for tests\r\n    public onUserActivity = (event: Event): void => {\r\n        // ignore anything if the window isn't focused\r\n        if (!this.document.hasFocus()) return;\r\n\r\n        if (event.type === \"mousemove\" && this.isMouseEvent(event)) {\r\n            if (event.screenX === this.lastScreenX && event.screenY === this.lastScreenY) {\r\n                // mouse hasn't actually moved\r\n                return;\r\n            }\r\n            this.lastScreenX = event.screenX;\r\n            this.lastScreenY = event.screenY;\r\n        }\r\n\r\n        dis.dispatch({ action: \"user_activity\" });\r\n        if (!this.activeNowTimeout.isRunning()) {\r\n            this.activeNowTimeout.start();\r\n            dis.dispatch({ action: \"user_activity_start\" });\r\n\r\n            UserActivity.runTimersUntilTimeout(this.attachedActiveNowTimers, this.activeNowTimeout);\r\n        } else {\r\n            this.activeNowTimeout.restart();\r\n        }\r\n\r\n        if (!this.activeRecentlyTimeout.isRunning()) {\r\n            this.activeRecentlyTimeout.start();\r\n\r\n            UserActivity.runTimersUntilTimeout(this.attachedActiveRecentlyTimers, this.activeRecentlyTimeout);\r\n        } else {\r\n            this.activeRecentlyTimeout.restart();\r\n        }\r\n    };\r\n\r\n    private static async runTimersUntilTimeout(attachedTimers: Timer[], timeout: Timer): Promise<void> {\r\n        attachedTimers.forEach((t) => t.start());\r\n        try {\r\n            await timeout.finished();\r\n        } catch (_e) {\r\n            /* aborted */\r\n        }\r\n        attachedTimers.forEach((t) => t.abort());\r\n    }\r\n\r\n    private isMouseEvent(event: Event): event is MouseEvent {\r\n        return event.type.startsWith(\"mouse\");\r\n    }\r\n}\r\n"],"mappings":"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"}