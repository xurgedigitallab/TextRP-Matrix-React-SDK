{"version":3,"file":"range.js","names":["whitespacePredicate","index","offset","part","text","trim","Range","constructor","model","positionA","positionB","arguments","length","undefined","_defineProperty2","default","bIsLarger","compare","_start","_end","_lastStart","_initializedEmpty","moveStartForwards","delta","forwardsWhile","wasInitializedEmpty","setWasEmpty","value","getLastStartingPosition","setLastStartingPosition","position","moveEndBackwards","backwardsWhile","expandBackwardsWhile","predicate","expandForwardsWhile","iteratePartsBetween","startIdx","endIdx","t","substring","replace","parts","newLength","reduce","sum","oldLength","replaceRange","serializedPart","serialize","newPart","partCreator","deserializePart","push","len","start","end","exports"],"sources":["../../src/editor/range.ts"],"sourcesContent":["/*\r\nCopyright 2019 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport EditorModel from \"./model\";\r\nimport DocumentPosition, { Predicate } from \"./position\";\r\nimport { Part } from \"./parts\";\r\n\r\nconst whitespacePredicate: Predicate = (index, offset, part) => {\r\n    return part.text[offset].trim() === \"\";\r\n};\r\n\r\nexport default class Range {\r\n    private _start: DocumentPosition;\r\n    private _end: DocumentPosition;\r\n    private _lastStart: DocumentPosition;\r\n    private _initializedEmpty: boolean;\r\n\r\n    public constructor(public readonly model: EditorModel, positionA: DocumentPosition, positionB = positionA) {\r\n        const bIsLarger = positionA.compare(positionB) < 0;\r\n        this._start = bIsLarger ? positionA : positionB;\r\n        this._end = bIsLarger ? positionB : positionA;\r\n        this._lastStart = this._start;\r\n        this._initializedEmpty = this._start.index === this._end.index && this._start.offset == this._end.offset;\r\n    }\r\n\r\n    public moveStartForwards(delta: number): void {\r\n        this._start = this._start.forwardsWhile(this.model, () => {\r\n            delta -= 1;\r\n            return delta >= 0;\r\n        });\r\n    }\r\n\r\n    public wasInitializedEmpty(): boolean {\r\n        return this._initializedEmpty;\r\n    }\r\n\r\n    public setWasEmpty(value: boolean): void {\r\n        this._initializedEmpty = value;\r\n    }\r\n\r\n    public getLastStartingPosition(): DocumentPosition {\r\n        return this._lastStart;\r\n    }\r\n\r\n    public setLastStartingPosition(position: DocumentPosition): void {\r\n        this._lastStart = position;\r\n    }\r\n\r\n    public moveEndBackwards(delta: number): void {\r\n        this._end = this._end.backwardsWhile(this.model, () => {\r\n            delta -= 1;\r\n            return delta >= 0;\r\n        });\r\n    }\r\n\r\n    public trim(): void {\r\n        if (this.text.trim() === \"\") {\r\n            this._start = this._end;\r\n            return;\r\n        }\r\n        this._start = this._start.forwardsWhile(this.model, whitespacePredicate);\r\n        this._end = this._end.backwardsWhile(this.model, whitespacePredicate);\r\n    }\r\n\r\n    public expandBackwardsWhile(predicate: Predicate): void {\r\n        this._start = this._start.backwardsWhile(this.model, predicate);\r\n    }\r\n\r\n    public expandForwardsWhile(predicate: Predicate): void {\r\n        this._end = this._end.forwardsWhile(this.model, predicate);\r\n    }\r\n\r\n    public get text(): string {\r\n        let text = \"\";\r\n        this._start.iteratePartsBetween(this._end, this.model, (part, startIdx, endIdx) => {\r\n            const t = part.text.substring(startIdx, endIdx);\r\n            text = text + t;\r\n        });\r\n        return text;\r\n    }\r\n\r\n    /**\r\n     * Splits the model at the range boundaries and replaces with the given parts.\r\n     * Should be run inside a `model.transform()` callback.\r\n     * @param {Part[]} parts the parts to replace the range with\r\n     * @return {Number} the net amount of characters added, can be negative.\r\n     */\r\n    public replace(parts: Part[]): number {\r\n        const newLength = parts.reduce((sum, part) => sum + part.text.length, 0);\r\n        let oldLength = 0;\r\n        this._start.iteratePartsBetween(this._end, this.model, (part, startIdx, endIdx) => {\r\n            oldLength += endIdx - startIdx;\r\n        });\r\n        this.model.replaceRange(this._start, this._end, parts);\r\n        return newLength - oldLength;\r\n    }\r\n\r\n    /**\r\n     * Returns a copy of the (partial) parts within the range.\r\n     * For partial parts, only the text is adjusted to the part that intersects with the range.\r\n     */\r\n    public get parts(): Part[] {\r\n        const parts: Part[] = [];\r\n        this._start.iteratePartsBetween(this._end, this.model, (part, startIdx, endIdx) => {\r\n            const serializedPart = part.serialize();\r\n            serializedPart.text = part.text.substring(startIdx, endIdx);\r\n            const newPart = this.model.partCreator.deserializePart(serializedPart);\r\n            if (newPart) parts.push(newPart);\r\n        });\r\n        return parts;\r\n    }\r\n\r\n    public get length(): number {\r\n        let len = 0;\r\n        this._start.iteratePartsBetween(this._end, this.model, (part, startIdx, endIdx) => {\r\n            len += endIdx - startIdx;\r\n        });\r\n        return len;\r\n    }\r\n\r\n    public get start(): DocumentPosition {\r\n        return this._start;\r\n    }\r\n\r\n    public get end(): DocumentPosition {\r\n        return this._end;\r\n    }\r\n}\r\n"],"mappings":"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"}