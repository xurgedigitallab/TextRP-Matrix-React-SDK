{"version":3,"file":"ManagedHybrid.js","names":["_logger","require","_MatrixClientPeg","_WellKnownUtils","_WidgetUtils","_interopRequireDefault","_WidgetLayoutStore","_WidgetEchoStore","_WidgetStore","_SdkConfig","_DMRoomMap","getWidgetBuildUrl","roomId","isDm","DMRoomMap","shared","getUserIdForRoomId","SdkConfig","get","widget_build_url","widget_build_url_ignore_dm","undefined","wellKnown","getCallBehaviourWellKnown","MatrixClientPeg","ignore_dm","isManagedHybridWidgetEnabled","addManagedHybridWidget","cli","room","getRoom","WidgetUtils","canUserModifyWidgets","logger","error","widgetBuildUrl","widgetData","response","fetch","json","e","widget_id","widgetId","widget","widgetContent","layout","widgets","WidgetStore","instance","getApps","existing","some","w","id","WidgetEchoStore","roomHasPendingWidgets","setRoomWidgetContent","WidgetLayoutStore","canCopyLayoutToRoom","installedWidget","find","moveToContainer","container","setContainerHeight","height","copyLayoutToRoom"],"sources":["../../src/widgets/ManagedHybrid.ts"],"sourcesContent":["/*\r\nCopyright 2021 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { IWidget } from \"matrix-widget-api\";\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\n\r\nimport { MatrixClientPeg } from \"../MatrixClientPeg\";\r\nimport { getCallBehaviourWellKnown } from \"../utils/WellKnownUtils\";\r\nimport WidgetUtils from \"../utils/WidgetUtils\";\r\nimport { IStoredLayout, WidgetLayoutStore } from \"../stores/widgets/WidgetLayoutStore\";\r\nimport WidgetEchoStore from \"../stores/WidgetEchoStore\";\r\nimport WidgetStore from \"../stores/WidgetStore\";\r\nimport SdkConfig from \"../SdkConfig\";\r\nimport DMRoomMap from \"../utils/DMRoomMap\";\r\n\r\n/* eslint-disable camelcase */\r\ninterface IManagedHybridWidgetData {\r\n    widget_id: string;\r\n    widget: IWidget;\r\n    layout: IStoredLayout;\r\n}\r\n/* eslint-enable camelcase */\r\n\r\nfunction getWidgetBuildUrl(roomId: string): string | undefined {\r\n    const isDm = !!DMRoomMap.shared().getUserIdForRoomId(roomId);\r\n    if (SdkConfig.get().widget_build_url) {\r\n        if (isDm && SdkConfig.get().widget_build_url_ignore_dm) {\r\n            return undefined;\r\n        }\r\n        return SdkConfig.get().widget_build_url;\r\n    }\r\n\r\n    const wellKnown = getCallBehaviourWellKnown(MatrixClientPeg.get());\r\n    if (isDm && wellKnown?.ignore_dm) {\r\n        return undefined;\r\n    }\r\n    /* eslint-disable-next-line camelcase */\r\n    return wellKnown?.widget_build_url;\r\n}\r\n\r\nexport function isManagedHybridWidgetEnabled(roomId: string): boolean {\r\n    return !!getWidgetBuildUrl(roomId);\r\n}\r\n\r\nexport async function addManagedHybridWidget(roomId: string): Promise<void> {\r\n    const cli = MatrixClientPeg.get();\r\n    const room = cli.getRoom(roomId);\r\n    if (!room) {\r\n        return;\r\n    }\r\n\r\n    // Check for permission\r\n    if (!WidgetUtils.canUserModifyWidgets(cli, roomId)) {\r\n        logger.error(`User not allowed to modify widgets in ${roomId}`);\r\n        return;\r\n    }\r\n\r\n    // Get widget data\r\n    /* eslint-disable-next-line camelcase */\r\n    const widgetBuildUrl = getWidgetBuildUrl(roomId);\r\n    if (!widgetBuildUrl) {\r\n        return;\r\n    }\r\n    let widgetData: IManagedHybridWidgetData;\r\n    try {\r\n        const response = await fetch(`${widgetBuildUrl}?roomId=${roomId}`);\r\n        widgetData = await response.json();\r\n    } catch (e) {\r\n        logger.error(`Managed hybrid widget builder failed for room ${roomId}`, e);\r\n        return;\r\n    }\r\n    if (!widgetData) {\r\n        return;\r\n    }\r\n    const { widget_id: widgetId, widget: widgetContent, layout } = widgetData;\r\n\r\n    // Ensure the widget is not already present in the room\r\n    let widgets = WidgetStore.instance.getApps(roomId);\r\n    const existing = widgets.some((w) => w.id === widgetId) || WidgetEchoStore.roomHasPendingWidgets(roomId, []);\r\n    if (existing) {\r\n        logger.error(`Managed hybrid widget already present in room ${roomId}`);\r\n        return;\r\n    }\r\n\r\n    // Add the widget\r\n    try {\r\n        await WidgetUtils.setRoomWidgetContent(cli, roomId, widgetId, widgetContent);\r\n    } catch (e) {\r\n        logger.error(`Unable to add managed hybrid widget in room ${roomId}`, e);\r\n        return;\r\n    }\r\n\r\n    // Move the widget into position\r\n    if (!WidgetLayoutStore.instance.canCopyLayoutToRoom(room)) {\r\n        return;\r\n    }\r\n    widgets = WidgetStore.instance.getApps(roomId);\r\n    const installedWidget = widgets.find((w) => w.id === widgetId);\r\n    if (!installedWidget) {\r\n        return;\r\n    }\r\n    WidgetLayoutStore.instance.moveToContainer(room, installedWidget, layout.container);\r\n    WidgetLayoutStore.instance.setContainerHeight(room, layout.container, layout.height);\r\n    WidgetLayoutStore.instance.copyLayoutToRoom(room);\r\n}\r\n"],"mappings":"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"}