{"version":3,"file":"ContentMessages.js","names":["_event","require","_matrixEncryptAttachment","_interopRequireDefault","_pngChunksExtract","_logger","_matrix","_thread","_utils","_dispatcher","_languageHandler","_Modal","_Spinner","_actions","_RoomUpload","_SettingsStore","_sendTimePerformanceMetrics","_RoomContext","_Reply","_ErrorDialog","_UploadFailureDialog","_UploadConfirmDialog","_imageMedia","_SendMessageComposer","_localRoom","_SDKContext","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","_defineProperty2","default","getOwnPropertyDescriptors","defineProperties","defineProperty","PHYS_HIDPI","UploadCanceledError","Error","exports","loadImageElement","imageFile","img","Image","objectUrl","URL","createObjectURL","imgPromise","Promise","resolve","reject","onload","revokeObjectURL","onerror","e","src","parsePromise","type","headers","readFileAsArrayBuffer","then","arrayBuffer","buffer","Uint8Array","chunks","extractPngChunks","chunk","name","data","byteLength","every","val","catch","console","error","hidpi","all","width","height","IMAGE_SIZE_THRESHOLD_THUMBNAIL","IMAGE_THUMBNAIL_MIN_REDUCTION_SIZE","IMAGE_THUMBNAIL_MIN_REDUCTION_PERCENT","ALWAYS_INCLUDE_THUMBNAIL","infoForImageFile","matrixClient","roomId","thumbnailType","imageElement","result","createThumbnail","imageInfo","info","includes","sizeDifference","size","thumbnail_info","uploadResult","uploadFile","thumbnail","url","file","loadVideoElement","videoFile","video","document","createElement","preload","playsInline","muted","reader","FileReader","ev","onloadeddata","pause","dataUrl","startsWith","replace","load","play","readAsDataURL","infoForVideoFile","videoInfo","videoWidth","videoHeight","thumbnail_url","thumbnail_file","readAsArrayBuffer","progressHandler","controller","abortController","AbortController","isRoomEncrypted","signal","aborted","encryptResult","encrypt","encryptAttachment","blob","Blob","content_uri","uploadContent","includeFilename","ContentMessages","constructor","sendStickerContentToRoom","threadId","text","doMaybeLocalRoomAction","actualRoomId","sendStickerMessage","logger","warn","getUploadLimit","mediaConfig","undefined","sendContentListToRoom","files","relation","context","TimelineRenderingType","Room","isGuest","dis","dispatch","action","replyToEvent","SdkContextClass","instance","roomViewStore","getQuotingEvent","modal","Modal","createDialog","Spinner","race","ensureMediaConfigFetched","finished","close","tooBigFiles","okFiles","isFileSizeAcceptable","UploadFailureDialog","badFiles","totalFiles","contentMessages","shouldContinue","uploadAll","promBefore","loopPromiseBefore","UploadConfirmDialog","currentIndex","shouldUploadAll","sendContentToRoom","event","Action","FocusSendMessageComposer","getCurrentUploads","inprogress","roomUpload","noRelation","matchingRelation","rel_type","event_id","cancelled","cancelUpload","upload","abort","UploadCanceled","fileName","_t","content","body","msgtype","MsgType","File","attachMentions","getSafeUserId","attachRelation","addReplyToMessageContent","includeLegacyFallback","SettingsStore","getValue","decorateStartSendingTime","mimetype","RoomUpload","UploadStarted","onProgress","progress","UploadProgress","assign","HTTPError","indexOf","Audio","Video","THREAD_RELATION_TYPE","response","sendMessage","sendRoundTripMetric","UploadFinished","httpStatus","desc","ErrorDialog","title","description","UploadFailed","removeElement","promise","log","getMediaConfig","config","sharedInstance","window","mxContentMessages"],"sources":["../src/ContentMessages.ts"],"sourcesContent":["/*\r\nCopyright 2015, 2016 OpenMarket Ltd\r\nCopyright 2019 New Vector Ltd\r\nCopyright 2020 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { MatrixClient } from \"matrix-js-sdk/src/client\";\r\nimport { MsgType } from \"matrix-js-sdk/src/@types/event\";\r\nimport encrypt from \"matrix-encrypt-attachment\";\r\nimport extractPngChunks from \"png-chunks-extract\";\r\nimport { IImageInfo } from \"matrix-js-sdk/src/@types/partials\";\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\nimport {\r\n    HTTPError,\r\n    IEventRelation,\r\n    ISendEventResponse,\r\n    MatrixEvent,\r\n    UploadOpts,\r\n    UploadProgress,\r\n} from \"matrix-js-sdk/src/matrix\";\r\nimport { THREAD_RELATION_TYPE } from \"matrix-js-sdk/src/models/thread\";\r\nimport { removeElement } from \"matrix-js-sdk/src/utils\";\r\n\r\nimport { IEncryptedFile, IMediaEventContent, IMediaEventInfo } from \"./customisations/models/IMediaEventContent\";\r\nimport dis from \"./dispatcher/dispatcher\";\r\nimport { _t } from \"./languageHandler\";\r\nimport Modal from \"./Modal\";\r\nimport Spinner from \"./components/views/elements/Spinner\";\r\nimport { Action } from \"./dispatcher/actions\";\r\nimport {\r\n    UploadCanceledPayload,\r\n    UploadErrorPayload,\r\n    UploadFinishedPayload,\r\n    UploadProgressPayload,\r\n    UploadStartedPayload,\r\n} from \"./dispatcher/payloads/UploadPayload\";\r\nimport { RoomUpload } from \"./models/RoomUpload\";\r\nimport SettingsStore from \"./settings/SettingsStore\";\r\nimport { decorateStartSendingTime, sendRoundTripMetric } from \"./sendTimePerformanceMetrics\";\r\nimport { TimelineRenderingType } from \"./contexts/RoomContext\";\r\nimport { addReplyToMessageContent } from \"./utils/Reply\";\r\nimport ErrorDialog from \"./components/views/dialogs/ErrorDialog\";\r\nimport UploadFailureDialog from \"./components/views/dialogs/UploadFailureDialog\";\r\nimport UploadConfirmDialog from \"./components/views/dialogs/UploadConfirmDialog\";\r\nimport { createThumbnail } from \"./utils/image-media\";\r\nimport { attachMentions, attachRelation } from \"./components/views/rooms/SendMessageComposer\";\r\nimport { doMaybeLocalRoomAction } from \"./utils/local-room\";\r\nimport { SdkContextClass } from \"./contexts/SDKContext\";\r\n\r\n// scraped out of a macOS hidpi (5660ppm) screenshot png\r\n//                  5669 px (x-axis)      , 5669 px (y-axis)      , per metre\r\nconst PHYS_HIDPI = [0x00, 0x00, 0x16, 0x25, 0x00, 0x00, 0x16, 0x25, 0x01];\r\n\r\nexport class UploadCanceledError extends Error {}\r\n\r\ninterface IMediaConfig {\r\n    \"m.upload.size\"?: number;\r\n}\r\n\r\n/**\r\n * Load a file into a newly created image element.\r\n *\r\n * @param {File} imageFile The file to load in an image element.\r\n * @return {Promise} A promise that resolves with the html image element.\r\n */\r\nasync function loadImageElement(imageFile: File): Promise<{\r\n    width: number;\r\n    height: number;\r\n    img: HTMLImageElement;\r\n}> {\r\n    // Load the file into an html element\r\n    const img = new Image();\r\n    const objectUrl = URL.createObjectURL(imageFile);\r\n    const imgPromise = new Promise((resolve, reject) => {\r\n        img.onload = function (): void {\r\n            URL.revokeObjectURL(objectUrl);\r\n            resolve(img);\r\n        };\r\n        img.onerror = function (e): void {\r\n            reject(e);\r\n        };\r\n    });\r\n    img.src = objectUrl;\r\n\r\n    // check for hi-dpi PNGs and fudge display resolution as needed.\r\n    // this is mainly needed for macOS screencaps\r\n    let parsePromise = Promise.resolve(false);\r\n    if (imageFile.type === \"image/png\") {\r\n        // in practice macOS happens to order the chunks so they fall in\r\n        // the first 0x1000 bytes (thanks to a massive ICC header).\r\n        // Thus we could slice the file down to only sniff the first 0x1000\r\n        // bytes (but this makes extractPngChunks choke on the corrupt file)\r\n        const headers = imageFile; //.slice(0, 0x1000);\r\n        parsePromise = readFileAsArrayBuffer(headers)\r\n            .then((arrayBuffer) => {\r\n                const buffer = new Uint8Array(arrayBuffer);\r\n                const chunks = extractPngChunks(buffer);\r\n                for (const chunk of chunks) {\r\n                    if (chunk.name === \"pHYs\") {\r\n                        if (chunk.data.byteLength !== PHYS_HIDPI.length) return false;\r\n                        return chunk.data.every((val, i) => val === PHYS_HIDPI[i]);\r\n                    }\r\n                }\r\n                return false;\r\n            })\r\n            .catch((e) => {\r\n                console.error(\"Failed to parse PNG\", e);\r\n                return false;\r\n            });\r\n    }\r\n\r\n    const [hidpi] = await Promise.all([parsePromise, imgPromise]);\r\n    const width = hidpi ? img.width >> 1 : img.width;\r\n    const height = hidpi ? img.height >> 1 : img.height;\r\n    return { width, height, img };\r\n}\r\n\r\n// Minimum size for image files before we generate a thumbnail for them.\r\nconst IMAGE_SIZE_THRESHOLD_THUMBNAIL = 1 << 15; // 32KB\r\n// Minimum size improvement for image thumbnails, if both are not met then don't bother uploading thumbnail.\r\nconst IMAGE_THUMBNAIL_MIN_REDUCTION_SIZE = 1 << 16; // 1MB\r\nconst IMAGE_THUMBNAIL_MIN_REDUCTION_PERCENT = 0.1; // 10%\r\n// We don't apply these thresholds to video thumbnails as a poster image is always useful\r\n// and videos tend to be much larger.\r\n\r\n// Image mime types for which to always include a thumbnail for even if it is larger than the input for wider support.\r\nconst ALWAYS_INCLUDE_THUMBNAIL = [\"image/avif\", \"image/webp\"];\r\n\r\n/**\r\n * Read the metadata for an image file and create and upload a thumbnail of the image.\r\n *\r\n * @param {MatrixClient} matrixClient A matrixClient to upload the thumbnail with.\r\n * @param {String} roomId The ID of the room the image will be uploaded in.\r\n * @param {File} imageFile The image to read and thumbnail.\r\n * @return {Promise} A promise that resolves with the attachment info.\r\n */\r\nasync function infoForImageFile(\r\n    matrixClient: MatrixClient,\r\n    roomId: string,\r\n    imageFile: File,\r\n): Promise<Partial<IMediaEventInfo>> {\r\n    let thumbnailType = \"image/png\";\r\n    if (imageFile.type === \"image/jpeg\") {\r\n        thumbnailType = \"image/jpeg\";\r\n    }\r\n\r\n    const imageElement = await loadImageElement(imageFile);\r\n\r\n    const result = await createThumbnail(imageElement.img, imageElement.width, imageElement.height, thumbnailType);\r\n    const imageInfo = result.info;\r\n\r\n    // For lesser supported image types, always include the thumbnail even if it is larger\r\n    if (!ALWAYS_INCLUDE_THUMBNAIL.includes(imageFile.type)) {\r\n        // we do all sizing checks here because we still rely on thumbnail generation for making a blurhash from.\r\n        const sizeDifference = imageFile.size - imageInfo.thumbnail_info!.size;\r\n        if (\r\n            // image is small enough already\r\n            imageFile.size <= IMAGE_SIZE_THRESHOLD_THUMBNAIL ||\r\n            // thumbnail is not sufficiently smaller than original\r\n            (sizeDifference <= IMAGE_THUMBNAIL_MIN_REDUCTION_SIZE &&\r\n                sizeDifference <= imageFile.size * IMAGE_THUMBNAIL_MIN_REDUCTION_PERCENT)\r\n        ) {\r\n            delete imageInfo[\"thumbnail_info\"];\r\n            return imageInfo;\r\n        }\r\n    }\r\n\r\n    const uploadResult = await uploadFile(matrixClient, roomId, result.thumbnail);\r\n\r\n    imageInfo[\"thumbnail_url\"] = uploadResult.url;\r\n    imageInfo[\"thumbnail_file\"] = uploadResult.file;\r\n    return imageInfo;\r\n}\r\n\r\n/**\r\n * Load a file into a newly created video element and pull some strings\r\n * in an attempt to guarantee the first frame will be showing.\r\n *\r\n * @param {File} videoFile The file to load in an video element.\r\n * @return {Promise} A promise that resolves with the video image element.\r\n */\r\nfunction loadVideoElement(videoFile: File): Promise<HTMLVideoElement> {\r\n    return new Promise((resolve, reject) => {\r\n        // Load the file into an html element\r\n        const video = document.createElement(\"video\");\r\n        video.preload = \"metadata\";\r\n        video.playsInline = true;\r\n        video.muted = true;\r\n\r\n        const reader = new FileReader();\r\n\r\n        reader.onload = function (ev): void {\r\n            // Wait until we have enough data to thumbnail the first frame.\r\n            video.onloadeddata = async function (): Promise<void> {\r\n                resolve(video);\r\n                video.pause();\r\n            };\r\n            video.onerror = function (e): void {\r\n                reject(e);\r\n            };\r\n\r\n            let dataUrl = ev.target?.result as string;\r\n            // Chrome chokes on quicktime but likes mp4, and `file.type` is\r\n            // read only, so do this horrible hack to unbreak quicktime\r\n            if (dataUrl?.startsWith(\"data:video/quicktime;\")) {\r\n                dataUrl = dataUrl.replace(\"data:video/quicktime;\", \"data:video/mp4;\");\r\n            }\r\n\r\n            video.src = dataUrl;\r\n            video.load();\r\n            video.play();\r\n        };\r\n        reader.onerror = function (e): void {\r\n            reject(e);\r\n        };\r\n        reader.readAsDataURL(videoFile);\r\n    });\r\n}\r\n\r\n/**\r\n * Read the metadata for a video file and create and upload a thumbnail of the video.\r\n *\r\n * @param {MatrixClient} matrixClient A matrixClient to upload the thumbnail with.\r\n * @param {String} roomId The ID of the room the video will be uploaded to.\r\n * @param {File} videoFile The video to read and thumbnail.\r\n * @return {Promise} A promise that resolves with the attachment info.\r\n */\r\nfunction infoForVideoFile(\r\n    matrixClient: MatrixClient,\r\n    roomId: string,\r\n    videoFile: File,\r\n): Promise<Partial<IMediaEventInfo>> {\r\n    const thumbnailType = \"image/jpeg\";\r\n\r\n    let videoInfo: Partial<IMediaEventInfo>;\r\n    return loadVideoElement(videoFile)\r\n        .then((video) => {\r\n            return createThumbnail(video, video.videoWidth, video.videoHeight, thumbnailType);\r\n        })\r\n        .then((result) => {\r\n            videoInfo = result.info;\r\n            return uploadFile(matrixClient, roomId, result.thumbnail);\r\n        })\r\n        .then((result) => {\r\n            videoInfo.thumbnail_url = result.url;\r\n            videoInfo.thumbnail_file = result.file;\r\n            return videoInfo;\r\n        });\r\n}\r\n\r\n/**\r\n * Read the file as an ArrayBuffer.\r\n * @param {File} file The file to read\r\n * @return {Promise} A promise that resolves with an ArrayBuffer when the file\r\n *   is read.\r\n */\r\nfunction readFileAsArrayBuffer(file: File | Blob): Promise<ArrayBuffer> {\r\n    return new Promise((resolve, reject) => {\r\n        const reader = new FileReader();\r\n        reader.onload = function (e): void {\r\n            resolve(e.target?.result as ArrayBuffer);\r\n        };\r\n        reader.onerror = function (e): void {\r\n            reject(e);\r\n        };\r\n        reader.readAsArrayBuffer(file);\r\n    });\r\n}\r\n\r\n/**\r\n * Upload the file to the content repository.\r\n * If the room is encrypted then encrypt the file before uploading.\r\n *\r\n * @param {MatrixClient} matrixClient The matrix client to upload the file with.\r\n * @param {String} roomId The ID of the room being uploaded to.\r\n * @param {File} file The file to upload.\r\n * @param {Function?} progressHandler optional callback to be called when a chunk of\r\n *    data is uploaded.\r\n * @param {AbortController?} controller optional abortController to use for this upload.\r\n * @return {Promise} A promise that resolves with an object.\r\n *  If the file is unencrypted then the object will have a \"url\" key.\r\n *  If the file is encrypted then the object will have a \"file\" key.\r\n */\r\nexport async function uploadFile(\r\n    matrixClient: MatrixClient,\r\n    roomId: string,\r\n    file: File | Blob,\r\n    progressHandler?: UploadOpts[\"progressHandler\"],\r\n    controller?: AbortController,\r\n): Promise<{ url?: string; file?: IEncryptedFile }> {\r\n    const abortController = controller ?? new AbortController();\r\n\r\n    // If the room is encrypted then encrypt the file before uploading it.\r\n    if (matrixClient.isRoomEncrypted(roomId)) {\r\n        // First read the file into memory.\r\n        const data = await readFileAsArrayBuffer(file);\r\n        if (abortController.signal.aborted) throw new UploadCanceledError();\r\n\r\n        // Then encrypt the file.\r\n        const encryptResult = await encrypt.encryptAttachment(data);\r\n        if (abortController.signal.aborted) throw new UploadCanceledError();\r\n\r\n        // Pass the encrypted data as a Blob to the uploader.\r\n        const blob = new Blob([encryptResult.data]);\r\n\r\n        const { content_uri: url } = await matrixClient.uploadContent(blob, {\r\n            progressHandler,\r\n            abortController,\r\n            includeFilename: false,\r\n            type: \"application/octet-stream\",\r\n        });\r\n        if (abortController.signal.aborted) throw new UploadCanceledError();\r\n\r\n        // If the attachment is encrypted then bundle the URL along with the information\r\n        // needed to decrypt the attachment and add it under a file key.\r\n        return {\r\n            file: {\r\n                ...encryptResult.info,\r\n                url,\r\n            } as IEncryptedFile,\r\n        };\r\n    } else {\r\n        const { content_uri: url } = await matrixClient.uploadContent(file, { progressHandler, abortController });\r\n        if (abortController.signal.aborted) throw new UploadCanceledError();\r\n        // If the attachment isn't encrypted then include the URL directly.\r\n        return { url };\r\n    }\r\n}\r\n\r\nexport default class ContentMessages {\r\n    private inprogress: RoomUpload[] = [];\r\n    private mediaConfig: IMediaConfig | null = null;\r\n\r\n    public sendStickerContentToRoom(\r\n        url: string,\r\n        roomId: string,\r\n        threadId: string | null,\r\n        info: IImageInfo,\r\n        text: string,\r\n        matrixClient: MatrixClient,\r\n    ): Promise<ISendEventResponse> {\r\n        return doMaybeLocalRoomAction(\r\n            roomId,\r\n            (actualRoomId: string) => matrixClient.sendStickerMessage(actualRoomId, threadId, url, info, text),\r\n            matrixClient,\r\n        ).catch((e) => {\r\n            logger.warn(`Failed to send content with URL ${url} to room ${roomId}`, e);\r\n            throw e;\r\n        });\r\n    }\r\n\r\n    public getUploadLimit(): number | null {\r\n        if (this.mediaConfig !== null && this.mediaConfig[\"m.upload.size\"] !== undefined) {\r\n            return this.mediaConfig[\"m.upload.size\"];\r\n        } else {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    public async sendContentListToRoom(\r\n        files: File[],\r\n        roomId: string,\r\n        relation: IEventRelation | undefined,\r\n        matrixClient: MatrixClient,\r\n        context = TimelineRenderingType.Room,\r\n    ): Promise<void> {\r\n        if (matrixClient.isGuest()) {\r\n            dis.dispatch({ action: \"require_registration\" });\r\n            return;\r\n        }\r\n\r\n        const replyToEvent = SdkContextClass.instance.roomViewStore.getQuotingEvent();\r\n        if (!this.mediaConfig) {\r\n            // hot-path optimization to not flash a spinner if we don't need to\r\n            const modal = Modal.createDialog(Spinner, undefined, \"mx_Dialog_spinner\");\r\n            await Promise.race([this.ensureMediaConfigFetched(matrixClient), modal.finished]);\r\n            if (!this.mediaConfig) {\r\n                // User cancelled by clicking away on the spinner\r\n                return;\r\n            } else {\r\n                modal.close();\r\n            }\r\n        }\r\n\r\n        const tooBigFiles: File[] = [];\r\n        const okFiles: File[] = [];\r\n\r\n        for (const file of files) {\r\n            if (this.isFileSizeAcceptable(file)) {\r\n                okFiles.push(file);\r\n            } else {\r\n                tooBigFiles.push(file);\r\n            }\r\n        }\r\n\r\n        if (tooBigFiles.length > 0) {\r\n            const { finished } = Modal.createDialog(UploadFailureDialog, {\r\n                badFiles: tooBigFiles,\r\n                totalFiles: files.length,\r\n                contentMessages: this,\r\n            });\r\n            const [shouldContinue] = await finished;\r\n            if (!shouldContinue) return;\r\n        }\r\n\r\n        let uploadAll = false;\r\n        // Promise to complete before sending next file into room, used for synchronisation of file-sending\r\n        // to match the order the files were specified in\r\n        let promBefore: Promise<any> = Promise.resolve();\r\n        for (let i = 0; i < okFiles.length; ++i) {\r\n            const file = okFiles[i];\r\n            const loopPromiseBefore = promBefore;\r\n\r\n            if (!uploadAll) {\r\n                const { finished } = Modal.createDialog(UploadConfirmDialog, {\r\n                    file,\r\n                    currentIndex: i,\r\n                    totalFiles: okFiles.length,\r\n                });\r\n                const [shouldContinue, shouldUploadAll] = await finished;\r\n                if (!shouldContinue) break;\r\n                if (shouldUploadAll) {\r\n                    uploadAll = true;\r\n                }\r\n            }\r\n\r\n            promBefore = doMaybeLocalRoomAction(\r\n                roomId,\r\n                (actualRoomId) =>\r\n                    this.sendContentToRoom(\r\n                        file,\r\n                        actualRoomId,\r\n                        relation,\r\n                        matrixClient,\r\n                        replyToEvent ?? undefined,\r\n                        loopPromiseBefore,\r\n                    ),\r\n                matrixClient,\r\n            );\r\n        }\r\n\r\n        if (replyToEvent) {\r\n            // Clear event being replied to\r\n            dis.dispatch({\r\n                action: \"reply_to_event\",\r\n                event: null,\r\n                context,\r\n            });\r\n        }\r\n\r\n        // Focus the correct composer\r\n        dis.dispatch({\r\n            action: Action.FocusSendMessageComposer,\r\n            context,\r\n        });\r\n    }\r\n\r\n    public getCurrentUploads(relation?: IEventRelation): RoomUpload[] {\r\n        return this.inprogress.filter((roomUpload) => {\r\n            const noRelation = !relation && !roomUpload.relation;\r\n            const matchingRelation =\r\n                relation &&\r\n                roomUpload.relation &&\r\n                relation.rel_type === roomUpload.relation.rel_type &&\r\n                relation.event_id === roomUpload.relation.event_id;\r\n\r\n            return (noRelation || matchingRelation) && !roomUpload.cancelled;\r\n        });\r\n    }\r\n\r\n    public cancelUpload(upload: RoomUpload): void {\r\n        upload.abort();\r\n        dis.dispatch<UploadCanceledPayload>({ action: Action.UploadCanceled, upload });\r\n    }\r\n\r\n    public async sendContentToRoom(\r\n        file: File,\r\n        roomId: string,\r\n        relation: IEventRelation | undefined,\r\n        matrixClient: MatrixClient,\r\n        replyToEvent: MatrixEvent | undefined,\r\n        promBefore?: Promise<any>,\r\n    ): Promise<void> {\r\n        const fileName = file.name || _t(\"Attachment\");\r\n        const content: Omit<IMediaEventContent, \"info\"> & { info: Partial<IMediaEventInfo> } = {\r\n            body: fileName,\r\n            info: {\r\n                size: file.size,\r\n            },\r\n            msgtype: MsgType.File, // set more specifically later\r\n        };\r\n\r\n        // Attach mentions, which really only applies if there's a replyToEvent.\r\n        attachMentions(matrixClient.getSafeUserId(), content, null, replyToEvent);\r\n        attachRelation(content, relation);\r\n        if (replyToEvent) {\r\n            addReplyToMessageContent(content, replyToEvent, {\r\n                includeLegacyFallback: false,\r\n            });\r\n        }\r\n\r\n        if (SettingsStore.getValue(\"Performance.addSendMessageTimingMetadata\")) {\r\n            decorateStartSendingTime(content);\r\n        }\r\n\r\n        // if we have a mime type for the file, add it to the message metadata\r\n        if (file.type) {\r\n            content.info.mimetype = file.type;\r\n        }\r\n\r\n        const upload = new RoomUpload(roomId, fileName, relation, file.size);\r\n        this.inprogress.push(upload);\r\n        dis.dispatch<UploadStartedPayload>({ action: Action.UploadStarted, upload });\r\n\r\n        function onProgress(progress: UploadProgress): void {\r\n            upload.onProgress(progress);\r\n            dis.dispatch<UploadProgressPayload>({ action: Action.UploadProgress, upload });\r\n        }\r\n\r\n        try {\r\n            if (file.type.startsWith(\"image/\")) {\r\n                content.msgtype = MsgType.Image;\r\n                try {\r\n                    const imageInfo = await infoForImageFile(matrixClient, roomId, file);\r\n                    Object.assign(content.info, imageInfo);\r\n                } catch (e) {\r\n                    if (e instanceof HTTPError) {\r\n                        // re-throw to main upload error handler\r\n                        throw e;\r\n                    }\r\n                    // Otherwise we failed to thumbnail, fall back to uploading an m.file\r\n                    logger.error(e);\r\n                    content.msgtype = MsgType.File;\r\n                }\r\n            } else if (file.type.indexOf(\"audio/\") === 0) {\r\n                content.msgtype = MsgType.Audio;\r\n            } else if (file.type.indexOf(\"video/\") === 0) {\r\n                content.msgtype = MsgType.Video;\r\n                try {\r\n                    const videoInfo = await infoForVideoFile(matrixClient, roomId, file);\r\n                    Object.assign(content.info, videoInfo);\r\n                } catch (e) {\r\n                    // Failed to thumbnail, fall back to uploading an m.file\r\n                    logger.error(e);\r\n                    content.msgtype = MsgType.File;\r\n                }\r\n            } else {\r\n                content.msgtype = MsgType.File;\r\n            }\r\n\r\n            if (upload.cancelled) throw new UploadCanceledError();\r\n            const result = await uploadFile(matrixClient, roomId, file, onProgress, upload.abortController);\r\n            content.file = result.file;\r\n            content.url = result.url;\r\n\r\n            if (upload.cancelled) throw new UploadCanceledError();\r\n            // Await previous message being sent into the room\r\n            if (promBefore) await promBefore;\r\n\r\n            if (upload.cancelled) throw new UploadCanceledError();\r\n            const threadId = relation?.rel_type === THREAD_RELATION_TYPE.name ? relation.event_id : null;\r\n\r\n            const response = await matrixClient.sendMessage(roomId, threadId ?? null, content);\r\n\r\n            if (SettingsStore.getValue(\"Performance.addSendMessageTimingMetadata\")) {\r\n                sendRoundTripMetric(matrixClient, roomId, response.event_id);\r\n            }\r\n\r\n            dis.dispatch<UploadFinishedPayload>({ action: Action.UploadFinished, upload });\r\n            dis.dispatch({ action: \"message_sent\" });\r\n        } catch (error) {\r\n            // 413: File was too big or upset the server in some way:\r\n            // clear the media size limit so we fetch it again next time we try to upload\r\n            if (error instanceof HTTPError && error.httpStatus === 413) {\r\n                this.mediaConfig = null;\r\n            }\r\n\r\n            if (!upload.cancelled) {\r\n                let desc = _t(\"The file '%(fileName)s' failed to upload.\", { fileName: upload.fileName });\r\n                if (error instanceof HTTPError && error.httpStatus === 413) {\r\n                    desc = _t(\"The file '%(fileName)s' exceeds this homeserver's size limit for uploads\", {\r\n                        fileName: upload.fileName,\r\n                    });\r\n                }\r\n                Modal.createDialog(ErrorDialog, {\r\n                    title: _t(\"Upload Failed\"),\r\n                    description: desc,\r\n                });\r\n                dis.dispatch<UploadErrorPayload>({ action: Action.UploadFailed, upload, error });\r\n            }\r\n        } finally {\r\n            removeElement(this.inprogress, (e) => e.promise === upload.promise);\r\n        }\r\n    }\r\n\r\n    private isFileSizeAcceptable(file: File): boolean {\r\n        if (\r\n            this.mediaConfig !== null &&\r\n            this.mediaConfig[\"m.upload.size\"] !== undefined &&\r\n            file.size > this.mediaConfig[\"m.upload.size\"]\r\n        ) {\r\n            return false;\r\n        }\r\n        return true;\r\n    }\r\n\r\n    private ensureMediaConfigFetched(matrixClient: MatrixClient): Promise<void> {\r\n        if (this.mediaConfig !== null) return Promise.resolve();\r\n\r\n        logger.log(\"[Media Config] Fetching\");\r\n        return matrixClient\r\n            .getMediaConfig()\r\n            .then((config) => {\r\n                logger.log(\"[Media Config] Fetched config:\", config);\r\n                return config;\r\n            })\r\n            .catch(() => {\r\n                // Media repo can't or won't report limits, so provide an empty object (no limits).\r\n                logger.log(\"[Media Config] Could not fetch config, so not limiting uploads.\");\r\n                return {};\r\n            })\r\n            .then((config) => {\r\n                this.mediaConfig = config;\r\n            });\r\n    }\r\n\r\n    public static sharedInstance(): ContentMessages {\r\n        if (window.mxContentMessages === undefined) {\r\n            window.mxContentMessages = new ContentMessages();\r\n        }\r\n        return window.mxContentMessages;\r\n    }\r\n}\r\n"],"mappings":"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"}