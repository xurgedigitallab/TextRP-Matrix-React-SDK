{"version":3,"file":"createMessageContent.js","names":["_matrixWysiwyg","require","_matrix","_SettingsStore","_interopRequireDefault","_Reply","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","_defineProperty2","default","getOwnPropertyDescriptors","defineProperties","defineProperty","EMOTE_PREFIX","exports","attachRelation","content","relation","getHtmlReplyFallback","mxEvent","html","getContent","formatted_body","rootNode","DOMParser","parseFromString","body","mxReply","querySelector","outerHTML","getTextReplyFallback","lines","split","map","l","trim","startsWith","isMatrixEvent","e","MatrixEvent","createMessageContent","message","isHTML","_ref","replyToEvent","permalinkCreator","includeReplyLegacyFallback","editedEvent","isEditing","isReply","Boolean","replyEventId","isReplyAndEditing","isEmote","slice","richToPlain","bodyPrefix","formattedBodyPrefix","msgtype","MsgType","Emote","Text","isMarkdownEnabled","SettingsStore","getValue","formattedBody","plainToRich","format","newRelation","rel_type","event_id","getId","addReplyToMessageContent","includeLegacyFallback"],"sources":["../../../../../../src/components/views/rooms/wysiwyg_composer/utils/createMessageContent.ts"],"sourcesContent":["/*\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { richToPlain, plainToRich } from \"@matrix-org/matrix-wysiwyg\";\r\nimport { IContent, IEventRelation, MatrixEvent, MsgType } from \"matrix-js-sdk/src/matrix\";\r\n\r\nimport SettingsStore from \"../../../../../settings/SettingsStore\";\r\nimport { RoomPermalinkCreator } from \"../../../../../utils/permalinks/Permalinks\";\r\nimport { addReplyToMessageContent } from \"../../../../../utils/Reply\";\r\n\r\nexport const EMOTE_PREFIX = \"/me \";\r\n\r\n// Merges favouring the given relation\r\nfunction attachRelation(content: IContent, relation?: IEventRelation): void {\r\n    if (relation) {\r\n        content[\"m.relates_to\"] = {\r\n            ...(content[\"m.relates_to\"] || {}),\r\n            ...relation,\r\n        };\r\n    }\r\n}\r\n\r\nfunction getHtmlReplyFallback(mxEvent: MatrixEvent): string {\r\n    const html = mxEvent.getContent().formatted_body;\r\n    if (!html) {\r\n        return \"\";\r\n    }\r\n    const rootNode = new DOMParser().parseFromString(html, \"text/html\").body;\r\n    const mxReply = rootNode.querySelector(\"mx-reply\");\r\n    return (mxReply && mxReply.outerHTML) || \"\";\r\n}\r\n\r\nfunction getTextReplyFallback(mxEvent: MatrixEvent): string {\r\n    const body = mxEvent.getContent().body;\r\n    if (typeof body !== \"string\") {\r\n        return \"\";\r\n    }\r\n    const lines = body.split(\"\\n\").map((l) => l.trim());\r\n    if (lines.length > 2 && lines[0].startsWith(\"> \") && lines[1].length === 0) {\r\n        return `${lines[0]}\\n\\n`;\r\n    }\r\n    return \"\";\r\n}\r\n\r\ninterface CreateMessageContentParams {\r\n    relation?: IEventRelation;\r\n    replyToEvent?: MatrixEvent;\r\n    permalinkCreator?: RoomPermalinkCreator;\r\n    includeReplyLegacyFallback?: boolean;\r\n    editedEvent?: MatrixEvent;\r\n}\r\n\r\nconst isMatrixEvent = (e: MatrixEvent | undefined): e is MatrixEvent => e instanceof MatrixEvent;\r\n\r\nexport async function createMessageContent(\r\n    message: string,\r\n    isHTML: boolean,\r\n    {\r\n        relation,\r\n        replyToEvent,\r\n        permalinkCreator,\r\n        includeReplyLegacyFallback = true,\r\n        editedEvent,\r\n    }: CreateMessageContentParams,\r\n): Promise<IContent> {\r\n    const isEditing = isMatrixEvent(editedEvent);\r\n    const isReply = isEditing ? Boolean(editedEvent.replyEventId) : isMatrixEvent(replyToEvent);\r\n    const isReplyAndEditing = isEditing && isReply;\r\n\r\n    const isEmote = message.startsWith(EMOTE_PREFIX);\r\n    if (isEmote) {\r\n        // if we are dealing with an emote we want to remove the prefix so that `/me` does not\r\n        // appear after the `* <userName>` text in the timeline\r\n        message = message.slice(EMOTE_PREFIX.length);\r\n    }\r\n    if (message.startsWith(\"//\")) {\r\n        // if user wants to enter a single slash at the start of a message, this\r\n        // is how they have to do it (due to it clashing with commands), so here we\r\n        // remove the first character to make sure //word displays as /word\r\n        message = message.slice(1);\r\n    }\r\n\r\n    // if we're editing rich text, the message content is pure html\r\n    // BUT if we're not, the message content will be plain text\r\n    const body = isHTML ? await richToPlain(message) : message;\r\n    const bodyPrefix = (isReplyAndEditing && getTextReplyFallback(editedEvent)) || \"\";\r\n    const formattedBodyPrefix = (isReplyAndEditing && getHtmlReplyFallback(editedEvent)) || \"\";\r\n\r\n    const content: IContent = {\r\n        msgtype: isEmote ? MsgType.Emote : MsgType.Text,\r\n        body: isEditing ? `${bodyPrefix} * ${body}` : body,\r\n    };\r\n\r\n    // TODO markdown support\r\n\r\n    const isMarkdownEnabled = SettingsStore.getValue<boolean>(\"MessageComposerInput.useMarkdown\");\r\n    const formattedBody = isHTML ? message : isMarkdownEnabled ? await plainToRich(message) : null;\r\n\r\n    if (formattedBody) {\r\n        content.format = \"org.matrix.custom.html\";\r\n        content.formatted_body = isEditing ? `${formattedBodyPrefix} * ${formattedBody}` : formattedBody;\r\n    }\r\n\r\n    if (isEditing) {\r\n        content[\"m.new_content\"] = {\r\n            msgtype: content.msgtype,\r\n            body: body,\r\n        };\r\n\r\n        if (formattedBody) {\r\n            content[\"m.new_content\"].format = \"org.matrix.custom.html\";\r\n            content[\"m.new_content\"][\"formatted_body\"] = formattedBody;\r\n        }\r\n    }\r\n\r\n    const newRelation = isEditing ? { ...relation, rel_type: \"m.replace\", event_id: editedEvent.getId() } : relation;\r\n\r\n    // TODO Do we need to attach mentions here?\r\n    // TODO Handle editing?\r\n    attachRelation(content, newRelation);\r\n\r\n    if (!isEditing && replyToEvent && permalinkCreator) {\r\n        addReplyToMessageContent(content, replyToEvent, {\r\n            permalinkCreator,\r\n            includeLegacyFallback: includeReplyLegacyFallback,\r\n        });\r\n    }\r\n\r\n    return content;\r\n}\r\n"],"mappings":";;;;;;;;;AAgBA,IAAAA,cAAA,GAAAC,OAAA;AACA,IAAAC,OAAA,GAAAD,OAAA;AAEA,IAAAE,cAAA,GAAAC,sBAAA,CAAAH,OAAA;AAEA,IAAAI,MAAA,GAAAJ,OAAA;AAAsE,SAAAK,QAAAC,MAAA,EAAAC,cAAA,QAAAC,IAAA,GAAAC,MAAA,CAAAD,IAAA,CAAAF,MAAA,OAAAG,MAAA,CAAAC,qBAAA,QAAAC,OAAA,GAAAF,MAAA,CAAAC,qBAAA,CAAAJ,MAAA,GAAAC,cAAA,KAAAI,OAAA,GAAAA,OAAA,CAAAC,MAAA,WAAAC,GAAA,WAAAJ,MAAA,CAAAK,wBAAA,CAAAR,MAAA,EAAAO,GAAA,EAAAE,UAAA,OAAAP,IAAA,CAAAQ,IAAA,CAAAC,KAAA,CAAAT,IAAA,EAAAG,OAAA,YAAAH,IAAA;AAAA,SAAAU,cAAAC,MAAA,aAAAC,CAAA,MAAAA,CAAA,GAAAC,SAAA,CAAAC,MAAA,EAAAF,CAAA,UAAAG,MAAA,WAAAF,SAAA,CAAAD,CAAA,IAAAC,SAAA,CAAAD,CAAA,QAAAA,CAAA,OAAAf,OAAA,CAAAI,MAAA,CAAAc,MAAA,OAAAC,OAAA,WAAAC,GAAA,QAAAC,gBAAA,CAAAC,OAAA,EAAAR,MAAA,EAAAM,GAAA,EAAAF,MAAA,CAAAE,GAAA,SAAAhB,MAAA,CAAAmB,yBAAA,GAAAnB,MAAA,CAAAoB,gBAAA,CAAAV,MAAA,EAAAV,MAAA,CAAAmB,yBAAA,CAAAL,MAAA,KAAAlB,OAAA,CAAAI,MAAA,CAAAc,MAAA,GAAAC,OAAA,WAAAC,GAAA,IAAAhB,MAAA,CAAAqB,cAAA,CAAAX,MAAA,EAAAM,GAAA,EAAAhB,MAAA,CAAAK,wBAAA,CAAAS,MAAA,EAAAE,GAAA,iBAAAN,MAAA,IArBtE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AASO,MAAMY,YAAY,GAAG,MAAM;;AAElC;AAAAC,OAAA,CAAAD,YAAA,GAAAA,YAAA;AACA,SAASE,cAAcA,CAACC,OAAiB,EAAEC,QAAyB,EAAQ;EACxE,IAAIA,QAAQ,EAAE;IACVD,OAAO,CAAC,cAAc,CAAC,GAAAhB,aAAA,CAAAA,aAAA,KACfgB,OAAO,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC,GAC9BC,QAAQ,CACd;EACL;AACJ;AAEA,SAASC,oBAAoBA,CAACC,OAAoB,EAAU;EACxD,MAAMC,IAAI,GAAGD,OAAO,CAACE,UAAU,CAAC,CAAC,CAACC,cAAc;EAChD,IAAI,CAACF,IAAI,EAAE;IACP,OAAO,EAAE;EACb;EACA,MAAMG,QAAQ,GAAG,IAAIC,SAAS,CAAC,CAAC,CAACC,eAAe,CAACL,IAAI,EAAE,WAAW,CAAC,CAACM,IAAI;EACxE,MAAMC,OAAO,GAAGJ,QAAQ,CAACK,aAAa,CAAC,UAAU,CAAC;EAClD,OAAQD,OAAO,IAAIA,OAAO,CAACE,SAAS,IAAK,EAAE;AAC/C;AAEA,SAASC,oBAAoBA,CAACX,OAAoB,EAAU;EACxD,MAAMO,IAAI,GAAGP,OAAO,CAACE,UAAU,CAAC,CAAC,CAACK,IAAI;EACtC,IAAI,OAAOA,IAAI,KAAK,QAAQ,EAAE;IAC1B,OAAO,EAAE;EACb;EACA,MAAMK,KAAK,GAAGL,IAAI,CAACM,KAAK,CAAC,IAAI,CAAC,CAACC,GAAG,CAAEC,CAAC,IAAKA,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC;EACnD,IAAIJ,KAAK,CAAC3B,MAAM,GAAG,CAAC,IAAI2B,KAAK,CAAC,CAAC,CAAC,CAACK,UAAU,CAAC,IAAI,CAAC,IAAIL,KAAK,CAAC,CAAC,CAAC,CAAC3B,MAAM,KAAK,CAAC,EAAE;IACxE,OAAQ,GAAE2B,KAAK,CAAC,CAAC,CAAE,MAAK;EAC5B;EACA,OAAO,EAAE;AACb;AAUA,MAAMM,aAAa,GAAIC,CAA0B,IAAuBA,CAAC,YAAYC,mBAAW;AAEzF,eAAeC,oBAAoBA,CACtCC,OAAe,EACfC,MAAe,EAAAC,IAAA,EAQE;EAAA,IAPjB;IACI1B,QAAQ;IACR2B,YAAY;IACZC,gBAAgB;IAChBC,0BAA0B,GAAG,IAAI;IACjCC;EACwB,CAAC,GAAAJ,IAAA;EAE7B,MAAMK,SAAS,GAAGX,aAAa,CAACU,WAAW,CAAC;EAC5C,MAAME,OAAO,GAAGD,SAAS,GAAGE,OAAO,CAACH,WAAW,CAACI,YAAY,CAAC,GAAGd,aAAa,CAACO,YAAY,CAAC;EAC3F,MAAMQ,iBAAiB,GAAGJ,SAAS,IAAIC,OAAO;EAE9C,MAAMI,OAAO,GAAGZ,OAAO,CAACL,UAAU,CAACvB,YAAY,CAAC;EAChD,IAAIwC,OAAO,EAAE;IACT;IACA;IACAZ,OAAO,GAAGA,OAAO,CAACa,KAAK,CAACzC,YAAY,CAACT,MAAM,CAAC;EAChD;EACA,IAAIqC,OAAO,CAACL,UAAU,CAAC,IAAI,CAAC,EAAE;IAC1B;IACA;IACA;IACAK,OAAO,GAAGA,OAAO,CAACa,KAAK,CAAC,CAAC,CAAC;EAC9B;;EAEA;EACA;EACA,MAAM5B,IAAI,GAAGgB,MAAM,GAAG,MAAM,IAAAa,0BAAW,EAACd,OAAO,CAAC,GAAGA,OAAO;EAC1D,MAAMe,UAAU,GAAIJ,iBAAiB,IAAItB,oBAAoB,CAACiB,WAAW,CAAC,IAAK,EAAE;EACjF,MAAMU,mBAAmB,GAAIL,iBAAiB,IAAIlC,oBAAoB,CAAC6B,WAAW,CAAC,IAAK,EAAE;EAE1F,MAAM/B,OAAiB,GAAG;IACtB0C,OAAO,EAAEL,OAAO,GAAGM,eAAO,CAACC,KAAK,GAAGD,eAAO,CAACE,IAAI;IAC/CnC,IAAI,EAAEsB,SAAS,GAAI,GAAEQ,UAAW,MAAK9B,IAAK,EAAC,GAAGA;EAClD,CAAC;;EAED;;EAEA,MAAMoC,iBAAiB,GAAGC,sBAAa,CAACC,QAAQ,CAAU,kCAAkC,CAAC;EAC7F,MAAMC,aAAa,GAAGvB,MAAM,GAAGD,OAAO,GAAGqB,iBAAiB,GAAG,MAAM,IAAAI,0BAAW,EAACzB,OAAO,CAAC,GAAG,IAAI;EAE9F,IAAIwB,aAAa,EAAE;IACfjD,OAAO,CAACmD,MAAM,GAAG,wBAAwB;IACzCnD,OAAO,CAACM,cAAc,GAAG0B,SAAS,GAAI,GAAES,mBAAoB,MAAKQ,aAAc,EAAC,GAAGA,aAAa;EACpG;EAEA,IAAIjB,SAAS,EAAE;IACXhC,OAAO,CAAC,eAAe,CAAC,GAAG;MACvB0C,OAAO,EAAE1C,OAAO,CAAC0C,OAAO;MACxBhC,IAAI,EAAEA;IACV,CAAC;IAED,IAAIuC,aAAa,EAAE;MACfjD,OAAO,CAAC,eAAe,CAAC,CAACmD,MAAM,GAAG,wBAAwB;MAC1DnD,OAAO,CAAC,eAAe,CAAC,CAAC,gBAAgB,CAAC,GAAGiD,aAAa;IAC9D;EACJ;EAEA,MAAMG,WAAW,GAAGpB,SAAS,GAAAhD,aAAA,CAAAA,aAAA,KAAQiB,QAAQ;IAAEoD,QAAQ,EAAE,WAAW;IAAEC,QAAQ,EAAEvB,WAAW,CAACwB,KAAK,CAAC;EAAC,KAAKtD,QAAQ;;EAEhH;EACA;EACAF,cAAc,CAACC,OAAO,EAAEoD,WAAW,CAAC;EAEpC,IAAI,CAACpB,SAAS,IAAIJ,YAAY,IAAIC,gBAAgB,EAAE;IAChD,IAAA2B,+BAAwB,EAACxD,OAAO,EAAE4B,YAAY,EAAE;MAC5CC,gBAAgB;MAChB4B,qBAAqB,EAAE3B;IAC3B,CAAC,CAAC;EACN;EAEA,OAAO9B,OAAO;AAClB"}