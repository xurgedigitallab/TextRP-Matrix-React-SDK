{"version":3,"file":"useInputEventProcessor.js","names":["_react","require","_useSettings","_KeyBindingsManager","_KeyboardShortcuts","_EventUtils","_dispatcher","_interopRequireDefault","_actions","_RoomContext","_ComposerContext","_MatrixClientContext","_selection","_event","_editing","_utils","useInputEventProcessor","onSend","autocompleteRef","initialContent","eventRelation","roomContext","useRoomContext","composerContext","useComposerContext","mxClient","useMatrixClientContext","isCtrlEnterToSend","useSettingValue","useCallback","event","composer","editor","send","stopPropagation","preventDefault","current","state","hide","isEventToHandleAsClipboardEvent","data","ClipboardEvent","clipboardData","dataTransfer","handled","handleClipboardEvent","isKeyboardEvent","KeyboardEvent","handleKeyboardEvent","handleInputEvent","editorStateTransfer","isEditing","Boolean","isEditorModified","content","length","action","getKeyBindingsManager","getMessageComposerAction","isHandledByAutocomplete","handleEventWithAutocomplete","undefined","KeyBindingAction","SendMessage","EditPrevMessage","isCaretAtStart","isDispatched","dispatchEditEvent","EditNextMessage","isCaretAtEnd","endEditing","isForward","foundEvents","getEventsFromEditorStateTransfer","getEventsFromRoom","newEvent","findEditableEvent","events","fromEventId","getEvent","getId","matrixClient","dis","dispatch","Action","EditEvent","timelineRenderingType","inputType"],"sources":["../../../../../../src/components/views/rooms/wysiwyg_composer/hooks/useInputEventProcessor.ts"],"sourcesContent":["/*\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { Wysiwyg, WysiwygEvent } from \"@matrix-org/matrix-wysiwyg\";\r\nimport { useCallback } from \"react\";\r\nimport { IEventRelation, MatrixClient } from \"matrix-js-sdk/src/matrix\";\r\n\r\nimport { useSettingValue } from \"../../../../../hooks/useSettings\";\r\nimport { getKeyBindingsManager } from \"../../../../../KeyBindingsManager\";\r\nimport { KeyBindingAction } from \"../../../../../accessibility/KeyboardShortcuts\";\r\nimport { findEditableEvent } from \"../../../../../utils/EventUtils\";\r\nimport dis from \"../../../../../dispatcher/dispatcher\";\r\nimport { Action } from \"../../../../../dispatcher/actions\";\r\nimport { useRoomContext } from \"../../../../../contexts/RoomContext\";\r\nimport { IRoomState } from \"../../../../structures/RoomView\";\r\nimport { ComposerContextState, useComposerContext } from \"../ComposerContext\";\r\nimport EditorStateTransfer from \"../../../../../utils/EditorStateTransfer\";\r\nimport { useMatrixClientContext } from \"../../../../../contexts/MatrixClientContext\";\r\nimport { isCaretAtEnd, isCaretAtStart } from \"../utils/selection\";\r\nimport { getEventsFromEditorStateTransfer, getEventsFromRoom } from \"../utils/event\";\r\nimport { endEditing } from \"../utils/editing\";\r\nimport Autocomplete from \"../../Autocomplete\";\r\nimport { handleClipboardEvent, handleEventWithAutocomplete, isEventToHandleAsClipboardEvent } from \"./utils\";\r\n\r\nexport function useInputEventProcessor(\r\n    onSend: () => void,\r\n    autocompleteRef: React.RefObject<Autocomplete>,\r\n    initialContent?: string,\r\n    eventRelation?: IEventRelation,\r\n): (event: WysiwygEvent, composer: Wysiwyg, editor: HTMLElement) => WysiwygEvent | null {\r\n    const roomContext = useRoomContext();\r\n    const composerContext = useComposerContext();\r\n    const mxClient = useMatrixClientContext();\r\n    const isCtrlEnterToSend = useSettingValue<boolean>(\"MessageComposerInput.ctrlEnterToSend\");\r\n\r\n    return useCallback(\r\n        (event: WysiwygEvent, composer: Wysiwyg, editor: HTMLElement) => {\r\n            const send = (): void => {\r\n                event.stopPropagation?.();\r\n                event.preventDefault?.();\r\n                // do not send the message if we have the autocomplete open, regardless of settings\r\n                if (autocompleteRef?.current && !autocompleteRef.current.state.hide) {\r\n                    return;\r\n                }\r\n                onSend();\r\n            };\r\n\r\n            if (isEventToHandleAsClipboardEvent(event)) {\r\n                const data = event instanceof ClipboardEvent ? event.clipboardData : event.dataTransfer;\r\n                const handled = handleClipboardEvent(event, data, roomContext, mxClient, eventRelation);\r\n                return handled ? null : event;\r\n            }\r\n\r\n            const isKeyboardEvent = event instanceof KeyboardEvent;\r\n            if (isKeyboardEvent) {\r\n                return handleKeyboardEvent(\r\n                    event,\r\n                    send,\r\n                    initialContent,\r\n                    composer,\r\n                    editor,\r\n                    roomContext,\r\n                    composerContext,\r\n                    mxClient,\r\n                    autocompleteRef,\r\n                );\r\n            } else {\r\n                return handleInputEvent(event, send, isCtrlEnterToSend);\r\n            }\r\n        },\r\n        [\r\n            isCtrlEnterToSend,\r\n            onSend,\r\n            initialContent,\r\n            roomContext,\r\n            composerContext,\r\n            mxClient,\r\n            autocompleteRef,\r\n            eventRelation,\r\n        ],\r\n    );\r\n}\r\n\r\ntype Send = () => void;\r\n\r\nfunction handleKeyboardEvent(\r\n    event: KeyboardEvent,\r\n    send: Send,\r\n    initialContent: string | undefined,\r\n    composer: Wysiwyg,\r\n    editor: HTMLElement,\r\n    roomContext: IRoomState,\r\n    composerContext: ComposerContextState,\r\n    mxClient: MatrixClient | undefined,\r\n    autocompleteRef: React.RefObject<Autocomplete>,\r\n): KeyboardEvent | null {\r\n    const { editorStateTransfer } = composerContext;\r\n    const isEditing = Boolean(editorStateTransfer);\r\n    const isEditorModified = isEditing ? initialContent !== composer.content() : composer.content().length !== 0;\r\n    const action = getKeyBindingsManager().getMessageComposerAction(event);\r\n\r\n    // we need autocomplete to take priority when it is open for using enter to select\r\n    const isHandledByAutocomplete = handleEventWithAutocomplete(autocompleteRef, event);\r\n    if (isHandledByAutocomplete) {\r\n        return event;\r\n    }\r\n\r\n    // taking the client from context gives us an client | undefined type, narrow it down\r\n    if (mxClient === undefined) {\r\n        return null;\r\n    }\r\n\r\n    switch (action) {\r\n        case KeyBindingAction.SendMessage:\r\n            send();\r\n            return null;\r\n        case KeyBindingAction.EditPrevMessage: {\r\n            // Or if the caret is not at the beginning of the editor\r\n            // Or the editor is modified\r\n            if (!isCaretAtStart(editor) || isEditorModified) {\r\n                break;\r\n            }\r\n\r\n            const isDispatched = dispatchEditEvent(\r\n                event,\r\n                false,\r\n                editorStateTransfer,\r\n                composerContext,\r\n                roomContext,\r\n                mxClient,\r\n            );\r\n\r\n            if (isDispatched) {\r\n                return null;\r\n            }\r\n\r\n            break;\r\n        }\r\n        case KeyBindingAction.EditNextMessage: {\r\n            // If not in edition\r\n            // Or if the caret is not at the end of the editor\r\n            // Or the editor is modified\r\n            if (!editorStateTransfer || !isCaretAtEnd(editor) || isEditorModified) {\r\n                break;\r\n            }\r\n\r\n            const isDispatched = dispatchEditEvent(\r\n                event,\r\n                true,\r\n                editorStateTransfer,\r\n                composerContext,\r\n                roomContext,\r\n                mxClient,\r\n            );\r\n            if (!isDispatched) {\r\n                endEditing(roomContext);\r\n                event.preventDefault();\r\n                event.stopPropagation();\r\n            }\r\n\r\n            return null;\r\n        }\r\n    }\r\n\r\n    return event;\r\n}\r\n\r\nfunction dispatchEditEvent(\r\n    event: KeyboardEvent,\r\n    isForward: boolean,\r\n    editorStateTransfer: EditorStateTransfer | undefined,\r\n    composerContext: ComposerContextState,\r\n    roomContext: IRoomState,\r\n    mxClient: MatrixClient,\r\n): boolean {\r\n    const foundEvents = editorStateTransfer\r\n        ? getEventsFromEditorStateTransfer(editorStateTransfer, roomContext, mxClient)\r\n        : getEventsFromRoom(composerContext, roomContext);\r\n    if (!foundEvents) {\r\n        return false;\r\n    }\r\n\r\n    const newEvent = findEditableEvent({\r\n        events: foundEvents,\r\n        isForward,\r\n        fromEventId: editorStateTransfer?.getEvent().getId(),\r\n        matrixClient: mxClient,\r\n    });\r\n    if (newEvent) {\r\n        dis.dispatch({\r\n            action: Action.EditEvent,\r\n            event: newEvent,\r\n            timelineRenderingType: roomContext.timelineRenderingType,\r\n        });\r\n        event.stopPropagation();\r\n        event.preventDefault();\r\n        return true;\r\n    }\r\n    return false;\r\n}\r\n\r\ntype InputEvent = Exclude<WysiwygEvent, KeyboardEvent | ClipboardEvent>;\r\n\r\nfunction handleInputEvent(event: InputEvent, send: Send, isCtrlEnterToSend: boolean): InputEvent | null {\r\n    switch (event.inputType) {\r\n        case \"insertParagraph\":\r\n            if (!isCtrlEnterToSend) {\r\n                send();\r\n                return null;\r\n            }\r\n            break;\r\n        case \"sendMessage\":\r\n            if (isCtrlEnterToSend) {\r\n                send();\r\n                return null;\r\n            }\r\n            break;\r\n    }\r\n\r\n    return event;\r\n}\r\n"],"mappings":"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"}