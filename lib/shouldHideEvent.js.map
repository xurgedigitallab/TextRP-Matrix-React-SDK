{"version":3,"file":"shouldHideEvent.js","names":["_event","require","_SettingsStore","_interopRequireDefault","memberEventDiff","ev","diff","isMemberEvent","getType","EventType","RoomMember","content","getContent","prevContent","getPrevContent","isMembershipChanged","membership","isJoin","isPart","getStateKey","getSender","isJoinToJoin","isDisplaynameChange","displayname","isAvatarChange","avatar_url","shouldHideEvent","ctx","isEnabled","name","SettingsStore","getValue","getRoomId","isRedacted","getThread","isRelation","RelationType","Replace","eventDiff"],"sources":["../src/shouldHideEvent.ts"],"sourcesContent":["/*\r\n Copyright 2017 Michael Telatynski <7t3chguy@gmail.com>\r\n\r\n Licensed under the Apache License, Version 2.0 (the \"License\");\r\n you may not use this file except in compliance with the License.\r\n You may obtain a copy of the License at\r\n\r\n http://www.apache.org/licenses/LICENSE-2.0\r\n\r\n Unless required by applicable law or agreed to in writing, software\r\n distributed under the License is distributed on an \"AS IS\" BASIS,\r\n WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n See the License for the specific language governing permissions and\r\n limitations under the License.\r\n */\r\n\r\nimport { MatrixEvent } from \"matrix-js-sdk/src/models/event\";\r\nimport { EventType, RelationType } from \"matrix-js-sdk/src/@types/event\";\r\n\r\nimport SettingsStore from \"./settings/SettingsStore\";\r\nimport { IRoomState } from \"./components/structures/RoomView\";\r\n\r\ninterface IDiff {\r\n    isMemberEvent: boolean;\r\n    isJoin?: boolean;\r\n    isPart?: boolean;\r\n    isDisplaynameChange?: boolean;\r\n    isAvatarChange?: boolean;\r\n}\r\n\r\nfunction memberEventDiff(ev: MatrixEvent): IDiff {\r\n    const diff: IDiff = {\r\n        isMemberEvent: ev.getType() === EventType.RoomMember,\r\n    };\r\n\r\n    // If is not a Member Event then the other checks do not apply, so bail early.\r\n    if (!diff.isMemberEvent) return diff;\r\n\r\n    const content = ev.getContent();\r\n    const prevContent = ev.getPrevContent();\r\n\r\n    const isMembershipChanged = content.membership !== prevContent.membership;\r\n    diff.isJoin = isMembershipChanged && content.membership === \"join\";\r\n    diff.isPart = isMembershipChanged && content.membership === \"leave\" && ev.getStateKey() === ev.getSender();\r\n\r\n    const isJoinToJoin = !isMembershipChanged && content.membership === \"join\";\r\n    diff.isDisplaynameChange = isJoinToJoin && content.displayname !== prevContent.displayname;\r\n    diff.isAvatarChange = isJoinToJoin && content.avatar_url !== prevContent.avatar_url;\r\n    return diff;\r\n}\r\n\r\n/**\r\n * Determines whether the given event should be hidden from timelines.\r\n * @param ev The event\r\n * @param ctx An optional RoomContext to pull cached settings values from to avoid\r\n *     hitting the settings store\r\n */\r\nexport default function shouldHideEvent(ev: MatrixEvent, ctx?: IRoomState): boolean {\r\n    // Accessing the settings store directly can be expensive if done frequently,\r\n    // so we should prefer using cached values if a RoomContext is available\r\n    const isEnabled = ctx\r\n        ? (name: keyof IRoomState) => ctx[name]\r\n        : (name: string) => SettingsStore.getValue(name, ev.getRoomId());\r\n\r\n    // Hide redacted events\r\n    // Deleted events with a thread are always shown regardless of user preference\r\n    // to make sure that a thread can be accessible even if the root message is deleted\r\n    if (ev.isRedacted() && !isEnabled(\"showRedactions\") && !ev.getThread()) return true;\r\n\r\n    // Hide replacement events since they update the original tile (if enabled)\r\n    if (ev.isRelation(RelationType.Replace)) return true;\r\n\r\n    const eventDiff = memberEventDiff(ev);\r\n\r\n    if (eventDiff.isMemberEvent) {\r\n        if ((eventDiff.isJoin || eventDiff.isPart) && !isEnabled(\"showJoinLeaves\")) return true;\r\n        if (eventDiff.isAvatarChange && !isEnabled(\"showAvatarChanges\")) return true;\r\n        if (eventDiff.isDisplaynameChange && !isEnabled(\"showDisplaynameChanges\")) return true;\r\n    }\r\n\r\n    return false;\r\n}\r\n"],"mappings":";;;;;;;AAiBA,IAAAA,MAAA,GAAAC,OAAA;AAEA,IAAAC,cAAA,GAAAC,sBAAA,CAAAF,OAAA;AAnBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAgBA,SAASG,eAAeA,CAACC,EAAe,EAAS;EAC7C,MAAMC,IAAW,GAAG;IAChBC,aAAa,EAAEF,EAAE,CAACG,OAAO,CAAC,CAAC,KAAKC,gBAAS,CAACC;EAC9C,CAAC;;EAED;EACA,IAAI,CAACJ,IAAI,CAACC,aAAa,EAAE,OAAOD,IAAI;EAEpC,MAAMK,OAAO,GAAGN,EAAE,CAACO,UAAU,CAAC,CAAC;EAC/B,MAAMC,WAAW,GAAGR,EAAE,CAACS,cAAc,CAAC,CAAC;EAEvC,MAAMC,mBAAmB,GAAGJ,OAAO,CAACK,UAAU,KAAKH,WAAW,CAACG,UAAU;EACzEV,IAAI,CAACW,MAAM,GAAGF,mBAAmB,IAAIJ,OAAO,CAACK,UAAU,KAAK,MAAM;EAClEV,IAAI,CAACY,MAAM,GAAGH,mBAAmB,IAAIJ,OAAO,CAACK,UAAU,KAAK,OAAO,IAAIX,EAAE,CAACc,WAAW,CAAC,CAAC,KAAKd,EAAE,CAACe,SAAS,CAAC,CAAC;EAE1G,MAAMC,YAAY,GAAG,CAACN,mBAAmB,IAAIJ,OAAO,CAACK,UAAU,KAAK,MAAM;EAC1EV,IAAI,CAACgB,mBAAmB,GAAGD,YAAY,IAAIV,OAAO,CAACY,WAAW,KAAKV,WAAW,CAACU,WAAW;EAC1FjB,IAAI,CAACkB,cAAc,GAAGH,YAAY,IAAIV,OAAO,CAACc,UAAU,KAAKZ,WAAW,CAACY,UAAU;EACnF,OAAOnB,IAAI;AACf;;AAEA;AACA;AACA;AACA;AACA;AACA;AACe,SAASoB,eAAeA,CAACrB,EAAe,EAAEsB,GAAgB,EAAW;EAChF;EACA;EACA,MAAMC,SAAS,GAAGD,GAAG,GACdE,IAAsB,IAAKF,GAAG,CAACE,IAAI,CAAC,GACpCA,IAAY,IAAKC,sBAAa,CAACC,QAAQ,CAACF,IAAI,EAAExB,EAAE,CAAC2B,SAAS,CAAC,CAAC,CAAC;;EAEpE;EACA;EACA;EACA,IAAI3B,EAAE,CAAC4B,UAAU,CAAC,CAAC,IAAI,CAACL,SAAS,CAAC,gBAAgB,CAAC,IAAI,CAACvB,EAAE,CAAC6B,SAAS,CAAC,CAAC,EAAE,OAAO,IAAI;;EAEnF;EACA,IAAI7B,EAAE,CAAC8B,UAAU,CAACC,mBAAY,CAACC,OAAO,CAAC,EAAE,OAAO,IAAI;EAEpD,MAAMC,SAAS,GAAGlC,eAAe,CAACC,EAAE,CAAC;EAErC,IAAIiC,SAAS,CAAC/B,aAAa,EAAE;IACzB,IAAI,CAAC+B,SAAS,CAACrB,MAAM,IAAIqB,SAAS,CAACpB,MAAM,KAAK,CAACU,SAAS,CAAC,gBAAgB,CAAC,EAAE,OAAO,IAAI;IACvF,IAAIU,SAAS,CAACd,cAAc,IAAI,CAACI,SAAS,CAAC,mBAAmB,CAAC,EAAE,OAAO,IAAI;IAC5E,IAAIU,SAAS,CAAChB,mBAAmB,IAAI,CAACM,SAAS,CAAC,wBAAwB,CAAC,EAAE,OAAO,IAAI;EAC1F;EAEA,OAAO,KAAK;AAChB"}