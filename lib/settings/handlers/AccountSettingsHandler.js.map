{"version":3,"file":"AccountSettingsHandler.js","names":["_client","require","_utils","_MatrixClientBackedSettingsHandler","_interopRequireDefault","_objects","_SettingLevel","BREADCRUMBS_LEGACY_EVENT_TYPE","BREADCRUMBS_EVENT_TYPE","BREADCRUMBS_EVENT_TYPES","RECENT_EMOJI_EVENT_TYPE","INTEG_PROVISIONING_EVENT_TYPE","ANALYTICS_EVENT_TYPE","DEFAULT_SETTINGS_EVENT_TYPE","AccountSettingsHandler","MatrixClientBackedSettingsHandler","constructor","watchers","_defineProperty2","default","event","prevEvent","getType","val","getContent","notifyUpdate","SettingLevel","ACCOUNT","prevContent","changedSettings","objectKeyChanges","settingName","includes","notifyBreadcrumbsUpdate","level","initMatrixClient","oldClient","newClient","removeListener","ClientEvent","AccountData","onAccountData","on","getValue","roomId","content","getSettings","value","undefined","setValue","settings","preferredValue","setAccountData","eventType","field","legacyEventType","deferred","defer","handler","client","off","resolve","promise","newValue","canSetValue","isSupported","isGuest","arguments","length","getAccountData","objectClone","newType","exports"],"sources":["../../../src/settings/handlers/AccountSettingsHandler.ts"],"sourcesContent":["/*\r\nCopyright 2017 Travis Ralston\r\nCopyright 2019, 2020 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { ClientEvent, MatrixClient } from \"matrix-js-sdk/src/client\";\r\nimport { MatrixEvent } from \"matrix-js-sdk/src/models/event\";\r\nimport { defer } from \"matrix-js-sdk/src/utils\";\r\n\r\nimport MatrixClientBackedSettingsHandler from \"./MatrixClientBackedSettingsHandler\";\r\nimport { objectClone, objectKeyChanges } from \"../../utils/objects\";\r\nimport { SettingLevel } from \"../SettingLevel\";\r\nimport { WatchManager } from \"../WatchManager\";\r\n\r\nconst BREADCRUMBS_LEGACY_EVENT_TYPE = \"im.vector.riot.breadcrumb_rooms\";\r\nconst BREADCRUMBS_EVENT_TYPE = \"im.vector.setting.breadcrumbs\";\r\nconst BREADCRUMBS_EVENT_TYPES = [BREADCRUMBS_LEGACY_EVENT_TYPE, BREADCRUMBS_EVENT_TYPE];\r\nconst RECENT_EMOJI_EVENT_TYPE = \"io.element.recent_emoji\";\r\nconst INTEG_PROVISIONING_EVENT_TYPE = \"im.vector.setting.integration_provisioning\";\r\nconst ANALYTICS_EVENT_TYPE = \"im.vector.analytics\";\r\nconst DEFAULT_SETTINGS_EVENT_TYPE = \"im.vector.web.settings\";\r\n\r\n/**\r\n * Gets and sets settings at the \"account\" level for the current user.\r\n * This handler does not make use of the roomId parameter.\r\n */\r\nexport default class AccountSettingsHandler extends MatrixClientBackedSettingsHandler {\r\n    public constructor(public readonly watchers: WatchManager) {\r\n        super();\r\n    }\r\n\r\n    public get level(): SettingLevel {\r\n        return SettingLevel.ACCOUNT;\r\n    }\r\n\r\n    public initMatrixClient(oldClient: MatrixClient, newClient: MatrixClient): void {\r\n        oldClient?.removeListener(ClientEvent.AccountData, this.onAccountData);\r\n        newClient.on(ClientEvent.AccountData, this.onAccountData);\r\n    }\r\n\r\n    private onAccountData = (event: MatrixEvent, prevEvent?: MatrixEvent): void => {\r\n        if (event.getType() === \"org.matrix.preview_urls\") {\r\n            let val = event.getContent()[\"disable\"];\r\n            if (typeof val !== \"boolean\") {\r\n                val = null;\r\n            } else {\r\n                val = !val;\r\n            }\r\n\r\n            this.watchers.notifyUpdate(\"urlPreviewsEnabled\", null, SettingLevel.ACCOUNT, val);\r\n        } else if (event.getType() === DEFAULT_SETTINGS_EVENT_TYPE || event.getType() === ANALYTICS_EVENT_TYPE) {\r\n            // Figure out what changed and fire those updates\r\n            const prevContent = prevEvent?.getContent() ?? {};\r\n            const changedSettings = objectKeyChanges<Record<string, any>>(prevContent, event.getContent());\r\n            for (const settingName of changedSettings) {\r\n                const val = event.getContent()[settingName];\r\n                this.watchers.notifyUpdate(settingName, null, SettingLevel.ACCOUNT, val);\r\n            }\r\n        } else if (BREADCRUMBS_EVENT_TYPES.includes(event.getType())) {\r\n            this.notifyBreadcrumbsUpdate(event);\r\n        } else if (event.getType() === INTEG_PROVISIONING_EVENT_TYPE) {\r\n            const val = event.getContent()[\"enabled\"];\r\n            this.watchers.notifyUpdate(\"integrationProvisioning\", null, SettingLevel.ACCOUNT, val);\r\n        } else if (event.getType() === RECENT_EMOJI_EVENT_TYPE) {\r\n            const val = event.getContent()[\"enabled\"];\r\n            this.watchers.notifyUpdate(\"recent_emoji\", null, SettingLevel.ACCOUNT, val);\r\n        }\r\n    };\r\n\r\n    public getValue(settingName: string, roomId: string): any {\r\n        // Special case URL previews\r\n        if (settingName === \"urlPreviewsEnabled\") {\r\n            const content = this.getSettings(\"org.matrix.preview_urls\") || {};\r\n\r\n            // Check to make sure that we actually got a boolean\r\n            if (typeof content[\"disable\"] !== \"boolean\") return null;\r\n            return !content[\"disable\"];\r\n        }\r\n\r\n        // Special case for breadcrumbs\r\n        if (settingName === \"breadcrumb_rooms\") {\r\n            let content = this.getSettings(BREADCRUMBS_EVENT_TYPE);\r\n            if (!content || !content[\"recent_rooms\"]) {\r\n                content = this.getSettings(BREADCRUMBS_LEGACY_EVENT_TYPE);\r\n\r\n                // This is a bit of a hack, but it makes things slightly easier\r\n                if (content) content[\"recent_rooms\"] = content[\"rooms\"];\r\n            }\r\n\r\n            return content && content[\"recent_rooms\"] ? content[\"recent_rooms\"] : [];\r\n        }\r\n\r\n        // Special case recent emoji\r\n        if (settingName === \"recent_emoji\") {\r\n            const content = this.getSettings(RECENT_EMOJI_EVENT_TYPE);\r\n            return content ? content[\"recent_emoji\"] : null;\r\n        }\r\n\r\n        // Special case integration manager provisioning\r\n        if (settingName === \"integrationProvisioning\") {\r\n            const content = this.getSettings(INTEG_PROVISIONING_EVENT_TYPE);\r\n            return content ? content[\"enabled\"] : null;\r\n        }\r\n\r\n        if (settingName === \"pseudonymousAnalyticsOptIn\") {\r\n            const content = this.getSettings(ANALYTICS_EVENT_TYPE) || {};\r\n            // Check to make sure that we actually got a boolean\r\n            if (typeof content[settingName] !== \"boolean\") return null;\r\n            return content[settingName];\r\n        }\r\n\r\n        if (settingName === \"MessageComposerInput.insertTrailingColon\") {\r\n            const content = this.getSettings() || {};\r\n            const value = content[settingName];\r\n            if (value === null || value === undefined) {\r\n                // Write true as it is the default. This will give us the option\r\n                // of making this opt-in in the future, without affecting old\r\n                // users\r\n                this.setValue(settingName, roomId, true);\r\n                return true;\r\n            }\r\n            return value;\r\n        }\r\n\r\n        const settings = this.getSettings() || {};\r\n        let preferredValue = settings[settingName];\r\n\r\n        if (preferredValue === null || preferredValue === undefined) {\r\n            // Honour the old setting on read only\r\n            if (settingName === \"hideAvatarChanges\" || settingName === \"hideDisplaynameChanges\") {\r\n                preferredValue = settings[\"hideAvatarDisplaynameChanges\"];\r\n            }\r\n        }\r\n\r\n        return preferredValue;\r\n    }\r\n\r\n    // helper function to set account data then await it being echoed back\r\n    private async setAccountData(\r\n        eventType: string,\r\n        field: string,\r\n        value: any,\r\n        legacyEventType?: string,\r\n    ): Promise<void> {\r\n        let content = this.getSettings(eventType);\r\n        if (legacyEventType && !content?.[field]) {\r\n            content = this.getSettings(legacyEventType);\r\n        }\r\n\r\n        if (!content) {\r\n            content = {};\r\n        }\r\n\r\n        content[field] = value;\r\n\r\n        // Attach a deferred *before* setting the account data to ensure we catch any requests\r\n        // which race between different lines.\r\n        const deferred = defer<void>();\r\n        const handler = (event: MatrixEvent): void => {\r\n            if (event.getType() !== eventType || event.getContent()[field] !== value) return;\r\n            this.client.off(ClientEvent.AccountData, handler);\r\n            deferred.resolve();\r\n        };\r\n        this.client.on(ClientEvent.AccountData, handler);\r\n\r\n        await this.client.setAccountData(eventType, content);\r\n\r\n        await deferred.promise;\r\n    }\r\n\r\n    public setValue(settingName: string, roomId: string, newValue: any): Promise<void> {\r\n        switch (settingName) {\r\n            // Special case URL previews\r\n            case \"urlPreviewsEnabled\":\r\n                return this.setAccountData(\"org.matrix.preview_urls\", \"disable\", !newValue);\r\n\r\n            // Special case for breadcrumbs\r\n            case \"breadcrumb_rooms\":\r\n                return this.setAccountData(\r\n                    BREADCRUMBS_EVENT_TYPE,\r\n                    \"recent_rooms\",\r\n                    newValue,\r\n                    BREADCRUMBS_LEGACY_EVENT_TYPE,\r\n                );\r\n\r\n            // Special case recent emoji\r\n            case \"recent_emoji\":\r\n                return this.setAccountData(RECENT_EMOJI_EVENT_TYPE, \"recent_emoji\", newValue);\r\n\r\n            // Special case integration manager provisioning\r\n            case \"integrationProvisioning\":\r\n                return this.setAccountData(INTEG_PROVISIONING_EVENT_TYPE, \"enabled\", newValue);\r\n\r\n            // Special case analytics\r\n            case \"pseudonymousAnalyticsOptIn\":\r\n                return this.setAccountData(ANALYTICS_EVENT_TYPE, \"pseudonymousAnalyticsOptIn\", newValue);\r\n\r\n            default:\r\n                return this.setAccountData(DEFAULT_SETTINGS_EVENT_TYPE, settingName, newValue);\r\n        }\r\n    }\r\n\r\n    public canSetValue(settingName: string, roomId: string): boolean {\r\n        return true; // It's their account, so they should be able to\r\n    }\r\n\r\n    public isSupported(): boolean {\r\n        return this.client && !this.client.isGuest();\r\n    }\r\n\r\n    private getSettings(eventType = \"im.vector.web.settings\"): any {\r\n        // TODO: [TS] Types on return\r\n        if (!this.client) return null;\r\n\r\n        const event = this.client.getAccountData(eventType);\r\n        if (!event || !event.getContent()) return null;\r\n        return objectClone(event.getContent()); // clone to prevent mutation\r\n    }\r\n\r\n    private notifyBreadcrumbsUpdate(event: MatrixEvent): void {\r\n        let val = [];\r\n        if (event.getType() === BREADCRUMBS_LEGACY_EVENT_TYPE) {\r\n            // This seems fishy - try and get the event for the new rooms\r\n            const newType = this.getSettings(BREADCRUMBS_EVENT_TYPE);\r\n            if (newType) val = newType[\"recent_rooms\"];\r\n            else val = event.getContent()[\"rooms\"];\r\n        } else if (event.getType() === BREADCRUMBS_EVENT_TYPE) {\r\n            val = event.getContent()[\"recent_rooms\"];\r\n        } else {\r\n            return; // for sanity, not because we expect to be here.\r\n        }\r\n        this.watchers.notifyUpdate(\"breadcrumb_rooms\", null, SettingLevel.ACCOUNT, val || []);\r\n    }\r\n}\r\n"],"mappings":"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"}