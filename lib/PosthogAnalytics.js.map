{"version":3,"file":"PosthogAnalytics.js","names":["_posthogJs","_interopRequireDefault","require","_logger","_PlatformPeg","_SdkConfig","_MatrixClientPeg","_SettingsStore","_actions","_dispatcher","_Layout","_excluded","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","_defineProperty2","default","getOwnPropertyDescriptors","defineProperties","defineProperty","Anonymity","exports","whitelistedScreens","Set","getRedactedCurrentLocation","origin","hash","pathname","startsWith","hashStr","beforeFirstSlash","screen","split","has","PosthogAnalytics","instance","_instance","posthog","constructor","Disabled","layout","SettingsStore","getValue","Layout","IRC","Bubble","Group","setProperty","payload","action","Action","SettingUpdated","settingsPayload","includes","settingName","onLayoutUpdated","properties","eventName","lastScreen","anonymity","Anonymous","posthogConfig","SdkConfig","getObject","init","get","api_host","autocapture","mask_all_text","mask_all_element_attributes","capture_pageview","sanitize_properties","sanitizeProperties","respect_dnt","advanced_disable_decide","enabled","dis","register","onAction","monitorSetting","registerSuperProperties","getPlatformProperties","platform","PlatformPeg","appVersion","getAppVersion","e","appPlatform","getHumanReadableName","capture","options","window","location","propertiesForNextEvent","isEnabled","setAnonymity","reset","platformSuperProperties","getRandomAnalyticsId","crypto","getRandomValues","Uint8Array","map","c","toString","join","identifyUser","client","analyticsIdGenerator","Pseudonymous","accountData","getAccountDataFromServer","ANALYTICS_EVENT_TYPE","analyticsID","id","setAccountData","assign","get_distinct_id","persistence","get_user_state","identify","logger","log","getAnonymity","logout","trackEvent","_ref","_objectWithoutProperties2","value","userPropertyCache","setPropertyOnce","updatePlatformSuperProperties","updateAnonymityFromSettings","pseudonymousOptIn","MatrixClientPeg","currentUserIsJustRegistered","trackNewUserEvent","startListeningToSettingsChanges","watchSetting","originalSettingName","changedInRoomId","atLevel","newValueAtLevel","newValue","setAuthenticationType","authenticationType","registrationTime","parseInt","localStorage","getItem","isNaN","timestamp","Date"],"sources":["../src/PosthogAnalytics.ts"],"sourcesContent":["/*\r\nCopyright 2021 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport posthog, { PostHog, Properties } from \"posthog-js\";\r\nimport { MatrixClient } from \"matrix-js-sdk/src/client\";\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\nimport { UserProperties } from \"@matrix-org/analytics-events/types/typescript/UserProperties\";\r\nimport { Signup } from \"@matrix-org/analytics-events/types/typescript/Signup\";\r\n\r\nimport PlatformPeg from \"./PlatformPeg\";\r\nimport SdkConfig from \"./SdkConfig\";\r\nimport { MatrixClientPeg } from \"./MatrixClientPeg\";\r\nimport SettingsStore from \"./settings/SettingsStore\";\r\nimport { ScreenName } from \"./PosthogTrackers\";\r\nimport { ActionPayload } from \"./dispatcher/payloads\";\r\nimport { Action } from \"./dispatcher/actions\";\r\nimport { SettingUpdatedPayload } from \"./dispatcher/payloads/SettingUpdatedPayload\";\r\nimport dis from \"./dispatcher/dispatcher\";\r\nimport { Layout } from \"./settings/enums/Layout\";\r\n\r\n/* Posthog analytics tracking.\r\n *\r\n * Anonymity behaviour is as follows:\r\n *\r\n * - If Posthog isn't configured in `config.json`, events are not sent.\r\n * - If [Do Not Track](https://developer.mozilla.org/en-US/docs/Web/API/Navigator/doNotTrack) is\r\n *   enabled, events are not sent (this detection is built into posthog and turned on via the\r\n *   `respect_dnt` flag being passed to `posthog.init`).\r\n * - If the `feature_pseudonymous_analytics_opt_in` labs flag is `true`, track pseudonomously by maintaining\r\n *   a randomised analytics ID in account_data for that user (shared between devices) and sending it to posthog to\r\n     identify the user.\r\n * - Otherwise, if the existing `analyticsOptIn` flag is `true`, track anonymously, i.e. do not identify the user\r\n     using any identifier that would be consistent across devices.\r\n * - If both flags are false or not set, events are not sent.\r\n */\r\n\r\nexport interface IPosthogEvent {\r\n    // The event name that will be used by PostHog. Event names should use camelCase.\r\n    eventName: string;\r\n\r\n    // do not allow these to be sent manually, we enqueue them all for caching purposes\r\n    $set?: void;\r\n    $set_once?: void;\r\n}\r\n\r\nexport interface IPostHogEventOptions {\r\n    timestamp?: Date;\r\n}\r\n\r\nexport enum Anonymity {\r\n    Disabled,\r\n    Anonymous,\r\n    Pseudonymous,\r\n}\r\n\r\nconst whitelistedScreens = new Set([\r\n    \"register\",\r\n    \"login\",\r\n    \"forgot_password\",\r\n    \"soft_logout\",\r\n    \"new\",\r\n    \"settings\",\r\n    \"welcome\",\r\n    \"home\",\r\n    \"start\",\r\n    \"directory\",\r\n    \"start_sso\",\r\n    \"start_cas\",\r\n    \"complete_security\",\r\n    \"post_registration\",\r\n    \"room\",\r\n    \"user\",\r\n]);\r\n\r\nexport function getRedactedCurrentLocation(origin: string, hash: string, pathname: string): string {\r\n    // Redact PII from the current location.\r\n    // For known screens, assumes a URL structure of /<screen name>/might/be/pii\r\n    if (origin.startsWith(\"file://\")) {\r\n        pathname = \"/<redacted_file_scheme_url>/\";\r\n    }\r\n\r\n    let hashStr;\r\n    if (hash == \"\") {\r\n        hashStr = \"\";\r\n    } else {\r\n        let [beforeFirstSlash, screen] = hash.split(\"/\");\r\n\r\n        if (!whitelistedScreens.has(screen)) {\r\n            screen = \"<redacted_screen_name>\";\r\n        }\r\n\r\n        hashStr = `${beforeFirstSlash}/${screen}/<redacted>`;\r\n    }\r\n    return origin + pathname + hashStr;\r\n}\r\n\r\ninterface PlatformProperties {\r\n    appVersion: string;\r\n    appPlatform: string;\r\n}\r\n\r\nexport class PosthogAnalytics {\r\n    /* Wrapper for Posthog analytics.\r\n     * 3 modes of anonymity are supported, governed by this.anonymity\r\n     * - Anonymity.Disabled means *no data* is passed to posthog\r\n     * - Anonymity.Anonymous means no identifier is passed to posthog\r\n     * - Anonymity.Pseudonymous means an analytics ID stored in account_data and shared between devices\r\n     *   is passed to posthog.\r\n     *\r\n     * To update anonymity, call updateAnonymityFromSettings() or you can set it directly via setAnonymity().\r\n     *\r\n     * To pass an event to Posthog:\r\n     *\r\n     * 1. Declare a type for the event, extending IAnonymousEvent or IPseudonymousEvent.\r\n     * 2. Call the appropriate track*() method. Pseudonymous events will be dropped when anonymity is\r\n     *    Anonymous or Disabled; Anonymous events will be dropped when anonymity is Disabled.\r\n     */\r\n\r\n    private anonymity = Anonymity.Disabled;\r\n    // set true during the constructor if posthog config is present, otherwise false\r\n    private readonly enabled: boolean = false;\r\n    private static _instance: PosthogAnalytics | null = null;\r\n    private platformSuperProperties: Properties = {};\r\n    public static readonly ANALYTICS_EVENT_TYPE = \"im.vector.analytics\";\r\n    private propertiesForNextEvent: Partial<Record<\"$set\" | \"$set_once\", UserProperties>> = {};\r\n    private userPropertyCache: UserProperties = {};\r\n    private authenticationType: Signup[\"authenticationType\"] = \"Other\";\r\n\r\n    public static get instance(): PosthogAnalytics {\r\n        if (!this._instance) {\r\n            this._instance = new PosthogAnalytics(posthog);\r\n        }\r\n        return this._instance;\r\n    }\r\n\r\n    public constructor(private readonly posthog: PostHog) {\r\n        const posthogConfig = SdkConfig.getObject(\"posthog\");\r\n        if (posthogConfig) {\r\n            this.posthog.init(posthogConfig.get(\"project_api_key\"), {\r\n                api_host: posthogConfig.get(\"api_host\"),\r\n                autocapture: false,\r\n                mask_all_text: true,\r\n                mask_all_element_attributes: true,\r\n                // This only triggers on page load, which for our SPA isn't particularly useful.\r\n                // Plus, the .capture call originating from somewhere in posthog makes it hard\r\n                // to redact URLs, which requires async code.\r\n                //\r\n                // To raise this manually, just call .capture(\"$pageview\") or posthog.capture_pageview.\r\n                capture_pageview: false,\r\n                sanitize_properties: this.sanitizeProperties,\r\n                respect_dnt: true,\r\n                advanced_disable_decide: true,\r\n            });\r\n            this.enabled = true;\r\n        } else {\r\n            this.enabled = false;\r\n        }\r\n\r\n        dis.register(this.onAction);\r\n        SettingsStore.monitorSetting(\"layout\", null);\r\n        SettingsStore.monitorSetting(\"useCompactLayout\", null);\r\n        this.onLayoutUpdated();\r\n    }\r\n\r\n    private onLayoutUpdated = (): void => {\r\n        let layout: UserProperties[\"WebLayout\"];\r\n\r\n        switch (SettingsStore.getValue(\"layout\")) {\r\n            case Layout.IRC:\r\n                layout = \"IRC\";\r\n                break;\r\n            case Layout.Bubble:\r\n                layout = \"Bubble\";\r\n                break;\r\n            case Layout.Group:\r\n                layout = SettingsStore.getValue(\"useCompactLayout\") ? \"Compact\" : \"Group\";\r\n                break;\r\n        }\r\n\r\n        // This is known to clobber other devices but is a good enough solution\r\n        // to get an idea of how much use each layout gets.\r\n        this.setProperty(\"WebLayout\", layout);\r\n    };\r\n\r\n    private onAction = (payload: ActionPayload): void => {\r\n        if (payload.action !== Action.SettingUpdated) return;\r\n        const settingsPayload = payload as SettingUpdatedPayload;\r\n        if ([\"layout\", \"useCompactLayout\"].includes(settingsPayload.settingName)) {\r\n            this.onLayoutUpdated();\r\n        }\r\n    };\r\n\r\n    // we persist the last `$screen_name` and send it for all events until it is replaced\r\n    private lastScreen: ScreenName = \"Loading\";\r\n\r\n    private sanitizeProperties = (properties: Properties, eventName: string): Properties => {\r\n        // Callback from posthog to sanitize properties before sending them to the server.\r\n        //\r\n        // Here we sanitize posthog's built in properties which leak PII e.g. url reporting.\r\n        // See utils.js _.info.properties in posthog-js.\r\n\r\n        if (eventName === \"$pageview\") {\r\n            this.lastScreen = properties[\"$current_url\"];\r\n        }\r\n        // We inject a screen identifier in $current_url as per https://posthog.com/tutorials/spa\r\n        properties[\"$current_url\"] = this.lastScreen;\r\n\r\n        if (this.anonymity == Anonymity.Anonymous) {\r\n            // drop referrer information for anonymous users\r\n            properties[\"$referrer\"] = null;\r\n            properties[\"$referring_domain\"] = null;\r\n            properties[\"$initial_referrer\"] = null;\r\n            properties[\"$initial_referring_domain\"] = null;\r\n\r\n            // drop device ID, which is a UUID persisted in local storage\r\n            properties[\"$device_id\"] = null;\r\n        }\r\n\r\n        return properties;\r\n    };\r\n\r\n    private registerSuperProperties(properties: Properties): void {\r\n        if (this.enabled) {\r\n            this.posthog.register(properties);\r\n        }\r\n    }\r\n\r\n    private static async getPlatformProperties(): Promise<Partial<PlatformProperties>> {\r\n        const platform = PlatformPeg.get();\r\n        let appVersion: string | undefined;\r\n        try {\r\n            appVersion = await platform?.getAppVersion();\r\n        } catch (e) {\r\n            // this happens if no version is set i.e. in dev\r\n            appVersion = \"unknown\";\r\n        }\r\n\r\n        return {\r\n            appVersion,\r\n            appPlatform: platform?.getHumanReadableName(),\r\n        };\r\n    }\r\n\r\n    // eslint-disable-nextline no-unused-vars\r\n    private capture(eventName: string, properties: Properties, options?: IPostHogEventOptions): void {\r\n        if (!this.enabled) {\r\n            return;\r\n        }\r\n        const { origin, hash, pathname } = window.location;\r\n        properties[\"redactedCurrentUrl\"] = getRedactedCurrentLocation(origin, hash, pathname);\r\n        this.posthog.capture(\r\n            eventName,\r\n            { ...this.propertiesForNextEvent, ...properties },\r\n            // TODO: Uncomment below once https://github.com/PostHog/posthog-js/pull/391\r\n            // gets merged\r\n            /* options as any, */ // No proper type definition in the posthog library\r\n        );\r\n        this.propertiesForNextEvent = {};\r\n    }\r\n\r\n    public isEnabled(): boolean {\r\n        return this.enabled;\r\n    }\r\n\r\n    public setAnonymity(anonymity: Anonymity): void {\r\n        // Update this.anonymity.\r\n        // This is public for testing purposes, typically you want to call updateAnonymityFromSettings\r\n        // to ensure this value is in step with the user's settings.\r\n        if (this.enabled && (anonymity == Anonymity.Disabled || anonymity == Anonymity.Anonymous)) {\r\n            // when transitioning to Disabled or Anonymous ensure we clear out any prior state\r\n            // set in posthog e.g. distinct ID\r\n            this.posthog.reset();\r\n            // Restore any previously set platform super properties\r\n            this.registerSuperProperties(this.platformSuperProperties);\r\n        }\r\n        this.anonymity = anonymity;\r\n    }\r\n\r\n    private static getRandomAnalyticsId(): string {\r\n        return [...crypto.getRandomValues(new Uint8Array(16))].map((c) => c.toString(16)).join(\"\");\r\n    }\r\n\r\n    public async identifyUser(client: MatrixClient, analyticsIdGenerator: () => string): Promise<void> {\r\n        if (this.anonymity == Anonymity.Pseudonymous) {\r\n            // Check the user's account_data for an analytics ID to use. Storing the ID in account_data allows\r\n            // different devices to send the same ID.\r\n            try {\r\n                const accountData = await client.getAccountDataFromServer(PosthogAnalytics.ANALYTICS_EVENT_TYPE);\r\n                let analyticsID = accountData?.id;\r\n                if (!analyticsID) {\r\n                    // Couldn't retrieve an analytics ID from user settings, so create one and set it on the server.\r\n                    // Note there's a race condition here - if two devices do these steps at the same time, last write\r\n                    // wins, and the first writer will send tracking with an ID that doesn't match the one on the server\r\n                    // until the next time account data is refreshed and this function is called (most likely on next\r\n                    // page load). This will happen pretty infrequently, so we can tolerate the possibility.\r\n                    analyticsID = analyticsIdGenerator();\r\n                    await client.setAccountData(\r\n                        PosthogAnalytics.ANALYTICS_EVENT_TYPE,\r\n                        Object.assign({ id: analyticsID }, accountData),\r\n                    );\r\n                }\r\n                if (this.posthog.get_distinct_id() === analyticsID) {\r\n                    // No point identifying again\r\n                    return;\r\n                }\r\n                if (this.posthog.persistence.get_user_state() === \"identified\") {\r\n                    // Analytics ID has changed, reset as Posthog will refuse to merge in this case\r\n                    this.posthog.reset();\r\n                }\r\n                this.posthog.identify(analyticsID);\r\n            } catch (e) {\r\n                // The above could fail due to network requests, but not essential to starting the application,\r\n                // so swallow it.\r\n                logger.log(\"Unable to identify user for tracking\" + e.toString());\r\n            }\r\n        }\r\n    }\r\n\r\n    public getAnonymity(): Anonymity {\r\n        return this.anonymity;\r\n    }\r\n\r\n    public logout(): void {\r\n        if (this.enabled) {\r\n            this.posthog.reset();\r\n        }\r\n        this.setAnonymity(Anonymity.Disabled);\r\n    }\r\n\r\n    public trackEvent<E extends IPosthogEvent>({ eventName, ...properties }: E, options?: IPostHogEventOptions): void {\r\n        if (this.anonymity == Anonymity.Disabled || this.anonymity == Anonymity.Anonymous) return;\r\n        this.capture(eventName, properties, options);\r\n    }\r\n\r\n    public setProperty<K extends keyof UserProperties>(key: K, value: UserProperties[K]): void {\r\n        if (this.userPropertyCache[key] === value) return; // nothing to do\r\n        this.userPropertyCache[key] = value;\r\n\r\n        if (!this.propertiesForNextEvent[\"$set\"]) {\r\n            this.propertiesForNextEvent[\"$set\"] = {};\r\n        }\r\n        this.propertiesForNextEvent[\"$set\"][key] = value;\r\n    }\r\n\r\n    public setPropertyOnce<K extends keyof UserProperties>(key: K, value: UserProperties[K]): void {\r\n        if (this.userPropertyCache[key]) return; // nothing to do\r\n        this.userPropertyCache[key] = value;\r\n\r\n        if (!this.propertiesForNextEvent[\"$set_once\"]) {\r\n            this.propertiesForNextEvent[\"$set_once\"] = {};\r\n        }\r\n        this.propertiesForNextEvent[\"$set_once\"][key] = value;\r\n    }\r\n\r\n    public async updatePlatformSuperProperties(): Promise<void> {\r\n        // Update super properties in posthog with our platform (app version, platform).\r\n        // These properties will be subsequently passed in every event.\r\n        //\r\n        // This only needs to be done once per page lifetime. Note that getPlatformProperties\r\n        // is async and can involve a network request if we are running in a browser.\r\n        this.platformSuperProperties = await PosthogAnalytics.getPlatformProperties();\r\n        this.registerSuperProperties(this.platformSuperProperties);\r\n    }\r\n\r\n    public async updateAnonymityFromSettings(client: MatrixClient, pseudonymousOptIn: boolean): Promise<void> {\r\n        // Update this.anonymity based on the user's analytics opt-in settings\r\n        const anonymity = pseudonymousOptIn ? Anonymity.Pseudonymous : Anonymity.Disabled;\r\n        this.setAnonymity(anonymity);\r\n        if (anonymity === Anonymity.Pseudonymous) {\r\n            await this.identifyUser(client, PosthogAnalytics.getRandomAnalyticsId);\r\n            if (MatrixClientPeg.currentUserIsJustRegistered()) {\r\n                this.trackNewUserEvent();\r\n            }\r\n        }\r\n\r\n        if (anonymity !== Anonymity.Disabled) {\r\n            await PosthogAnalytics.instance.updatePlatformSuperProperties();\r\n        }\r\n    }\r\n\r\n    public startListeningToSettingsChanges(client: MatrixClient): void {\r\n        // Listen to account data changes from sync so we can observe changes to relevant flags and update.\r\n        // This is called -\r\n        //  * On page load, when the account data is first received by sync\r\n        //  * On login\r\n        //  * When another device changes account data\r\n        //  * When the user changes their preferences on this device\r\n        // Note that for new accounts, pseudonymousAnalyticsOptIn won't be set, so updateAnonymityFromSettings\r\n        // won't be called (i.e. this.anonymity will be left as the default, until the setting changes)\r\n        SettingsStore.watchSetting(\r\n            \"pseudonymousAnalyticsOptIn\",\r\n            null,\r\n            (originalSettingName, changedInRoomId, atLevel, newValueAtLevel, newValue) => {\r\n                this.updateAnonymityFromSettings(client, !!newValue);\r\n            },\r\n        );\r\n    }\r\n\r\n    public setAuthenticationType(authenticationType: Signup[\"authenticationType\"]): void {\r\n        this.authenticationType = authenticationType;\r\n    }\r\n\r\n    private trackNewUserEvent(): void {\r\n        // This is the only event that could have occured before analytics opt-in\r\n        // that we want to accumulate before the user has given consent\r\n        // All other scenarios should not track a user before they have given\r\n        // explicit consent that they are ok with their analytics data being collected\r\n        const options: IPostHogEventOptions = {};\r\n        const registrationTime = parseInt(window.localStorage.getItem(\"mx_registration_time\")!, 10);\r\n        if (!isNaN(registrationTime)) {\r\n            options.timestamp = new Date(registrationTime);\r\n        }\r\n\r\n        return this.trackEvent<Signup>(\r\n            {\r\n                eventName: \"Signup\",\r\n                authenticationType: this.authenticationType,\r\n            },\r\n            options,\r\n        );\r\n    }\r\n}\r\n"],"mappings":"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"}