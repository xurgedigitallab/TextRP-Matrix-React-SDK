{"version":3,"file":"Call.js","names":["_typedEventEmitter","require","_logger","_randomstring","_room2","_roomState","_call","_NamespacedValue","_matrixWidgetApi","_groupCall","_event","_SdkConfig","_interopRequireWildcard","_SettingsStore","_interopRequireDefault","_MediaDeviceHandler","_promise","_WidgetUtils","_WidgetType","_ElementWidgetActions","_WidgetStore","_WidgetMessagingStore","_ActiveWidgetStore","_PlatformPeg","_languageHandler","_DesktopCapturerSourcePicker","_Modal","_FontWatcher","_PosthogAnalytics","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","TIMEOUT_MS","waitForEvent","emitter","event","pred","arguments","length","undefined","listener","wait","Promise","resolve","on","timedOut","timeout","off","Error","ConnectionState","exports","isConnected","state","Connected","Disconnecting","Layout","CallEvent","Call","TypedEventEmitter","messaging","_messaging","value","roomId","widget","connectionState","_connectionState","prevValue","emit","connected","participants","_participants","Participants","constructor","client","_defineProperty2","WidgetUtils","getWidgetUid","getRoom","Disconnected","Map","_room","membership","setDisconnected","uid","widgetUid","logger","log","room","ElementCall","JitsiCall","connect","Connecting","MediaDeviceKindEnum","AudioInput","audioInputs","VideoInput","videoInputs","MediaDeviceHandler","getDevices","audioInput","startWithAudioMuted","deviceId","getAudioInput","find","d","videoInput","startWithVideoMuted","getVideoInput","messagingStore","WidgetMessagingStore","instance","getMessagingForUid","WidgetMessagingStoreEvent","StoreMessaging","widgetApi","e","performConnection","RoomEvent","MyMembership","onMyMembership","StopMessaging","onStopMessaging","window","addEventListener","beforeUnload","disconnect","performDisconnection","removeEventListener","destroy","Destroy","updateParticipants","prevState","addOurDevice","resendDevicesTimer","setInterval","STUCK_DEVICE_TIMEOUT_MS","clearInterval","removeOurDevice","transport","send","ElementWidgetActions","TileLayout","SpotlightLayout","ev","preventDefault","reply","detail","RoomStateEvent","Update","onRoomState","onConnectionState","SettingsStore","getValue","isElementVideoRoom","apps","WidgetStore","getApps","jitsiWidget","app","WidgetType","JITSI","matches","type","data","isVideoChannel","create","addJitsiWidget","CallType","Video","name","participantsExpirationTimer","clearTimeout","now","Date","allExpireAt","Infinity","currentState","getStateEvents","MEMBER_EVENT_TYPE","member","getMember","getStateKey","content","getContent","expiresAt","expires_ts","devices","Array","isArray","filter","userId","getUserId","getDeviceId","Set","localMember","add","setTimeout","updateDevices","fn","getMyMembership","newDevices","newContent","sendStateEvent","clean","myDevices","deviceMap","map","device_id","device","last_seen_ts","from","devicesSet","delete","dontStopMessaging","reject","cleanup","done","HangupCall","onHangup","response","JoinCall","request","label","race","all","ready","force","ActiveWidgetStore","ActiveWidgetStoreEvent","Dock","onDock","Undock","onUndock","layout","_layout","groupCall","accountAnalyticsData","getAccountData","PosthogAnalytics","ANALYTICS_EVENT_TYPE","analyticsID","pseudonymousAnalyticsOptIn","id","params","URLSearchParams","embed","preload","hideHeader","baseUrl","lang","getCurrentLanguage","replace","fontScale","FontWatcher","DEFAULT_SIZE","append","split","font","trim","startsWith","endsWith","slice","forEach","url","URL","SdkConfig","DEFAULTS","element_call","pathname","hash","toString","addVirtualWidget","randomString","creatorUserId","MatrixWidgetType","Custom","Tile","prevParticipants","participantCount","values","size","prevParticipantCount","mayTerminate","terminate","terminationTimer","Math","random","GroupCallState","Ended","Spotlight","PlatformPeg","supportsDesktopCapturer","pending","finished","Modal","createDialog","DesktopCapturerSourcePicker","source","ScreenshareStart","desktopCapturerSourceId","ScreenshareStop","onParticipants","GroupCallEvent","ParticipantsChanged","onGroupCallParticipants","GroupCallStateChanged","onGroupCallState","isCallRoom","groupCallEventHandler","groupCalls","isVideoRoom","GroupCall","GroupCallType","GroupCallIntent","Room","Prompt","cleanMemberState","enteredViaAnotherSession","onTileLayout","onSpotlightLayout","ScreenshareRequest","onScreenshareRequest","destroyPersistentWidget","removeVirtualWidget","setLayout","action","keys","intent","mayClientSendStateEvent","CALL_EVENT_TYPE","NamespacedValue","EventType","GroupCallPrefix","GroupCallMemberPrefix"],"sources":["../../src/models/Call.ts"],"sourcesContent":["/*\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { TypedEventEmitter } from \"matrix-js-sdk/src/models/typed-event-emitter\";\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\nimport { randomString } from \"matrix-js-sdk/src/randomstring\";\r\nimport { MatrixClient } from \"matrix-js-sdk/src/client\";\r\nimport { RoomEvent } from \"matrix-js-sdk/src/models/room\";\r\nimport { RoomStateEvent } from \"matrix-js-sdk/src/models/room-state\";\r\nimport { CallType } from \"matrix-js-sdk/src/webrtc/call\";\r\nimport { NamespacedValue } from \"matrix-js-sdk/src/NamespacedValue\";\r\nimport { IWidgetApiRequest, MatrixWidgetType } from \"matrix-widget-api\";\r\nimport {\r\n    GroupCall,\r\n    GroupCallEvent,\r\n    GroupCallIntent,\r\n    GroupCallState,\r\n    GroupCallType,\r\n} from \"matrix-js-sdk/src/webrtc/groupCall\";\r\nimport { EventType } from \"matrix-js-sdk/src/@types/event\";\r\n\r\nimport type EventEmitter from \"events\";\r\nimport type { IMyDevice } from \"matrix-js-sdk/src/client\";\r\nimport type { Room } from \"matrix-js-sdk/src/models/room\";\r\nimport type { RoomMember } from \"matrix-js-sdk/src/models/room-member\";\r\nimport type { ClientWidgetApi } from \"matrix-widget-api\";\r\nimport type { IApp } from \"../stores/WidgetStore\";\r\nimport SdkConfig, { DEFAULTS } from \"../SdkConfig\";\r\nimport SettingsStore from \"../settings/SettingsStore\";\r\nimport MediaDeviceHandler, { MediaDeviceKindEnum } from \"../MediaDeviceHandler\";\r\nimport { timeout } from \"../utils/promise\";\r\nimport WidgetUtils from \"../utils/WidgetUtils\";\r\nimport { WidgetType } from \"../widgets/WidgetType\";\r\nimport { ElementWidgetActions } from \"../stores/widgets/ElementWidgetActions\";\r\nimport WidgetStore from \"../stores/WidgetStore\";\r\nimport { WidgetMessagingStore, WidgetMessagingStoreEvent } from \"../stores/widgets/WidgetMessagingStore\";\r\nimport ActiveWidgetStore, { ActiveWidgetStoreEvent } from \"../stores/ActiveWidgetStore\";\r\nimport PlatformPeg from \"../PlatformPeg\";\r\nimport { getCurrentLanguage } from \"../languageHandler\";\r\nimport DesktopCapturerSourcePicker from \"../components/views/elements/DesktopCapturerSourcePicker\";\r\nimport Modal from \"../Modal\";\r\nimport { FontWatcher } from \"../settings/watchers/FontWatcher\";\r\nimport { PosthogAnalytics } from \"../PosthogAnalytics\";\r\n\r\nconst TIMEOUT_MS = 16000;\r\n\r\n// Waits until an event is emitted satisfying the given predicate\r\nconst waitForEvent = async (\r\n    emitter: EventEmitter,\r\n    event: string,\r\n    pred: (...args: any[]) => boolean = () => true,\r\n): Promise<void> => {\r\n    let listener: (...args: any[]) => void;\r\n    const wait = new Promise<void>((resolve) => {\r\n        listener = (...args) => {\r\n            if (pred(...args)) resolve();\r\n        };\r\n        emitter.on(event, listener);\r\n    });\r\n\r\n    const timedOut = (await timeout(wait, false, TIMEOUT_MS)) === false;\r\n    emitter.off(event, listener!);\r\n    if (timedOut) throw new Error(\"Timed out\");\r\n};\r\n\r\nexport enum ConnectionState {\r\n    Disconnected = \"disconnected\",\r\n    Connecting = \"connecting\",\r\n    Connected = \"connected\",\r\n    Disconnecting = \"disconnecting\",\r\n}\r\n\r\nexport const isConnected = (state: ConnectionState): boolean =>\r\n    state === ConnectionState.Connected || state === ConnectionState.Disconnecting;\r\n\r\nexport enum Layout {\r\n    Tile = \"tile\",\r\n    Spotlight = \"spotlight\",\r\n}\r\n\r\nexport enum CallEvent {\r\n    ConnectionState = \"connection_state\",\r\n    Participants = \"participants\",\r\n    Layout = \"layout\",\r\n    Destroy = \"destroy\",\r\n}\r\n\r\ninterface CallEventHandlerMap {\r\n    [CallEvent.ConnectionState]: (state: ConnectionState, prevState: ConnectionState) => void;\r\n    [CallEvent.Participants]: (\r\n        participants: Map<RoomMember, Set<string>>,\r\n        prevParticipants: Map<RoomMember, Set<string>>,\r\n    ) => void;\r\n    [CallEvent.Layout]: (layout: Layout) => void;\r\n    [CallEvent.Destroy]: () => void;\r\n}\r\n\r\n/**\r\n * A group call accessed through a widget.\r\n */\r\nexport abstract class Call extends TypedEventEmitter<CallEvent, CallEventHandlerMap> {\r\n    protected readonly widgetUid = WidgetUtils.getWidgetUid(this.widget);\r\n    protected readonly room = this.client.getRoom(this.roomId)!;\r\n\r\n    /**\r\n     * The time after which device member state should be considered expired.\r\n     */\r\n    public abstract readonly STUCK_DEVICE_TIMEOUT_MS: number;\r\n\r\n    private _messaging: ClientWidgetApi | null = null;\r\n    /**\r\n     * The widget's messaging, or null if disconnected.\r\n     */\r\n    protected get messaging(): ClientWidgetApi | null {\r\n        return this._messaging;\r\n    }\r\n    private set messaging(value: ClientWidgetApi | null) {\r\n        this._messaging = value;\r\n    }\r\n\r\n    public get roomId(): string {\r\n        return this.widget.roomId;\r\n    }\r\n\r\n    private _connectionState = ConnectionState.Disconnected;\r\n    public get connectionState(): ConnectionState {\r\n        return this._connectionState;\r\n    }\r\n    protected set connectionState(value: ConnectionState) {\r\n        const prevValue = this._connectionState;\r\n        this._connectionState = value;\r\n        this.emit(CallEvent.ConnectionState, value, prevValue);\r\n    }\r\n\r\n    public get connected(): boolean {\r\n        return isConnected(this.connectionState);\r\n    }\r\n\r\n    private _participants = new Map<RoomMember, Set<string>>();\r\n    /**\r\n     * The participants in the call, as a map from members to device IDs.\r\n     */\r\n    public get participants(): Map<RoomMember, Set<string>> {\r\n        return this._participants;\r\n    }\r\n    protected set participants(value: Map<RoomMember, Set<string>>) {\r\n        const prevValue = this._participants;\r\n        this._participants = value;\r\n        this.emit(CallEvent.Participants, value, prevValue);\r\n    }\r\n\r\n    public constructor(\r\n        /**\r\n         * The widget used to access this call.\r\n         */\r\n        public readonly widget: IApp,\r\n        protected readonly client: MatrixClient,\r\n    ) {\r\n        super();\r\n    }\r\n\r\n    /**\r\n     * Gets the call associated with the given room, if any.\r\n     * @param {Room} room The room.\r\n     * @returns {Call | null} The call.\r\n     */\r\n    public static get(room: Room): Call | null {\r\n        return ElementCall.get(room) ?? JitsiCall.get(room);\r\n    }\r\n\r\n    /**\r\n     * Performs a routine check of the call's associated room state, cleaning up\r\n     * any data left over from an unclean disconnection.\r\n     */\r\n    public abstract clean(): Promise<void>;\r\n\r\n    /**\r\n     * Contacts the widget to connect to the call.\r\n     * @param {MediaDeviceInfo | null} audioInput The audio input to use, or\r\n     *   null to start muted.\r\n     * @param {MediaDeviceInfo | null} audioInput The video input to use, or\r\n     *   null to start muted.\r\n     */\r\n    protected abstract performConnection(\r\n        audioInput: MediaDeviceInfo | null,\r\n        videoInput: MediaDeviceInfo | null,\r\n    ): Promise<void>;\r\n\r\n    /**\r\n     * Contacts the widget to disconnect from the call.\r\n     */\r\n    protected abstract performDisconnection(): Promise<void>;\r\n\r\n    /**\r\n     * Connects the user to the call using the media devices set in\r\n     * MediaDeviceHandler. The widget associated with the call must be active\r\n     * for this to succeed.\r\n     */\r\n    public async connect(): Promise<void> {\r\n        this.connectionState = ConnectionState.Connecting;\r\n\r\n        const { [MediaDeviceKindEnum.AudioInput]: audioInputs, [MediaDeviceKindEnum.VideoInput]: videoInputs } =\r\n            (await MediaDeviceHandler.getDevices())!;\r\n\r\n        let audioInput: MediaDeviceInfo | null = null;\r\n        if (!MediaDeviceHandler.startWithAudioMuted) {\r\n            const deviceId = MediaDeviceHandler.getAudioInput();\r\n            audioInput = audioInputs.find((d) => d.deviceId === deviceId) ?? audioInputs[0] ?? null;\r\n        }\r\n        let videoInput: MediaDeviceInfo | null = null;\r\n        if (!MediaDeviceHandler.startWithVideoMuted) {\r\n            const deviceId = MediaDeviceHandler.getVideoInput();\r\n            videoInput = videoInputs.find((d) => d.deviceId === deviceId) ?? videoInputs[0] ?? null;\r\n        }\r\n\r\n        const messagingStore = WidgetMessagingStore.instance;\r\n        this.messaging = messagingStore.getMessagingForUid(this.widgetUid) ?? null;\r\n        if (!this.messaging) {\r\n            // The widget might still be initializing, so wait for it\r\n            try {\r\n                await waitForEvent(\r\n                    messagingStore,\r\n                    WidgetMessagingStoreEvent.StoreMessaging,\r\n                    (uid: string, widgetApi: ClientWidgetApi) => {\r\n                        if (uid === this.widgetUid) {\r\n                            this.messaging = widgetApi;\r\n                            return true;\r\n                        }\r\n                        return false;\r\n                    },\r\n                );\r\n            } catch (e) {\r\n                throw new Error(`Failed to bind call widget in room ${this.roomId}: ${e}`);\r\n            }\r\n        }\r\n\r\n        try {\r\n            await this.performConnection(audioInput, videoInput);\r\n        } catch (e) {\r\n            this.connectionState = ConnectionState.Disconnected;\r\n            throw e;\r\n        }\r\n\r\n        this.room.on(RoomEvent.MyMembership, this.onMyMembership);\r\n        WidgetMessagingStore.instance.on(WidgetMessagingStoreEvent.StopMessaging, this.onStopMessaging);\r\n        window.addEventListener(\"beforeunload\", this.beforeUnload);\r\n        this.connectionState = ConnectionState.Connected;\r\n    }\r\n\r\n    /**\r\n     * Disconnects the user from the call.\r\n     */\r\n    public async disconnect(): Promise<void> {\r\n        if (this.connectionState !== ConnectionState.Connected) throw new Error(\"Not connected\");\r\n\r\n        this.connectionState = ConnectionState.Disconnecting;\r\n        await this.performDisconnection();\r\n        this.setDisconnected();\r\n    }\r\n\r\n    /**\r\n     * Manually marks the call as disconnected and cleans up.\r\n     */\r\n    public setDisconnected(): void {\r\n        this.room.off(RoomEvent.MyMembership, this.onMyMembership);\r\n        WidgetMessagingStore.instance.off(WidgetMessagingStoreEvent.StopMessaging, this.onStopMessaging);\r\n        window.removeEventListener(\"beforeunload\", this.beforeUnload);\r\n        this.messaging = null;\r\n        this.connectionState = ConnectionState.Disconnected;\r\n    }\r\n\r\n    /**\r\n     * Stops all internal timers and tasks to prepare for garbage collection.\r\n     */\r\n    public destroy(): void {\r\n        if (this.connected) this.setDisconnected();\r\n        this.emit(CallEvent.Destroy);\r\n    }\r\n\r\n    private onMyMembership = async (_room: Room, membership: string): Promise<void> => {\r\n        if (membership !== \"join\") this.setDisconnected();\r\n    };\r\n\r\n    private onStopMessaging = (uid: string): void => {\r\n        if (uid === this.widgetUid) {\r\n            logger.log(\"The widget died; treating this as a user hangup\");\r\n            this.setDisconnected();\r\n        }\r\n    };\r\n\r\n    private beforeUnload = (): void => this.setDisconnected();\r\n}\r\n\r\nexport interface JitsiCallMemberContent {\r\n    // Connected device IDs\r\n    devices: string[];\r\n    // Time at which this state event should be considered stale\r\n    expires_ts: number;\r\n}\r\n\r\n/**\r\n * A group call using Jitsi as a backend.\r\n */\r\nexport class JitsiCall extends Call {\r\n    public static readonly MEMBER_EVENT_TYPE = \"io.element.video.member\";\r\n    public readonly STUCK_DEVICE_TIMEOUT_MS = 1000 * 60 * 60; // 1 hour\r\n\r\n    private resendDevicesTimer: number | null = null;\r\n    private participantsExpirationTimer: number | null = null;\r\n\r\n    private constructor(widget: IApp, client: MatrixClient) {\r\n        super(widget, client);\r\n\r\n        this.room.on(RoomStateEvent.Update, this.onRoomState);\r\n        this.on(CallEvent.ConnectionState, this.onConnectionState);\r\n        this.updateParticipants();\r\n    }\r\n\r\n    public static get(room: Room): JitsiCall | null {\r\n        // Only supported in video rooms\r\n        if (SettingsStore.getValue(\"feature_video_rooms\") && room.isElementVideoRoom()) {\r\n            const apps = WidgetStore.instance.getApps(room.roomId);\r\n            // The isVideoChannel field differentiates rich Jitsi calls from bare Jitsi widgets\r\n            const jitsiWidget = apps.find((app) => WidgetType.JITSI.matches(app.type) && app.data?.isVideoChannel);\r\n            if (jitsiWidget) return new JitsiCall(jitsiWidget, room.client);\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    public static async create(room: Room): Promise<void> {\r\n        await WidgetUtils.addJitsiWidget(room.client, room.roomId, CallType.Video, \"Group call\", true, room.name);\r\n    }\r\n\r\n    private updateParticipants(): void {\r\n        if (this.participantsExpirationTimer !== null) {\r\n            clearTimeout(this.participantsExpirationTimer);\r\n            this.participantsExpirationTimer = null;\r\n        }\r\n\r\n        const participants = new Map<RoomMember, Set<string>>();\r\n        const now = Date.now();\r\n        let allExpireAt = Infinity;\r\n\r\n        for (const e of this.room.currentState.getStateEvents(JitsiCall.MEMBER_EVENT_TYPE)) {\r\n            const member = this.room.getMember(e.getStateKey()!);\r\n            const content = e.getContent<JitsiCallMemberContent>();\r\n            const expiresAt = typeof content.expires_ts === \"number\" ? content.expires_ts : -Infinity;\r\n            let devices =\r\n                expiresAt > now && Array.isArray(content.devices)\r\n                    ? content.devices.filter((d) => typeof d === \"string\")\r\n                    : [];\r\n\r\n            // Apply local echo for the disconnected case\r\n            if (!this.connected && member?.userId === this.client.getUserId()) {\r\n                devices = devices.filter((d) => d !== this.client.getDeviceId());\r\n            }\r\n            // Must have a connected device and still be joined to the room\r\n            if (devices.length > 0 && member?.membership === \"join\") {\r\n                participants.set(member, new Set(devices));\r\n                if (expiresAt < allExpireAt) allExpireAt = expiresAt;\r\n            }\r\n        }\r\n\r\n        // Apply local echo for the connected case\r\n        if (this.connected) {\r\n            const localMember = this.room.getMember(this.client.getUserId()!)!;\r\n            let devices = participants.get(localMember);\r\n            if (devices === undefined) {\r\n                devices = new Set();\r\n                participants.set(localMember, devices);\r\n            }\r\n\r\n            devices.add(this.client.getDeviceId()!);\r\n        }\r\n\r\n        this.participants = participants;\r\n        if (allExpireAt < Infinity) {\r\n            this.participantsExpirationTimer = window.setTimeout(() => this.updateParticipants(), allExpireAt - now);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Updates our member state with the devices returned by the given function.\r\n     * @param fn A function from the current devices to the new devices. If it\r\n     *     returns null, the update is skipped.\r\n     */\r\n    private async updateDevices(fn: (devices: string[]) => string[] | null): Promise<void> {\r\n        if (this.room.getMyMembership() !== \"join\") return;\r\n\r\n        const event = this.room.currentState.getStateEvents(JitsiCall.MEMBER_EVENT_TYPE, this.client.getUserId()!);\r\n        const content = event?.getContent<JitsiCallMemberContent>();\r\n        const expiresAt = typeof content?.expires_ts === \"number\" ? content.expires_ts : -Infinity;\r\n        const devices = expiresAt > Date.now() && Array.isArray(content?.devices) ? content!.devices : [];\r\n        const newDevices = fn(devices);\r\n\r\n        if (newDevices !== null) {\r\n            const newContent: JitsiCallMemberContent = {\r\n                devices: newDevices,\r\n                expires_ts: Date.now() + this.STUCK_DEVICE_TIMEOUT_MS,\r\n            };\r\n\r\n            await this.client.sendStateEvent(\r\n                this.roomId,\r\n                JitsiCall.MEMBER_EVENT_TYPE,\r\n                newContent,\r\n                this.client.getUserId()!,\r\n            );\r\n        }\r\n    }\r\n\r\n    public async clean(): Promise<void> {\r\n        const now = Date.now();\r\n        const { devices: myDevices } = await this.client.getDevices();\r\n        const deviceMap = new Map<string, IMyDevice>(myDevices.map((d) => [d.device_id, d]));\r\n\r\n        // Clean up our member state by filtering out logged out devices,\r\n        // inactive devices, and our own device (if we're disconnected)\r\n        await this.updateDevices((devices) => {\r\n            const newDevices = devices.filter((d) => {\r\n                const device = deviceMap.get(d);\r\n                return (\r\n                    device?.last_seen_ts !== undefined &&\r\n                    !(d === this.client.getDeviceId() && !this.connected) &&\r\n                    now - device.last_seen_ts < this.STUCK_DEVICE_TIMEOUT_MS\r\n                );\r\n            });\r\n\r\n            // Skip the update if the devices are unchanged\r\n            return newDevices.length === devices.length ? null : newDevices;\r\n        });\r\n    }\r\n\r\n    private async addOurDevice(): Promise<void> {\r\n        await this.updateDevices((devices) => Array.from(new Set(devices).add(this.client.getDeviceId()!)));\r\n    }\r\n\r\n    private async removeOurDevice(): Promise<void> {\r\n        await this.updateDevices((devices) => {\r\n            const devicesSet = new Set(devices);\r\n            devicesSet.delete(this.client.getDeviceId()!);\r\n            return Array.from(devicesSet);\r\n        });\r\n    }\r\n\r\n    protected async performConnection(\r\n        audioInput: MediaDeviceInfo | null,\r\n        videoInput: MediaDeviceInfo | null,\r\n    ): Promise<void> {\r\n        // Ensure that the messaging doesn't get stopped while we're waiting for responses\r\n        const dontStopMessaging = new Promise<void>((resolve, reject) => {\r\n            const messagingStore = WidgetMessagingStore.instance;\r\n\r\n            const listener = (uid: string): void => {\r\n                if (uid === this.widgetUid) {\r\n                    cleanup();\r\n                    reject(new Error(\"Messaging stopped\"));\r\n                }\r\n            };\r\n            const done = (): void => {\r\n                cleanup();\r\n                resolve();\r\n            };\r\n            const cleanup = (): void => {\r\n                messagingStore.off(WidgetMessagingStoreEvent.StopMessaging, listener);\r\n                this.off(CallEvent.ConnectionState, done);\r\n            };\r\n\r\n            messagingStore.on(WidgetMessagingStoreEvent.StopMessaging, listener);\r\n            this.on(CallEvent.ConnectionState, done);\r\n        });\r\n\r\n        // Empirically, it's possible for Jitsi Meet to crash instantly at startup,\r\n        // sending a hangup event that races with the rest of this method, so we need\r\n        // to add the hangup listener now rather than later\r\n        this.messaging!.on(`action:${ElementWidgetActions.HangupCall}`, this.onHangup);\r\n\r\n        // Actually perform the join\r\n        const response = waitForEvent(\r\n            this.messaging!,\r\n            `action:${ElementWidgetActions.JoinCall}`,\r\n            (ev: CustomEvent<IWidgetApiRequest>) => {\r\n                ev.preventDefault();\r\n                this.messaging!.transport.reply(ev.detail, {}); // ack\r\n                return true;\r\n            },\r\n        );\r\n        const request = this.messaging!.transport.send(ElementWidgetActions.JoinCall, {\r\n            audioInput: audioInput?.label ?? null,\r\n            videoInput: videoInput?.label ?? null,\r\n        });\r\n        try {\r\n            await Promise.race([Promise.all([request, response]), dontStopMessaging]);\r\n        } catch (e) {\r\n            // If it timed out, clean up our advance preparations\r\n            this.messaging!.off(`action:${ElementWidgetActions.HangupCall}`, this.onHangup);\r\n\r\n            if (this.messaging!.transport.ready) {\r\n                // The messaging still exists, which means Jitsi might still be going in the background\r\n                this.messaging!.transport.send(ElementWidgetActions.HangupCall, { force: true });\r\n            }\r\n\r\n            throw new Error(`Failed to join call in room ${this.roomId}: ${e}`);\r\n        }\r\n\r\n        ActiveWidgetStore.instance.on(ActiveWidgetStoreEvent.Dock, this.onDock);\r\n        ActiveWidgetStore.instance.on(ActiveWidgetStoreEvent.Undock, this.onUndock);\r\n    }\r\n\r\n    protected async performDisconnection(): Promise<void> {\r\n        const response = waitForEvent(\r\n            this.messaging!,\r\n            `action:${ElementWidgetActions.HangupCall}`,\r\n            (ev: CustomEvent<IWidgetApiRequest>) => {\r\n                ev.preventDefault();\r\n                this.messaging!.transport.reply(ev.detail, {}); // ack\r\n                return true;\r\n            },\r\n        );\r\n        const request = this.messaging!.transport.send(ElementWidgetActions.HangupCall, {});\r\n        try {\r\n            await Promise.all([request, response]);\r\n        } catch (e) {\r\n            throw new Error(`Failed to hangup call in room ${this.roomId}: ${e}`);\r\n        }\r\n    }\r\n\r\n    public setDisconnected(): void {\r\n        this.messaging!.off(`action:${ElementWidgetActions.HangupCall}`, this.onHangup);\r\n        ActiveWidgetStore.instance.off(ActiveWidgetStoreEvent.Dock, this.onDock);\r\n        ActiveWidgetStore.instance.off(ActiveWidgetStoreEvent.Undock, this.onUndock);\r\n\r\n        super.setDisconnected();\r\n    }\r\n\r\n    public destroy(): void {\r\n        this.room.off(RoomStateEvent.Update, this.onRoomState);\r\n        this.on(CallEvent.ConnectionState, this.onConnectionState);\r\n        if (this.participantsExpirationTimer !== null) {\r\n            clearTimeout(this.participantsExpirationTimer);\r\n            this.participantsExpirationTimer = null;\r\n        }\r\n        if (this.resendDevicesTimer !== null) {\r\n            clearInterval(this.resendDevicesTimer);\r\n            this.resendDevicesTimer = null;\r\n        }\r\n\r\n        super.destroy();\r\n    }\r\n\r\n    private onRoomState = (): void => this.updateParticipants();\r\n\r\n    private onConnectionState = async (state: ConnectionState, prevState: ConnectionState): Promise<void> => {\r\n        if (state === ConnectionState.Connected && !isConnected(prevState)) {\r\n            this.updateParticipants(); // Local echo\r\n\r\n            // Tell others that we're connected, by adding our device to room state\r\n            await this.addOurDevice();\r\n            // Re-add this device every so often so our video member event doesn't become stale\r\n            this.resendDevicesTimer = window.setInterval(async (): Promise<void> => {\r\n                logger.log(`Resending video member event for ${this.roomId}`);\r\n                await this.addOurDevice();\r\n            }, (this.STUCK_DEVICE_TIMEOUT_MS * 3) / 4);\r\n        } else if (state === ConnectionState.Disconnected && isConnected(prevState)) {\r\n            this.updateParticipants(); // Local echo\r\n\r\n            if (this.resendDevicesTimer !== null) {\r\n                clearInterval(this.resendDevicesTimer);\r\n                this.resendDevicesTimer = null;\r\n            }\r\n            // Tell others that we're disconnected, by removing our device from room state\r\n            await this.removeOurDevice();\r\n        }\r\n    };\r\n\r\n    private onDock = async (): Promise<void> => {\r\n        // The widget is no longer a PiP, so let's restore the default layout\r\n        await this.messaging!.transport.send(ElementWidgetActions.TileLayout, {});\r\n    };\r\n\r\n    private onUndock = async (): Promise<void> => {\r\n        // The widget has become a PiP, so let's switch Jitsi to spotlight mode\r\n        // to only show the active speaker and economize on space\r\n        await this.messaging!.transport.send(ElementWidgetActions.SpotlightLayout, {});\r\n    };\r\n\r\n    private onHangup = async (ev: CustomEvent<IWidgetApiRequest>): Promise<void> => {\r\n        // If we're already in the middle of a client-initiated disconnection,\r\n        // ignore the event\r\n        if (this.connectionState === ConnectionState.Disconnecting) return;\r\n\r\n        ev.preventDefault();\r\n\r\n        // In case this hangup is caused by Jitsi Meet crashing at startup,\r\n        // wait for the connection event in order to avoid racing\r\n        if (this.connectionState === ConnectionState.Connecting) {\r\n            await waitForEvent(this, CallEvent.ConnectionState);\r\n        }\r\n\r\n        await this.messaging!.transport.reply(ev.detail, {}); // ack\r\n        this.setDisconnected();\r\n    };\r\n}\r\n\r\n/**\r\n * A group call using MSC3401 and Element Call as a backend.\r\n * (somewhat cheekily named)\r\n */\r\nexport class ElementCall extends Call {\r\n    public static readonly CALL_EVENT_TYPE = new NamespacedValue(null, EventType.GroupCallPrefix);\r\n    public static readonly MEMBER_EVENT_TYPE = new NamespacedValue(null, EventType.GroupCallMemberPrefix);\r\n    public readonly STUCK_DEVICE_TIMEOUT_MS = 1000 * 60 * 60; // 1 hour\r\n\r\n    private terminationTimer: number | null = null;\r\n\r\n    private _layout = Layout.Tile;\r\n    public get layout(): Layout {\r\n        return this._layout;\r\n    }\r\n    protected set layout(value: Layout) {\r\n        this._layout = value;\r\n        this.emit(CallEvent.Layout, value);\r\n    }\r\n\r\n    private constructor(public readonly groupCall: GroupCall, client: MatrixClient) {\r\n        const accountAnalyticsData = client.getAccountData(PosthogAnalytics.ANALYTICS_EVENT_TYPE);\r\n        // The analyticsID is passed directly to element call (EC) since this codepath is only for EC and no other widget.\r\n        // We really don't want the same analyticID's for the EC and EW posthog instances (Data on posthog should be limited/anonymized as much as possible).\r\n        // This is prohibited in EC where a hashed version of the analyticsID is used for the actual posthog identification.\r\n        // We can pass the raw EW analyticsID here since we need to trust EC with not sending sensitive data to posthog (EC has access to more sensible data than the analyticsID e.g. the username)\r\n        const analyticsID: string = accountAnalyticsData?.getContent().pseudonymousAnalyticsOptIn\r\n            ? accountAnalyticsData?.getContent().id\r\n            : \"\";\r\n\r\n        // Splice together the Element Call URL for this call\r\n        const params = new URLSearchParams({\r\n            embed: \"\",\r\n            preload: \"\",\r\n            hideHeader: \"\",\r\n            userId: client.getUserId()!,\r\n            deviceId: client.getDeviceId()!,\r\n            roomId: groupCall.room.roomId,\r\n            baseUrl: client.baseUrl,\r\n            lang: getCurrentLanguage().replace(\"_\", \"-\"),\r\n            fontScale: `${SettingsStore.getValue(\"baseFontSize\") / FontWatcher.DEFAULT_SIZE}`,\r\n            analyticsID,\r\n        });\r\n\r\n        if (SettingsStore.getValue(\"fallbackICEServerAllowed\")) params.append(\"allowIceFallback\", \"\");\r\n\r\n        // Set custom fonts\r\n        if (SettingsStore.getValue(\"useSystemFont\")) {\r\n            SettingsStore.getValue<string>(\"systemFont\")\r\n                .split(\",\")\r\n                .map((font) => {\r\n                    // Strip whitespace and quotes\r\n                    font = font.trim();\r\n                    if (font.startsWith('\"') && font.endsWith('\"')) font = font.slice(1, -1);\r\n                    return font;\r\n                })\r\n                .forEach((font) => params.append(\"font\", font));\r\n        }\r\n\r\n        const url = new URL(SdkConfig.get(\"element_call\").url ?? DEFAULTS.element_call.url!);\r\n        url.pathname = \"/room\";\r\n        url.hash = `#?${params.toString()}`;\r\n\r\n        // To use Element Call without touching room state, we create a virtual\r\n        // widget (one that doesn't have a corresponding state event)\r\n        super(\r\n            WidgetStore.instance.addVirtualWidget(\r\n                {\r\n                    id: randomString(24), // So that it's globally unique\r\n                    creatorUserId: client.getUserId()!,\r\n                    name: \"Element Call\",\r\n                    type: MatrixWidgetType.Custom,\r\n                    url: url.toString(),\r\n                },\r\n                groupCall.room.roomId,\r\n            ),\r\n            client,\r\n        );\r\n\r\n        this.on(CallEvent.Participants, this.onParticipants);\r\n        groupCall.on(GroupCallEvent.ParticipantsChanged, this.onGroupCallParticipants);\r\n        groupCall.on(GroupCallEvent.GroupCallStateChanged, this.onGroupCallState);\r\n\r\n        this.updateParticipants();\r\n    }\r\n\r\n    public static get(room: Room): ElementCall | null {\r\n        // Only supported in the new group call experience or in video rooms\r\n        if (\r\n            SettingsStore.getValue(\"feature_group_calls\") ||\r\n            (SettingsStore.getValue(\"feature_video_rooms\") &&\r\n                SettingsStore.getValue(\"feature_element_call_video_rooms\") &&\r\n                room.isCallRoom())\r\n        ) {\r\n            const groupCall = room.client.groupCallEventHandler!.groupCalls.get(room.roomId);\r\n            if (groupCall !== undefined) return new ElementCall(groupCall, room.client);\r\n        }\r\n\r\n        return null;\r\n    }\r\n\r\n    public static async create(room: Room): Promise<void> {\r\n        const isVideoRoom =\r\n            SettingsStore.getValue(\"feature_video_rooms\") &&\r\n            SettingsStore.getValue(\"feature_element_call_video_rooms\") &&\r\n            room.isCallRoom();\r\n\r\n        const groupCall = new GroupCall(\r\n            room.client,\r\n            room,\r\n            GroupCallType.Video,\r\n            false,\r\n            isVideoRoom ? GroupCallIntent.Room : GroupCallIntent.Prompt,\r\n        );\r\n\r\n        await groupCall.create();\r\n    }\r\n\r\n    public clean(): Promise<void> {\r\n        return this.groupCall.cleanMemberState();\r\n    }\r\n\r\n    protected async performConnection(\r\n        audioInput: MediaDeviceInfo | null,\r\n        videoInput: MediaDeviceInfo | null,\r\n    ): Promise<void> {\r\n        try {\r\n            await this.messaging!.transport.send(ElementWidgetActions.JoinCall, {\r\n                audioInput: audioInput?.label ?? null,\r\n                videoInput: videoInput?.label ?? null,\r\n            });\r\n        } catch (e) {\r\n            throw new Error(`Failed to join call in room ${this.roomId}: ${e}`);\r\n        }\r\n\r\n        this.groupCall.enteredViaAnotherSession = true;\r\n        this.messaging!.on(`action:${ElementWidgetActions.HangupCall}`, this.onHangup);\r\n        this.messaging!.on(`action:${ElementWidgetActions.TileLayout}`, this.onTileLayout);\r\n        this.messaging!.on(`action:${ElementWidgetActions.SpotlightLayout}`, this.onSpotlightLayout);\r\n        this.messaging!.on(`action:${ElementWidgetActions.ScreenshareRequest}`, this.onScreenshareRequest);\r\n    }\r\n\r\n    protected async performDisconnection(): Promise<void> {\r\n        try {\r\n            await this.messaging!.transport.send(ElementWidgetActions.HangupCall, {});\r\n        } catch (e) {\r\n            throw new Error(`Failed to hangup call in room ${this.roomId}: ${e}`);\r\n        }\r\n    }\r\n\r\n    public setDisconnected(): void {\r\n        this.messaging!.off(`action:${ElementWidgetActions.HangupCall}`, this.onHangup);\r\n        this.messaging!.off(`action:${ElementWidgetActions.TileLayout}`, this.onTileLayout);\r\n        this.messaging!.off(`action:${ElementWidgetActions.SpotlightLayout}`, this.onSpotlightLayout);\r\n        this.messaging!.off(`action:${ElementWidgetActions.ScreenshareRequest}`, this.onScreenshareRequest);\r\n        super.setDisconnected();\r\n        this.groupCall.enteredViaAnotherSession = false;\r\n    }\r\n\r\n    public destroy(): void {\r\n        ActiveWidgetStore.instance.destroyPersistentWidget(this.widget.id, this.groupCall.room.roomId);\r\n        WidgetStore.instance.removeVirtualWidget(this.widget.id, this.groupCall.room.roomId);\r\n        this.off(CallEvent.Participants, this.onParticipants);\r\n        this.groupCall.off(GroupCallEvent.ParticipantsChanged, this.onGroupCallParticipants);\r\n        this.groupCall.off(GroupCallEvent.GroupCallStateChanged, this.onGroupCallState);\r\n\r\n        if (this.terminationTimer !== null) {\r\n            clearTimeout(this.terminationTimer);\r\n            this.terminationTimer = null;\r\n        }\r\n\r\n        super.destroy();\r\n    }\r\n\r\n    /**\r\n     * Sets the call's layout.\r\n     * @param layout The layout to switch to.\r\n     */\r\n    public async setLayout(layout: Layout): Promise<void> {\r\n        const action = layout === Layout.Tile ? ElementWidgetActions.TileLayout : ElementWidgetActions.SpotlightLayout;\r\n\r\n        await this.messaging!.transport.send(action, {});\r\n    }\r\n\r\n    private updateParticipants(): void {\r\n        const participants = new Map<RoomMember, Set<string>>();\r\n\r\n        for (const [member, deviceMap] of this.groupCall.participants) {\r\n            participants.set(member, new Set(deviceMap.keys()));\r\n        }\r\n\r\n        this.participants = participants;\r\n    }\r\n\r\n    private get mayTerminate(): boolean {\r\n        return (\r\n            this.groupCall.intent !== GroupCallIntent.Room &&\r\n            this.room.currentState.mayClientSendStateEvent(ElementCall.CALL_EVENT_TYPE.name, this.client)\r\n        );\r\n    }\r\n\r\n    private onParticipants = async (\r\n        participants: Map<RoomMember, Set<string>>,\r\n        prevParticipants: Map<RoomMember, Set<string>>,\r\n    ): Promise<void> => {\r\n        let participantCount = 0;\r\n        for (const devices of participants.values()) participantCount += devices.size;\r\n\r\n        let prevParticipantCount = 0;\r\n        for (const devices of prevParticipants.values()) prevParticipantCount += devices.size;\r\n\r\n        // If the last participant disconnected, terminate the call\r\n        if (participantCount === 0 && prevParticipantCount > 0 && this.mayTerminate) {\r\n            if (prevParticipants.get(this.room.getMember(this.client.getUserId()!)!)?.has(this.client.getDeviceId()!)) {\r\n                // If we were that last participant, do the termination ourselves\r\n                await this.groupCall.terminate();\r\n            } else {\r\n                // We don't appear to have been the last participant, but because of\r\n                // the potential for races, users lacking permission, and a myriad of\r\n                // other reasons, we can't rely on other clients to terminate the call.\r\n                // Since it's likely that other clients are using this same logic, we wait\r\n                // randomly between 2 and 8 seconds before terminating the call, to\r\n                // probabilistically reduce event spam. If someone else beats us to it,\r\n                // this timer will be automatically cleared upon the call's destruction.\r\n                this.terminationTimer = window.setTimeout(\r\n                    () => this.groupCall.terminate(),\r\n                    Math.random() * 6000 + 2000,\r\n                );\r\n            }\r\n        }\r\n    };\r\n\r\n    private onGroupCallParticipants = (): void => this.updateParticipants();\r\n\r\n    private onGroupCallState = (state: GroupCallState): void => {\r\n        if (state === GroupCallState.Ended) this.destroy();\r\n    };\r\n\r\n    private onHangup = async (ev: CustomEvent<IWidgetApiRequest>): Promise<void> => {\r\n        ev.preventDefault();\r\n        await this.messaging!.transport.reply(ev.detail, {}); // ack\r\n        this.setDisconnected();\r\n    };\r\n\r\n    private onTileLayout = async (ev: CustomEvent<IWidgetApiRequest>): Promise<void> => {\r\n        ev.preventDefault();\r\n        this.layout = Layout.Tile;\r\n        await this.messaging!.transport.reply(ev.detail, {}); // ack\r\n    };\r\n\r\n    private onSpotlightLayout = async (ev: CustomEvent<IWidgetApiRequest>): Promise<void> => {\r\n        ev.preventDefault();\r\n        this.layout = Layout.Spotlight;\r\n        await this.messaging!.transport.reply(ev.detail, {}); // ack\r\n    };\r\n\r\n    private onScreenshareRequest = async (ev: CustomEvent<IWidgetApiRequest>): Promise<void> => {\r\n        ev.preventDefault();\r\n\r\n        if (PlatformPeg.get()?.supportsDesktopCapturer()) {\r\n            await this.messaging!.transport.reply(ev.detail, { pending: true });\r\n\r\n            const { finished } = Modal.createDialog(DesktopCapturerSourcePicker);\r\n            const [source] = await finished;\r\n\r\n            if (source) {\r\n                await this.messaging!.transport.send(ElementWidgetActions.ScreenshareStart, {\r\n                    desktopCapturerSourceId: source,\r\n                });\r\n            } else {\r\n                await this.messaging!.transport.send(ElementWidgetActions.ScreenshareStop, {});\r\n            }\r\n        } else {\r\n            await this.messaging!.transport.reply(ev.detail, { pending: false });\r\n        }\r\n    };\r\n}\r\n"],"mappings":"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"}