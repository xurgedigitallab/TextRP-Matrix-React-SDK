{"version":3,"file":"VectorPushRulesDefinitions.js","names":["_PushRules","require","_logger","_languageHandler","_StandardActions","_PushRuleVectorState","_NotificationUtils","VectorPushRuleDefinition","constructor","opts","_defineProperty2","default","description","vectorStateToActions","syncedRuleIds","ruleToVectorState","rule","enabled","state","Object","values","PushRuleVectorState","states","JSON","stringify","NotificationUtils","decodeActions","actions","logger","error","undefined","VectorPushRulesDefinitions","_td","VectorState","On","StandardActions","ACTION_NOTIFY","Loud","ACTION_HIGHLIGHT_DEFAULT_SOUND","Off","ACTION_DISABLED","ACTION_HIGHLIGHT","ACTION_NOTIFY_DEFAULT_SOUND","ACTION_DONT_NOTIFY","RuleId","PollStartOneToOne","PollStartOneToOneUnstable","PollEndOneToOne","PollEndOneToOneUnstable","PollStart","PollStartUnstable","PollEnd","PollEndUnstable","ACTION_NOTIFY_RING_SOUND","exports"],"sources":["../../src/notifications/VectorPushRulesDefinitions.ts"],"sourcesContent":["/*\r\nCopyright 2016 - 2022 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { IAnnotatedPushRule, PushRuleAction, RuleId } from \"matrix-js-sdk/src/@types/PushRules\";\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\n\r\nimport { _td } from \"../languageHandler\";\r\nimport { StandardActions } from \"./StandardActions\";\r\nimport { PushRuleVectorState, VectorState } from \"./PushRuleVectorState\";\r\nimport { NotificationUtils } from \"./NotificationUtils\";\r\n\r\ntype StateToActionsMap = {\r\n    [state in VectorState]?: PushRuleAction[];\r\n};\r\n\r\ninterface IVectorPushRuleDefinition {\r\n    description: string;\r\n    vectorStateToActions: StateToActionsMap;\r\n    /**\r\n     * Rules that should be updated to be kept in sync\r\n     * when this rule changes\r\n     */\r\n    syncedRuleIds?: (RuleId | string)[];\r\n}\r\n\r\nclass VectorPushRuleDefinition {\r\n    public readonly description: string;\r\n    public readonly vectorStateToActions: StateToActionsMap;\r\n    public readonly syncedRuleIds?: (RuleId | string)[];\r\n\r\n    public constructor(opts: IVectorPushRuleDefinition) {\r\n        this.description = opts.description;\r\n        this.vectorStateToActions = opts.vectorStateToActions;\r\n        this.syncedRuleIds = opts.syncedRuleIds;\r\n    }\r\n\r\n    // Translate the rule actions and its enabled value into vector state\r\n    public ruleToVectorState(rule: IAnnotatedPushRule): VectorState | undefined {\r\n        let enabled = false;\r\n        if (rule) {\r\n            enabled = rule.enabled;\r\n        }\r\n\r\n        for (const state of Object.values(PushRuleVectorState.states)) {\r\n            const vectorStateToActions = this.vectorStateToActions[state];\r\n\r\n            if (!vectorStateToActions) {\r\n                // No defined actions means that this vector state expects a disabled (or absent) rule\r\n                if (!enabled) {\r\n                    return state;\r\n                }\r\n            } else {\r\n                // The actions must match to the ones expected by vector state.\r\n                // Use `decodeActions` on both sides to canonicalize things like\r\n                // value: true vs. unspecified for highlight (which defaults to\r\n                // true, making them equivalent).\r\n                if (\r\n                    enabled &&\r\n                    JSON.stringify(NotificationUtils.decodeActions(rule.actions)) ===\r\n                        JSON.stringify(NotificationUtils.decodeActions(vectorStateToActions))\r\n                ) {\r\n                    return state;\r\n                }\r\n            }\r\n        }\r\n\r\n        logger.error(\r\n            `Cannot translate rule actions into Vector rule state. ` +\r\n                `Rule: ${JSON.stringify(rule)}, ` +\r\n                `Expected: ${JSON.stringify(this.vectorStateToActions)}`,\r\n        );\r\n        return undefined;\r\n    }\r\n}\r\nexport type { VectorPushRuleDefinition };\r\n\r\n/**\r\n * The descriptions of rules managed by the Vector UI.\r\n */\r\nexport const VectorPushRulesDefinitions: Record<string, VectorPushRuleDefinition> = {\r\n    // Messages containing user's display name\r\n    \".m.rule.contains_display_name\": new VectorPushRuleDefinition({\r\n        description: _td(\"Messages containing my display name\"), // passed through _t() translation in src/components/views/settings/Notifications.js\r\n        vectorStateToActions: {\r\n            // The actions for each vector state, or null to disable the rule.\r\n            [VectorState.On]: StandardActions.ACTION_NOTIFY,\r\n            [VectorState.Loud]: StandardActions.ACTION_HIGHLIGHT_DEFAULT_SOUND,\r\n            [VectorState.Off]: StandardActions.ACTION_DISABLED,\r\n        },\r\n    }),\r\n\r\n    // Messages containing user's username (localpart/MXID)\r\n    \".m.rule.contains_user_name\": new VectorPushRuleDefinition({\r\n        description: _td(\"Messages containing my username\"), // passed through _t() translation in src/components/views/settings/Notifications.js\r\n        vectorStateToActions: {\r\n            // The actions for each vector state, or null to disable the rule.\r\n            [VectorState.On]: StandardActions.ACTION_NOTIFY,\r\n            [VectorState.Loud]: StandardActions.ACTION_HIGHLIGHT_DEFAULT_SOUND,\r\n            [VectorState.Off]: StandardActions.ACTION_DISABLED,\r\n        },\r\n    }),\r\n\r\n    // Messages containing @room\r\n    \".m.rule.roomnotif\": new VectorPushRuleDefinition({\r\n        description: _td(\"Messages containing @room\"), // passed through _t() translation in src/components/views/settings/Notifications.js\r\n        vectorStateToActions: {\r\n            // The actions for each vector state, or null to disable the rule.\r\n            [VectorState.On]: StandardActions.ACTION_NOTIFY,\r\n            [VectorState.Loud]: StandardActions.ACTION_HIGHLIGHT,\r\n            [VectorState.Off]: StandardActions.ACTION_DISABLED,\r\n        },\r\n    }),\r\n\r\n    // Messages just sent to the user in a 1:1 room\r\n    \".m.rule.room_one_to_one\": new VectorPushRuleDefinition({\r\n        description: _td(\"Messages in one-to-one chats\"), // passed through _t() translation in src/components/views/settings/Notifications.js\r\n        vectorStateToActions: {\r\n            [VectorState.On]: StandardActions.ACTION_NOTIFY,\r\n            [VectorState.Loud]: StandardActions.ACTION_NOTIFY_DEFAULT_SOUND,\r\n            [VectorState.Off]: StandardActions.ACTION_DONT_NOTIFY,\r\n        },\r\n        syncedRuleIds: [\r\n            RuleId.PollStartOneToOne,\r\n            RuleId.PollStartOneToOneUnstable,\r\n            RuleId.PollEndOneToOne,\r\n            RuleId.PollEndOneToOneUnstable,\r\n        ],\r\n    }),\r\n\r\n    // Encrypted messages just sent to the user in a 1:1 room\r\n    \".m.rule.encrypted_room_one_to_one\": new VectorPushRuleDefinition({\r\n        description: _td(\"Encrypted messages in one-to-one chats\"), // passed through _t() translation in src/components/views/settings/Notifications.js\r\n        vectorStateToActions: {\r\n            [VectorState.On]: StandardActions.ACTION_NOTIFY,\r\n            [VectorState.Loud]: StandardActions.ACTION_NOTIFY_DEFAULT_SOUND,\r\n            [VectorState.Off]: StandardActions.ACTION_DONT_NOTIFY,\r\n        },\r\n    }),\r\n\r\n    // Messages just sent to a group chat room\r\n    // 1:1 room messages are caught by the .m.rule.room_one_to_one rule if any defined\r\n    // By opposition, all other room messages are from group chat rooms.\r\n    \".m.rule.message\": new VectorPushRuleDefinition({\r\n        description: _td(\"Messages in group chats\"), // passed through _t() translation in src/components/views/settings/Notifications.js\r\n        vectorStateToActions: {\r\n            [VectorState.On]: StandardActions.ACTION_NOTIFY,\r\n            [VectorState.Loud]: StandardActions.ACTION_NOTIFY_DEFAULT_SOUND,\r\n            [VectorState.Off]: StandardActions.ACTION_DONT_NOTIFY,\r\n        },\r\n        syncedRuleIds: [RuleId.PollStart, RuleId.PollStartUnstable, RuleId.PollEnd, RuleId.PollEndUnstable],\r\n    }),\r\n\r\n    // Encrypted messages just sent to a group chat room\r\n    // Encrypted 1:1 room messages are caught by the .m.rule.encrypted_room_one_to_one rule if any defined\r\n    // By opposition, all other room messages are from group chat rooms.\r\n    \".m.rule.encrypted\": new VectorPushRuleDefinition({\r\n        description: _td(\"Encrypted messages in group chats\"), // passed through _t() translation in src/components/views/settings/Notifications.js\r\n        vectorStateToActions: {\r\n            [VectorState.On]: StandardActions.ACTION_NOTIFY,\r\n            [VectorState.Loud]: StandardActions.ACTION_NOTIFY_DEFAULT_SOUND,\r\n            [VectorState.Off]: StandardActions.ACTION_DONT_NOTIFY,\r\n        },\r\n    }),\r\n\r\n    // Invitation for the user\r\n    \".m.rule.invite_for_me\": new VectorPushRuleDefinition({\r\n        description: _td(\"When I'm invited to a room\"), // passed through _t() translation in src/components/views/settings/Notifications.js\r\n        vectorStateToActions: {\r\n            [VectorState.On]: StandardActions.ACTION_NOTIFY,\r\n            [VectorState.Loud]: StandardActions.ACTION_NOTIFY_DEFAULT_SOUND,\r\n            [VectorState.Off]: StandardActions.ACTION_DISABLED,\r\n        },\r\n    }),\r\n\r\n    // Incoming call\r\n    \".m.rule.call\": new VectorPushRuleDefinition({\r\n        description: _td(\"Call invitation\"), // passed through _t() translation in src/components/views/settings/Notifications.js\r\n        vectorStateToActions: {\r\n            [VectorState.On]: StandardActions.ACTION_NOTIFY,\r\n            [VectorState.Loud]: StandardActions.ACTION_NOTIFY_RING_SOUND,\r\n            [VectorState.Off]: StandardActions.ACTION_DISABLED,\r\n        },\r\n    }),\r\n\r\n    // Notifications from bots\r\n    \".m.rule.suppress_notices\": new VectorPushRuleDefinition({\r\n        description: _td(\"Messages sent by bot\"), // passed through _t() translation in src/components/views/settings/Notifications.js\r\n        vectorStateToActions: {\r\n            // .m.rule.suppress_notices is a \"negative\" rule, we have to invert its enabled value for vector UI\r\n            [VectorState.On]: StandardActions.ACTION_DISABLED,\r\n            [VectorState.Loud]: StandardActions.ACTION_NOTIFY_DEFAULT_SOUND,\r\n            [VectorState.Off]: StandardActions.ACTION_DONT_NOTIFY,\r\n        },\r\n    }),\r\n\r\n    // Room upgrades (tombstones)\r\n    \".m.rule.tombstone\": new VectorPushRuleDefinition({\r\n        description: _td(\"When rooms are upgraded\"), // passed through _t() translation in src/components/views/settings/Notifications.js\r\n        vectorStateToActions: {\r\n            // The actions for each vector state, or null to disable the rule.\r\n            [VectorState.On]: StandardActions.ACTION_NOTIFY,\r\n            [VectorState.Loud]: StandardActions.ACTION_HIGHLIGHT,\r\n            [VectorState.Off]: StandardActions.ACTION_DISABLED,\r\n        },\r\n    }),\r\n};\r\n"],"mappings":"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"}