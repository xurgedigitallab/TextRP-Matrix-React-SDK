{"version":3,"file":"compat.js","names":["_decoderWorkerMin","_interopRequireDefault","require","_waveWorkerMin","_decoderWorkerMin2","_logger","_VoiceRecording","createAudioContext","opts","window","AudioContext","webkitAudioContext","Error","decodeOgg","audioBuffer","Promise","resolve","logger","log","decoderWasmPath","typedArray","Uint8Array","decoderWorker","Worker","decoderPath","wavWorker","wavEncoderPath","postMessage","command","decoderSampleRate","SAMPLE_RATE","outputBufferSampleRate","wavBitDepth","wavSampleRate","onmessage","ev","data","buffers","map","b","buffer","message","Blob","page","type","arrayBuffer","pages"],"sources":["../../src/audio/compat.ts"],"sourcesContent":["/*\r\nCopyright 2021 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\n// @ts-ignore - we know that this is not a module. We're looking for a path.\r\nimport decoderWasmPath from \"opus-recorder/dist/decoderWorker.min.wasm\";\r\nimport wavEncoderPath from \"opus-recorder/dist/waveWorker.min.js\";\r\nimport decoderPath from \"opus-recorder/dist/decoderWorker.min.js\";\r\nimport { logger } from \"matrix-js-sdk/src/logger\";\r\n\r\nimport { SAMPLE_RATE } from \"./VoiceRecording\";\r\n\r\nexport function createAudioContext(opts?: AudioContextOptions): AudioContext {\r\n    if (window.AudioContext) {\r\n        return new AudioContext(opts);\r\n    } else if (window.webkitAudioContext) {\r\n        // While the linter is correct that \"a constructor name should not start with\r\n        // a lowercase letter\", it's also wrong to think that we have control over this.\r\n        // eslint-disable-next-line new-cap\r\n        return new window.webkitAudioContext(opts);\r\n    } else {\r\n        throw new Error(\"Unsupported browser\");\r\n    }\r\n}\r\n\r\nexport function decodeOgg(audioBuffer: ArrayBuffer): Promise<ArrayBuffer> {\r\n    // Condensed version of decoder example, using a promise:\r\n    // https://github.com/chris-rudmin/opus-recorder/blob/master/example/decoder.html\r\n    return new Promise((resolve) => {\r\n        // no reject because the workers don't seem to have a fail path\r\n        logger.log(\"Decoder WASM path: \" + decoderWasmPath); // so we use the variable (avoid tree shake)\r\n        const typedArray = new Uint8Array(audioBuffer);\r\n        const decoderWorker = new Worker(decoderPath);\r\n        const wavWorker = new Worker(wavEncoderPath);\r\n\r\n        decoderWorker.postMessage({\r\n            command: \"init\",\r\n            decoderSampleRate: SAMPLE_RATE,\r\n            outputBufferSampleRate: SAMPLE_RATE,\r\n        });\r\n\r\n        wavWorker.postMessage({\r\n            command: \"init\",\r\n            wavBitDepth: 24, // standard for 48khz (SAMPLE_RATE)\r\n            wavSampleRate: SAMPLE_RATE,\r\n        });\r\n\r\n        decoderWorker.onmessage = (ev) => {\r\n            if (ev.data === null) {\r\n                // null == done\r\n                wavWorker.postMessage({ command: \"done\" });\r\n                return;\r\n            }\r\n\r\n            wavWorker.postMessage(\r\n                {\r\n                    command: \"encode\",\r\n                    buffers: ev.data,\r\n                },\r\n                ev.data.map((b: Float32Array) => b.buffer),\r\n            );\r\n        };\r\n\r\n        wavWorker.onmessage = (ev) => {\r\n            if (ev.data.message === \"page\") {\r\n                // The encoding comes through as a single page\r\n                resolve(new Blob([ev.data.page], { type: \"audio/wav\" }).arrayBuffer());\r\n            }\r\n        };\r\n\r\n        decoderWorker.postMessage(\r\n            {\r\n                command: \"decode\",\r\n                pages: typedArray,\r\n            },\r\n            [typedArray.buffer],\r\n        );\r\n    });\r\n}\r\n"],"mappings":";;;;;;;;AAiBA,IAAAA,iBAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,cAAA,GAAAF,sBAAA,CAAAC,OAAA;AACA,IAAAE,kBAAA,GAAAH,sBAAA,CAAAC,OAAA;AACA,IAAAG,OAAA,GAAAH,OAAA;AAEA,IAAAI,eAAA,GAAAJ,OAAA;AAtBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAQO,SAASK,kBAAkBA,CAACC,IAA0B,EAAgB;EACzE,IAAIC,MAAM,CAACC,YAAY,EAAE;IACrB,OAAO,IAAIA,YAAY,CAACF,IAAI,CAAC;EACjC,CAAC,MAAM,IAAIC,MAAM,CAACE,kBAAkB,EAAE;IAClC;IACA;IACA;IACA,OAAO,IAAIF,MAAM,CAACE,kBAAkB,CAACH,IAAI,CAAC;EAC9C,CAAC,MAAM;IACH,MAAM,IAAII,KAAK,CAAC,qBAAqB,CAAC;EAC1C;AACJ;AAEO,SAASC,SAASA,CAACC,WAAwB,EAAwB;EACtE;EACA;EACA,OAAO,IAAIC,OAAO,CAAEC,OAAO,IAAK;IAC5B;IACAC,cAAM,CAACC,GAAG,CAAC,qBAAqB,GAAGC,yBAAe,CAAC,CAAC,CAAC;IACrD,MAAMC,UAAU,GAAG,IAAIC,UAAU,CAACP,WAAW,CAAC;IAC9C,MAAMQ,aAAa,GAAG,IAAIC,MAAM,CAACC,0BAAW,CAAC;IAC7C,MAAMC,SAAS,GAAG,IAAIF,MAAM,CAACG,sBAAc,CAAC;IAE5CJ,aAAa,CAACK,WAAW,CAAC;MACtBC,OAAO,EAAE,MAAM;MACfC,iBAAiB,EAAEC,2BAAW;MAC9BC,sBAAsB,EAAED;IAC5B,CAAC,CAAC;IAEFL,SAAS,CAACE,WAAW,CAAC;MAClBC,OAAO,EAAE,MAAM;MACfI,WAAW,EAAE,EAAE;MAAE;MACjBC,aAAa,EAAEH;IACnB,CAAC,CAAC;IAEFR,aAAa,CAACY,SAAS,GAAIC,EAAE,IAAK;MAC9B,IAAIA,EAAE,CAACC,IAAI,KAAK,IAAI,EAAE;QAClB;QACAX,SAAS,CAACE,WAAW,CAAC;UAAEC,OAAO,EAAE;QAAO,CAAC,CAAC;QAC1C;MACJ;MAEAH,SAAS,CAACE,WAAW,CACjB;QACIC,OAAO,EAAE,QAAQ;QACjBS,OAAO,EAAEF,EAAE,CAACC;MAChB,CAAC,EACDD,EAAE,CAACC,IAAI,CAACE,GAAG,CAAEC,CAAe,IAAKA,CAAC,CAACC,MAAM,CAC7C,CAAC;IACL,CAAC;IAEDf,SAAS,CAACS,SAAS,GAAIC,EAAE,IAAK;MAC1B,IAAIA,EAAE,CAACC,IAAI,CAACK,OAAO,KAAK,MAAM,EAAE;QAC5B;QACAzB,OAAO,CAAC,IAAI0B,IAAI,CAAC,CAACP,EAAE,CAACC,IAAI,CAACO,IAAI,CAAC,EAAE;UAAEC,IAAI,EAAE;QAAY,CAAC,CAAC,CAACC,WAAW,CAAC,CAAC,CAAC;MAC1E;IACJ,CAAC;IAEDvB,aAAa,CAACK,WAAW,CACrB;MACIC,OAAO,EAAE,QAAQ;MACjBkB,KAAK,EAAE1B;IACX,CAAC,EACD,CAACA,UAAU,CAACoB,MAAM,CACtB,CAAC;EACL,CAAC,CAAC;AACN"}