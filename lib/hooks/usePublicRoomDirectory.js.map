{"version":3,"file":"usePublicRoomDirectory.js","names":["_react","require","_MatrixClientPeg","_SdkConfig","_interopRequireDefault","_SettingsStore","_useLatestResult","_useSettings","ALL_ROOMS","exports","LAST_SERVER_KEY","LAST_INSTANCE_KEY","thirdParty","NSFW_KEYWORD","cheapNsfwFilter","room","name","toLocaleLowerCase","includes","topic","usePublicRoomDirectory","publicRooms","setPublicRooms","useState","config","setConfigInternal","undefined","protocols","setProtocols","ready","setReady","loading","setLoading","updateQuery","updateResult","useLatestResult","showNsfwPublicRooms","useSettingValue","initProtocols","MatrixClientPeg","get","response","getThirdpartyProtocols","setConfig","Error","search","useCallback","_ref","limit","query","roomTypes","opts","roomServer","getHomeserverName","server","instanceId","include_all_networks","third_party_instance_id","filter","generic_search_term","room_types","doesServerSupportUnstableFeature","Array","from","chunk","e","console","error","useEffect","myHomeserver","lsRoomServer","localStorage","getItem","lsInstanceId","SdkConfig","getObject","SettingsStore","getValue","Object","values","some","p","instances","i","instance_id","setItem","removeItem"],"sources":["../../src/hooks/usePublicRoomDirectory.ts"],"sourcesContent":["/*\r\nCopyright 2022 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { RoomType } from \"matrix-js-sdk/src/@types/event\";\r\nimport { IRoomDirectoryOptions } from \"matrix-js-sdk/src/@types/requests\";\r\nimport { IProtocol, IPublicRoomsChunkRoom } from \"matrix-js-sdk/src/client\";\r\nimport { useCallback, useEffect, useState } from \"react\";\r\n\r\nimport { IPublicRoomDirectoryConfig } from \"../components/views/directory/NetworkDropdown\";\r\nimport { MatrixClientPeg } from \"../MatrixClientPeg\";\r\nimport SdkConfig from \"../SdkConfig\";\r\nimport SettingsStore from \"../settings/SettingsStore\";\r\nimport { Protocols } from \"../utils/DirectoryUtils\";\r\nimport { useLatestResult } from \"./useLatestResult\";\r\nimport { useSettingValue } from \"./useSettings\";\r\n\r\nexport const ALL_ROOMS = \"ALL_ROOMS\";\r\nconst LAST_SERVER_KEY = \"mx_last_room_directory_server\";\r\nconst LAST_INSTANCE_KEY = \"mx_last_room_directory_instance\";\r\n\r\nexport interface IPublicRoomsOpts {\r\n    limit: number;\r\n    query?: string;\r\n    roomTypes?: Set<RoomType | null>;\r\n}\r\n\r\nlet thirdParty: Protocols;\r\n\r\nconst NSFW_KEYWORD = \"nsfw\";\r\nconst cheapNsfwFilter = (room: IPublicRoomsChunkRoom): boolean =>\r\n    !room.name?.toLocaleLowerCase().includes(NSFW_KEYWORD) && !room.topic?.toLocaleLowerCase().includes(NSFW_KEYWORD);\r\n\r\nexport const usePublicRoomDirectory = (): {\r\n    ready: boolean;\r\n    loading: boolean;\r\n    publicRooms: IPublicRoomsChunkRoom[];\r\n    protocols: Protocols | null;\r\n    config?: IPublicRoomDirectoryConfig | null;\r\n    setConfig(config: IPublicRoomDirectoryConfig | null): void;\r\n    search(opts: IPublicRoomsOpts): Promise<boolean>;\r\n} => {\r\n    const [publicRooms, setPublicRooms] = useState<IPublicRoomsChunkRoom[]>([]);\r\n\r\n    const [config, setConfigInternal] = useState<IPublicRoomDirectoryConfig | null | undefined>(undefined);\r\n\r\n    const [protocols, setProtocols] = useState<Protocols | null>(null);\r\n\r\n    const [ready, setReady] = useState(false);\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    const [updateQuery, updateResult] = useLatestResult<IRoomDirectoryOptions, IPublicRoomsChunkRoom[]>(setPublicRooms);\r\n\r\n    const showNsfwPublicRooms = useSettingValue<boolean>(\"SpotlightSearch.showNsfwPublicRooms\");\r\n\r\n    async function initProtocols(): Promise<void> {\r\n        if (!MatrixClientPeg.get()) {\r\n            // We may not have a client yet when invoked from welcome page\r\n            setReady(true);\r\n        } else if (thirdParty) {\r\n            setProtocols(thirdParty);\r\n        } else {\r\n            const response = await MatrixClientPeg.get().getThirdpartyProtocols();\r\n            thirdParty = response;\r\n            setProtocols(response);\r\n        }\r\n    }\r\n\r\n    function setConfig(config: IPublicRoomDirectoryConfig): void {\r\n        if (!ready) {\r\n            throw new Error(\"public room configuration not initialised yet\");\r\n        } else {\r\n            setConfigInternal(config);\r\n        }\r\n    }\r\n\r\n    const search = useCallback(\r\n        async ({ limit = 20, query, roomTypes }: IPublicRoomsOpts): Promise<boolean> => {\r\n            const opts: IRoomDirectoryOptions = { limit };\r\n\r\n            if (config?.roomServer != MatrixClientPeg.getHomeserverName()) {\r\n                opts.server = config?.roomServer;\r\n            }\r\n\r\n            if (config?.instanceId === ALL_ROOMS) {\r\n                opts.include_all_networks = true;\r\n            } else if (config?.instanceId) {\r\n                opts.third_party_instance_id = config.instanceId;\r\n            }\r\n\r\n            if (query || roomTypes) {\r\n                opts.filter = {\r\n                    generic_search_term: query,\r\n                    room_types:\r\n                        roomTypes &&\r\n                        (await MatrixClientPeg.get().doesServerSupportUnstableFeature(\"org.matrix.msc3827.stable\"))\r\n                            ? Array.from<RoomType | null>(roomTypes)\r\n                            : undefined,\r\n                };\r\n            }\r\n\r\n            updateQuery(opts);\r\n            try {\r\n                setLoading(true);\r\n                const { chunk } = await MatrixClientPeg.get().publicRooms(opts);\r\n                updateResult(opts, showNsfwPublicRooms ? chunk : chunk.filter(cheapNsfwFilter));\r\n                return true;\r\n            } catch (e) {\r\n                console.error(\"Could not fetch public rooms for params\", opts, e);\r\n                updateResult(opts, []);\r\n                return false;\r\n            } finally {\r\n                setLoading(false);\r\n            }\r\n        },\r\n        [config, updateQuery, updateResult, showNsfwPublicRooms],\r\n    );\r\n\r\n    useEffect(() => {\r\n        initProtocols();\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        if (protocols === null) {\r\n            return;\r\n        }\r\n\r\n        const myHomeserver = MatrixClientPeg.getHomeserverName();\r\n        const lsRoomServer = localStorage.getItem(LAST_SERVER_KEY);\r\n        const lsInstanceId: string | undefined = localStorage.getItem(LAST_INSTANCE_KEY) ?? undefined;\r\n\r\n        let roomServer: string = myHomeserver;\r\n        if (\r\n            lsRoomServer &&\r\n            (SdkConfig.getObject(\"room_directory\")?.get(\"servers\")?.includes(lsRoomServer) ||\r\n                SettingsStore.getValue(\"room_directory_servers\")?.includes(lsRoomServer))\r\n        ) {\r\n            roomServer = lsRoomServer!;\r\n        }\r\n\r\n        let instanceId: string | undefined = undefined;\r\n        if (\r\n            roomServer === myHomeserver &&\r\n            (lsInstanceId === ALL_ROOMS ||\r\n                Object.values(protocols).some((p: IProtocol) => {\r\n                    p.instances.some((i) => i.instance_id === lsInstanceId);\r\n                }))\r\n        ) {\r\n            instanceId = lsInstanceId;\r\n        }\r\n\r\n        setReady(true);\r\n        setConfigInternal({ roomServer, instanceId });\r\n    }, [protocols]);\r\n\r\n    useEffect(() => {\r\n        if (!config) return;\r\n        localStorage.setItem(LAST_SERVER_KEY, config.roomServer);\r\n        if (config.instanceId) {\r\n            localStorage.setItem(LAST_INSTANCE_KEY, config.instanceId);\r\n        } else {\r\n            localStorage.removeItem(LAST_INSTANCE_KEY);\r\n        }\r\n    }, [config]);\r\n\r\n    return {\r\n        ready,\r\n        loading,\r\n        publicRooms,\r\n        protocols,\r\n        config,\r\n        search,\r\n        setConfig,\r\n    } as const;\r\n};\r\n"],"mappings":"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"}