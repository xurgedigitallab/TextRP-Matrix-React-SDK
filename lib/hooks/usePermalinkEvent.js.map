{"version":3,"file":"usePermalinkEvent.js","names":["_matrix","require","_react","_Pill","_MatrixClientPeg","determineInitialEvent","shouldLookUpEvent","targetRoom","parseResult","eventId","findEventById","usePermalinkEvent","type","roomIdOrAlias","PillType","EventInSameRoom","EventInOtherRoom","includes","eventInRoom","event","setEvent","useState","useEffect","fetchRoomEvent","eventData","MatrixClientPeg","get","MatrixEvent","exports"],"sources":["../../src/hooks/usePermalinkEvent.ts"],"sourcesContent":["/*\r\nCopyright 2023 The Matrix.org Foundation C.I.C.\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\r\nimport { MatrixEvent, Room } from \"matrix-js-sdk/src/matrix\";\r\nimport { useEffect, useState } from \"react\";\r\n\r\nimport { PillType } from \"../components/views/elements/Pill\";\r\nimport { MatrixClientPeg } from \"../MatrixClientPeg\";\r\nimport { PermalinkParts } from \"../utils/permalinks/PermalinkConstructor\";\r\n\r\n/**\r\n * Tries to find the initial event.\r\n * If the event should not be looked up or there is no target room it returns null.\r\n * Otherwise it tries to get the event from the target room.\r\n *\r\n * @param shouldLookUpEvent - whether the parmalink event should be looked up\r\n * @param Room | null targetRoom - target room of the permalink\r\n * @param parseResult - permalink parse result\r\n * @returns The event if found or null if it should not be looked up or was not found.\r\n */\r\nconst determineInitialEvent = (\r\n    shouldLookUpEvent: boolean,\r\n    targetRoom: Room | null,\r\n    parseResult: PermalinkParts | null,\r\n): MatrixEvent | null => {\r\n    if (!shouldLookUpEvent || !targetRoom || !parseResult?.eventId) return null;\r\n\r\n    return targetRoom.findEventById(parseResult.eventId) || null;\r\n};\r\n\r\n/**\r\n * Hook to get a permalink target event\r\n *\r\n * @param type - Permalink type\r\n * @param parseResult - Permalink parse result\r\n * @param targetRoom - Target room of the permalink {@link ./usePermalinkTargetRoom.ts}\r\n * @returns The permalink event if it targets an event and it can be loaded.\r\n *          Else null.\r\n */\r\nexport const usePermalinkEvent = (\r\n    type: PillType | null,\r\n    parseResult: PermalinkParts | null,\r\n    targetRoom: Room | null,\r\n): MatrixEvent | null => {\r\n    // Event permalinks require to know the event.\r\n    // If it cannot be initially determined, it will be looked up later by a memo hook.\r\n    const shouldLookUpEvent =\r\n        !!type &&\r\n        !!parseResult?.roomIdOrAlias &&\r\n        !!parseResult?.eventId &&\r\n        [PillType.EventInSameRoom, PillType.EventInOtherRoom].includes(type);\r\n    const eventId = parseResult?.eventId;\r\n    const eventInRoom = determineInitialEvent(shouldLookUpEvent, targetRoom, parseResult);\r\n    const [event, setEvent] = useState<MatrixEvent | null>(eventInRoom);\r\n\r\n    useEffect(() => {\r\n        if (!shouldLookUpEvent || !eventId || event || !parseResult?.roomIdOrAlias || !parseResult.eventId) {\r\n            // nothing to do here\r\n            return;\r\n        }\r\n\r\n        const fetchRoomEvent = async (): Promise<void> => {\r\n            try {\r\n                const eventData = await MatrixClientPeg.get().fetchRoomEvent(\r\n                    parseResult.roomIdOrAlias!,\r\n                    parseResult.eventId!,\r\n                );\r\n                setEvent(new MatrixEvent(eventData));\r\n            } catch {}\r\n        };\r\n\r\n        fetchRoomEvent();\r\n    }, [event, eventId, parseResult?.eventId, parseResult?.roomIdOrAlias, shouldLookUpEvent]);\r\n\r\n    return event;\r\n};\r\n"],"mappings":";;;;;;AAgBA,IAAAA,OAAA,GAAAC,OAAA;AACA,IAAAC,MAAA,GAAAD,OAAA;AAEA,IAAAE,KAAA,GAAAF,OAAA;AACA,IAAAG,gBAAA,GAAAH,OAAA;AApBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AASA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAMI,qBAAqB,GAAGA,CAC1BC,iBAA0B,EAC1BC,UAAuB,EACvBC,WAAkC,KACb;EACrB,IAAI,CAACF,iBAAiB,IAAI,CAACC,UAAU,IAAI,CAACC,WAAW,EAAEC,OAAO,EAAE,OAAO,IAAI;EAE3E,OAAOF,UAAU,CAACG,aAAa,CAACF,WAAW,CAACC,OAAO,CAAC,IAAI,IAAI;AAChE,CAAC;;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAME,iBAAiB,GAAGA,CAC7BC,IAAqB,EACrBJ,WAAkC,EAClCD,UAAuB,KACF;EACrB;EACA;EACA,MAAMD,iBAAiB,GACnB,CAAC,CAACM,IAAI,IACN,CAAC,CAACJ,WAAW,EAAEK,aAAa,IAC5B,CAAC,CAACL,WAAW,EAAEC,OAAO,IACtB,CAACK,cAAQ,CAACC,eAAe,EAAED,cAAQ,CAACE,gBAAgB,CAAC,CAACC,QAAQ,CAACL,IAAI,CAAC;EACxE,MAAMH,OAAO,GAAGD,WAAW,EAAEC,OAAO;EACpC,MAAMS,WAAW,GAAGb,qBAAqB,CAACC,iBAAiB,EAAEC,UAAU,EAAEC,WAAW,CAAC;EACrF,MAAM,CAACW,KAAK,EAAEC,QAAQ,CAAC,GAAG,IAAAC,eAAQ,EAAqBH,WAAW,CAAC;EAEnE,IAAAI,gBAAS,EAAC,MAAM;IACZ,IAAI,CAAChB,iBAAiB,IAAI,CAACG,OAAO,IAAIU,KAAK,IAAI,CAACX,WAAW,EAAEK,aAAa,IAAI,CAACL,WAAW,CAACC,OAAO,EAAE;MAChG;MACA;IACJ;IAEA,MAAMc,cAAc,GAAG,MAAAA,CAAA,KAA2B;MAC9C,IAAI;QACA,MAAMC,SAAS,GAAG,MAAMC,gCAAe,CAACC,GAAG,CAAC,CAAC,CAACH,cAAc,CACxDf,WAAW,CAACK,aAAa,EACzBL,WAAW,CAACC,OAChB,CAAC;QACDW,QAAQ,CAAC,IAAIO,mBAAW,CAACH,SAAS,CAAC,CAAC;MACxC,CAAC,CAAC,MAAM,CAAC;IACb,CAAC;IAEDD,cAAc,CAAC,CAAC;EACpB,CAAC,EAAE,CAACJ,KAAK,EAAEV,OAAO,EAAED,WAAW,EAAEC,OAAO,EAAED,WAAW,EAAEK,aAAa,EAAEP,iBAAiB,CAAC,CAAC;EAEzF,OAAOa,KAAK;AAChB,CAAC;AAACS,OAAA,CAAAjB,iBAAA,GAAAA,iBAAA"}